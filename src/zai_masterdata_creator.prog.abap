*&---------------------------------------------------------------------*
*& Include          ZAI_MASTERDATA_CREATOR
*&---------------------------------------------------------------------*


CLASS: LCL_VFILE_CREATOR DEFINITION DEFERRED,
       LCL_SCREEN_1000 DEFINITION DEFERRED,
       LCL_COPY_DIRECTLY DEFINITION DEFERRED,
       LCL_BY_RULE DEFINITION DEFERRED,
       LCL_USER_INPUT DEFINITION DEFERRED,
       LCL_SUGGEST_BY_AI DEFINITION DEFERRED,
       LCL_RULE DEFINITION DEFERRED.


CLASS LCL_UTILITY DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS:SHUFFLE_TABLE IMPORTING I_ROWS_TO_RETURN TYPE I DEFAULT 10
                                          IT_TABLE         TYPE STANDARD TABLE
                                RETURNING VALUE(RT_TABLE)  TYPE REF TO DATA.

    CLASS-DATA: GO_RANDOM TYPE REF TO CL_ABAP_RANDOM,
                GV_SEED   TYPE I.

ENDCLASS.

CLASS LCL_SETTING DEFINITION.
  PUBLIC SECTION.
    TYPES: BEGIN OF TYP_SETTING,
             SETTING_ID    TYPE STRING,
             SETTING_VALUE TYPE STRING,
           END OF TYP_SETTING,
           TBL_SETTING TYPE STANDARD TABLE OF TYP_SETTING WITH DEFAULT KEY.

    CLASS-METHODS: CLASS_CONSTRUCTOR,
      READ_SETTING,
      SAVE_SETTING,
      MODIFY_SETTING IMPORTING I_SETTING_ID TYPE STRING I_SETTING_VALUE TYPE STRING.

    CLASS-DATA: MT_SETTING TYPE TBL_SETTING.
  PROTECTED SECTION.
    CLASS-DATA: MS_INDX TYPE INDX.

ENDCLASS.

CLASS LCL_TYPE_DEFINE DEFINITION.
  PUBLIC SECTION.
    TYPES: RNG_SCOPE TYPE RANGE OF /SMB/SOLUTION_ID,
           RNG_LAND1 TYPE RANGE OF LAND1,
           RNG_BBID  TYPE RANGE OF /SMB/BBID,
           RNG_PRJID TYPE RANGE OF /SMB/PRJID,
           RNG_SIRID TYPE RANGE OF /SMB/DE_SIR_SI_ID,

           BEGIN OF ENUM OPERTION_TYPE,
             COPY_DIRECTLY,
             BY_RULE,
             USER_INPUT,
             SUGGEST_BY_AI,
           END OF ENUM OPERTION_TYPE,
           BEGIN OF TYP_OPTION_FIELDS,
             OPTION         TYPE OPERTION_TYPE,
             ECATT          TYPE ETOBJ_NAME,
             FIELDNAME      TYPE STRING,
             DESCRIPTION    TYPE STRING,
             REFERENCE      TYPE STRING,
             RELAT_NODE_KEY TYPE LVC_NKEY,
             NODE_KEY       TYPE LVC_NKEY,
           END OF TYP_OPTION_FIELDS,
           TBL_OPTION_FIELDS TYPE STANDARD TABLE OF TYP_OPTION_FIELDS WITH DEFAULT KEY,

           BEGIN OF TYP_TDC_DEFINE,
             PARAM_NAME     TYPE ETP_NAME,
             TDC_NAME       TYPE ETOBJ_NAME,
             FILENAME       TYPE ETVAR_EXT_FILE,
             TITLE          TYPE ET_TITLE,
             EXT_MODE       TYPE ETVAR_EXT_MODE,
             ALIAS          TYPE ETTD_ALIAS,
             TDC_PARAM_NAME TYPE ETP_NAME,
           END OF TYP_TDC_DEFINE,
           TBL_TDC_DEFINE TYPE STANDARD TABLE OF TYP_TDC_DEFINE WITH DEFAULT KEY,

           BEGIN OF TYP_P4_FILE,
             P4_INSTANCE      TYPE REF TO /SMB/IF_P4_INTEGRATION,
             P4_FILE_METADATA TYPE /SMB/S_P4_FILE_METADATA,
             PME              TYPE /SMB/SBA1_I_FILE_TS,
             BBID             TYPE /SMB/BBID,
             LAND1            TYPE LAND1,
             FILENAME         TYPE /SMB/BB_LIB_I-FILENAME,
             INCLUDE          TYPE /CFG/V_FILE_SOL_VIEW,
           END OF TYP_P4_FILE,
           TBL_P4_FILE TYPE STANDARD TABLE OF TYP_P4_FILE WITH DEFAULT KEY,
           BEGIN OF TYP_FIELDS_EXP,
             PNAME          TYPE  ETP_NAME,
             PTYP           TYPE  ETP_TYP,
             PDESC          TYPE  ETP_DESC,

             PINDEX         TYPE  ETPINDEX,
             PGROUP         TYPE  ET_PGROUP,
             XMLREF_TYP     TYPE  ETREF_TYP,
             PSTRUC_TYP     TYPE  ETPSTRUC,
             PENV           TYPE  ETENVGL,
             PREF_TYPE      TYPE  ETTABCLASS,
             PREF_NAME      TYPE  ETDDONAME,
             PDOM           TYPE  DOMNAME,
             PDATTYP        TYPE  DATATYPE_D,
             PDATLEN        TYPE  ETDDLEN,
             PINTTYP        TYPE  ETINTTYPE,
             PINTLEN        TYPE  INTLEN,
             PDECIMALS      TYPE  DECIMALS,
             OPTIONAL       TYPE  ETOPTIONAL,
             SORT_LNR       TYPE  ETSORT_LNR,
             TESTSYSTEM     TYPE  ETCMP_CMP,
             PREF_NAME2     TYPE  ETDDONAME2,
             ALIAS_FLAG     TYPE  ETPALIAS,

             VALUE          TYPE  ETVAL,
             VAL_TYPE       TYPE  ETVAL_TYPE,
             TAB_INDEX      TYPE  SYTABIX,
             DEF_EXT        TYPE  ETDEF_EXT,
             VALUE_RUNTIME  TYPE  ETVAL_C,

             SUGGEST_VALUES TYPE STRING_TABLE,
           END OF TYP_FIELDS_EXP,
           TBL_FIELDS_EXP TYPE STANDARD TABLE OF TYP_FIELDS_EXP,

           BEGIN OF TYP_PARTNER,
             PARTNER TYPE BU_PARTNER,
             EXIST   TYPE ABAP_BOOLEAN,
           END OF TYP_PARTNER,

           TBL_PARTNER TYPE STANDARD TABLE OF TYP_PARTNER,

           BEGIN OF TYP_MATERIAL,
             MATNR TYPE MARA-MATNR,
             EXIST TYPE ABAP_BOOLEAN,
           END OF TYP_MATERIAL,

           TBL_MATERIAL TYPE STANDARD TABLE OF TYP_MATERIAL,

           BEGIN OF TYP_FIELDS,
             FIELD_NAME TYPE ETP_NAME,
           END OF TYP_FIELDS,
           TBL_FIELDS TYPE TABLE OF TYP_FIELDS,
           BEGIN OF TYP_ECATT_DEFINES,
             ECATT               TYPE ETOBJ_NAME,
             REF_ECATT           TYPE ETOBJ_NAME,

             CLASS               TYPE SEOCLSNAME,
             ECATT_API           TYPE REF TO /SMB/SBA1_CL_ECATT_DEF, "TYPE REF TO /SMB/SBA1_CL_ECATT_DEF
             PARAMS              TYPE /SMB/SB_I_004, "TYPE ETPAR_GUI_TABTYPE,
             P4_FILE             TYPE TBL_P4_FILE,
             P4_INSTANCE         TYPE REF TO /SMB/IF_P4_INTEGRATION,
             TDC_DEFINE          TYPE TBL_TDC_DEFINE,
             FIELDCATALOG        TYPE LVC_T_FCAT,
             NODE_KEY            TYPE LVC_NKEY,

             VARIANT_CONTENT     TYPE REF TO DATA,
             VARIANT_CONTENT_NEW TYPE REF TO DATA,
             VARIANT_TABLEDESCR  TYPE REF TO CL_ABAP_TABLEDESCR,
             VARIANT_STRUCTDESCR TYPE REF TO CL_ABAP_STRUCTDESCR,

             ROW_NO              TYPE LVC_T_ROID,
             SRCCOUNTRY          TYPE TRGY_LAND1,
             TARCOUNTRY          TYPE LAND1,
             NUMCREATE           TYPE I,
             FORMAT              TYPE ABAP_BOOL,
             RNG_SIR_SI_ID       TYPE RNG_SIRID,
             AI_ANSWER           TYPE STRING,
             SYSTEM_ROLE         TYPE STRING,
             " OPTION_FIELDS       TYPE TBL_OPTION_FIELDS,
             TBLCOL              TYPE LVC_T_SCOL,
             SUGGEST_FILENAME    TYPE STRING,
           END OF TYP_ECATT_DEFINES,
           TBL_ECATT_DEFINES TYPE TABLE OF TYP_ECATT_DEFINES.
ENDCLASS.

CLASS LCL_BANK_KEY_LOADER DEFINITION.
  PUBLIC SECTION.
    CONSTANTS: GC_BANKKEY_ECATT TYPE STRING VALUE '/SMBA0/BANK_CREATE_O001_J16'.

    METHODS: CONSTRUCTOR IMPORTING  IO_P4_INSTANCE TYPE REF TO /SMB/IF_P4_INTEGRATION,
      GET_BANK_KEY_LIST IMPORTING ING_SIR_SI_ID  TYPE LCL_TYPE_DEFINE=>RNG_SIRID
                                  ING_SCOPE      TYPE LCL_TYPE_DEFINE=>RNG_SCOPE
                                  ING_LAND1      TYPE LCL_TYPE_DEFINE=>RNG_LAND1
*                                  ING_PRJID      TYPE LCL_TYPE_DEFINE=>RNG_PRJID
*                                  ING_BBID       TYPE LCL_TYPE_DEFINE=>RNG_BBID
                        RETURNING VALUE(RT_BNKA) TYPE BF_BNKA.
  PRIVATE SECTION.
    DATA: MO_P4_INSTANCE TYPE REF TO /SMB/IF_P4_INTEGRATION.
ENDCLASS.

CLASS LCL_RULE_PROCESS DEFINITION.
  PUBLIC SECTION.

    CLASS-METHODS: CLASS_CONSTRUCTOR,
      INIT_RULE,
      REGISTER_INSTANCE IMPORTING LO_RULE TYPE REF TO LCL_RULE,
      ADD_FIELD IMPORTING I_OPERTION_TYPE TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE
                          IS_FIELD        TYPE /SMB/SB_S_007,
      GET_DATA_TABLE IMPORTING I_OPERTION_TYPE      TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE
                     RETURNING VALUE(RO_DATA_TABLE) TYPE REF TO DATA,
      GET_EXPLAIN_TABLE IMPORTING I_OPERTION_TYPE   TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE
                        CHANGING  CT_FIELD_EXPLAINS TYPE LCL_TYPE_DEFINE=>TBL_FIELDS_EXP,
      FILL_CONTENT_TABLE IMPORTING I_OPERTION_TYPE TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE
                                   I_FIELDNAME     TYPE STRING
                                   IS_CONTENT      TYPE REF TO DATA,
      PROCESS_RULE CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES.

    CLASS-DATA:           MT_INSTANCES TYPE TABLE OF REF TO LCL_RULE.

  PRIVATE SECTION.

ENDCLASS.

CLASS LCL_RULE DEFINITION ABSTRACT.
  PUBLIC SECTION.

    METHODS: CONSTRUCTOR,
      BEFORE_PROCESS ABSTRACT CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      PROCESS ABSTRACT CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      AFTER_PROCESS ABSTRACT CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,

      INIT_RULE,
      ADD_FIELD IMPORTING IS_FIELD TYPE /SMB/SB_S_007,
      GET_DATA_TABLE RETURNING VALUE(RO_DATA_TABLE) TYPE REF TO DATA,
      GET_EXPLAIN_TABLE CHANGING CT_FIELD_EXPLAINS  TYPE LCL_TYPE_DEFINE=>TBL_FIELDS_EXP,
      FILL_CONTENT_TABLE IMPORTING I_FIELDNAME TYPE STRING
                                   I_VALUE     TYPE REF TO DATA,
      GET_COUNTRY_TABLE IMPORTING IS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES
                        EXPORTING ET_SRC_LAND1     TYPE TRGY_LAND1
                                  ET_TAR_LAND1     TYPE TRGY_LAND1.

    DATA: MT_FIELDS          TYPE /SMB/SB_I_004,
          MT_COMP_TAB        TYPE CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
          MO_DATA_TABLE      TYPE REF TO DATA,
          MS_DATA_LINE       TYPE REF TO DATA,
          M_MY_OPERTION_TYPE TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE.

ENDCLASS.

CLASS LCL_COPY_DIRECTLY DEFINITION INHERITING FROM LCL_RULE.
  PUBLIC SECTION.
    METHODS:
      BEFORE_PROCESS REDEFINITION,
      PROCESS REDEFINITION,
      AFTER_PROCESS REDEFINITION,

      CONSTRUCTOR.
ENDCLASS.

CLASS LCL_BY_RULE DEFINITION  INHERITING FROM LCL_RULE.
  PUBLIC SECTION.
    METHODS:
      BEFORE_PROCESS REDEFINITION,
      PROCESS REDEFINITION,
      AFTER_PROCESS REDEFINITION,

      CONSTRUCTOR.


ENDCLASS.

CLASS LCL_USER_INPUT DEFINITION  INHERITING FROM LCL_RULE.

  PUBLIC SECTION.
    METHODS:
      BEFORE_PROCESS REDEFINITION,
      PROCESS REDEFINITION,
      AFTER_PROCESS REDEFINITION,

      CONSTRUCTOR.

ENDCLASS.

CLASS LCL_SUGGEST_BY_AI DEFINITION  INHERITING FROM LCL_RULE.
  PUBLIC SECTION.
    METHODS:
      INIT_RULE REDEFINITION,
      BEFORE_PROCESS REDEFINITION,
      PROCESS REDEFINITION,
      AFTER_PROCESS REDEFINITION,

      CONSTRUCTOR.

    DATA: M_SYSTEM_ROLE       TYPE STRING,
          M_ANSWER            TYPE STRING,

          MT_ALL_LAND1        TYPE TRGY_LAND1,
          MT_SRC_LAND1        TYPE TRGY_LAND1,
          MT_TAR_LAND1        TYPE TRGY_LAND1,
          MT_IBANS            TYPE CL_IBAN_GENERATOR=>TBL_IBANS,
          MT_ZCOMPANY_SETTING TYPE TABLE OF ZCOMPANY_SETTING,

          MO_BANK_KEY         TYPE REF TO LCL_BANK_KEY_LOADER.


ENDCLASS.

CLASS LCL_SCREEN_1000 DEFINITION.
  PUBLIC SECTION.
    CONSTANTS:
      MC_MM_ABAP_CLASS          TYPE SEOCLSNAME VALUE 'CL_MD_PRODUCT_ECATT',
      MC_BP_ABAP_CLASS_CUSTOMER TYPE SEOCLSNAME VALUE 'CL_MD_BP_ECATT_MAINT_CUSTOMER',
      MC_BP_ABAP_CLASS_VERNDOR  TYPE SEOCLSNAME VALUE 'CL_MD_BP_ECATT_MAINT_VENDOR',

      MC_COPY_DIRECTLY          TYPE LVC_VALUE VALUE 'Copy directly',
      MC_COPY_BY_RULE           TYPE LVC_VALUE VALUE 'Copy by rule',
      MC_USER_INPUT             TYPE LVC_VALUE VALUE 'User input',
      MC_BY_AI                  TYPE LVC_VALUE VALUE 'By SAP AI Core',

      MC_COPY_DIRECTLY_CODE     TYPE UI_FUNC VALUE 'COPY_DIRECT',
      MC_COPY_BY_RULE_CODE      TYPE UI_FUNC VALUE 'COPY_RULE',
      MC_USER_INPUT_CODE        TYPE UI_FUNC VALUE 'USER_INPUT',
      MC_BY_AI_CODE             TYPE UI_FUNC VALUE 'BY_SAP_AI',

      MC_TEST_CONFIG            TYPE ETOBJ_TYPE VALUE 'ECTC', " Test Configuration
      MC_TABLE_NAME             TYPE CHAR20 VALUE 'PARAM_STRU', "Structure Name, for only ref
      MC_FIELD_VARIANT          TYPE CHAR20 VALUE 'REC_ID', " Variant ID (replaces ETVAR_ID)
      MC_FIELD_VARIANT_DESC     TYPE CHAR20 VALUE 'VARIANT_DESC', " Short Text of Parameter, Command Interface or Variant
      MC_FIELD_SOLUID           TYPE CHAR20 VALUE 'SOLUID', " Solution ID
      MC_FIELD_BBID             TYPE CHAR20 VALUE 'BBID', " BB ID
      MC_FIELD_LAND1            TYPE CHAR20 VALUE 'LAND1', " CountryID
      MC_FIELD_CHKBOX           TYPE CHAR20 VALUE 'CHKBOX', " Check Box
      MC_FIELD_FILENAME         TYPE CHAR20 VALUE 'FILENAME', " File name
      MC_FIELD_TABCOL           TYPE CHAR20 VALUE 'TABCOL'. " TABCOL


    METHODS: CONSTRUCTOR,
      GET_ECATT_DEFINES EXPORTING ET_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TBL_ECATT_DEFINES,
      LOAD_ECATT_DEFINE IMPORTING I_ECATT TYPE ETOBJ_NAME OPTIONAL,
      INIT_CNTL,
      SAVE_SETTING,
      RESET_TREE_REP_RULE,
      FILL_TBLCOLOR CHANGING CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      FILL_P4_VFILE IMPORTING I_ECATT TYPE ETOBJ_NAME,
      LOAD_P4_VFILE IMPORTING I_ECATT  TYPE ETOBJ_NAME
                              IT_LAND1 TYPE TRGY_LAND1
                              IT_BBMID TYPE /SMB/TT_SIR_BB_ID,
      FILL_ECATT_DEFINE IMPORTING I_ECATT TYPE ETOBJ_NAME,
      CREATE_VFILE IMPORTING I_TARCOUNTRY TYPE T005-LAND1
                                I_FORMAT TYPE C I_NUMCREATE TYPE I
                                ING_SIR_SI_ID     TYPE LCL_TYPE_DEFINE=>RNG_SIRID,

      CHECK_VFILE IMPORTING I_TARCOUNTRY TYPE T005-LAND1
                                I_FORMAT TYPE C I_NUMCREATE TYPE I
                                ING_SIR_SI_ID     TYPE LCL_TYPE_DEFINE=>RNG_SIRID,

      SAVE_OPTION_FIELDS,
      DISTINGUISH_CATEGORIES,
      PROMPT_EDITOR.

  PROTECTED SECTION.
  PRIVATE SECTION.
    DATA: MO_DOCK_LEFT         TYPE REF TO CL_GUI_DOCKING_CONTAINER,
          MO_DOCK_BOTTOM       TYPE REF TO CL_GUI_DOCKING_CONTAINER,
          MO_TREE_REP_RULE     TYPE REF TO CL_GUI_ALV_TREE,
          MO_VARIANT_CONTENT   TYPE REF TO CL_GUI_ALV_GRID,
          MO_CONTENT_DATA      TYPE REF TO DATA,

          ML_REPID             LIKE SY-REPID,
          ML_DYNNR             LIKE SY-DYNNR,
          ML_RELAT_NODE_KEY    TYPE LVC_NKEY,

          ML_COPY_DIRECTLY_KEY TYPE LVC_NKEY,
          " ML_COPY_BY_RULE_KEY    TYPE LVC_NKEY,
          " ML_COPY_USER_INPUT_KEY TYPE LVC_NKEY,
          ML_SUGGEST_BY_AI_KEY TYPE LVC_NKEY,

          MO_P4_INSTANCE       TYPE REF TO /SMB/IF_P4_INTEGRATION,
          ML_ECATT             TYPE ETOBJ_NAME,
          MT_OPTION_FIELDS     TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS,
          MT_ECATT_DEFINES     TYPE LCL_TYPE_DEFINE=>TBL_ECATT_DEFINES.

    METHODS: HANDLE_ECATT_DEFINE_DB_CLICK
      FOR EVENT NODE_DOUBLE_CLICK OF CL_GUI_ALV_TREE
      IMPORTING NODE_KEY SENDER,
      HANDLE_NODE_CM_REQ
        FOR EVENT NODE_CONTEXT_MENU_REQUEST OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY MENU,
      HANDLE_NODE_CM_SEL
        FOR EVENT NODE_CONTEXT_MENU_SELECTED OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY FCODE SENDER.

ENDCLASS.

CLASS LCL_VFILE_CREATOR DEFINITION.
  PUBLIC SECTION.

    METHODS: CONSTRUCTOR,
      CREATE_VFILE IMPORTING I_TARCOUNTRY TYPE T005-LAND1 I_FORMAT TYPE C I_NUMCREATE TYPE I
                                IT_OPTION_FIELDS TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS
                                IT_ROW_NO        TYPE LVC_T_ROID
                                ING_SIR_SI_ID   TYPE LCL_TYPE_DEFINE=>RNG_SIRID
                       CHANGING CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES.

  PROTECTED SECTION.
  PRIVATE SECTION.
    METHODS:
      INIT_RULE,
      ASSIGN_FIELDS_BY_RULE IMPORTING IT_OPTION_FIELDS TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS
                                      IS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      PROCESS_RULE CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      COPY_CONTENT_TO_NEW_TABLE IMPORTING IT_ROW_NO        TYPE LVC_T_ROID
                                          I_NUMCREATE      TYPE I
                                CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES.

ENDCLASS.

CLASS LCL_NEW_VFILE_TESTER DEFINITION.
  PUBLIC SECTION.
    CONSTANTS: GC_AIBP_TEST_RUN      TYPE STRING VALUE 'AIBP_TEST_RUN',
               GC_AIBP_DEBUG_RUN     TYPE STRING VALUE 'AIBP_DEBUG_RUN',
               GC_AIBP_HIDE_COL      TYPE STRING VALUE 'AIBP_HIDE_COL',
               GC_AIBP_CALL_AIANSWER TYPE STRING VALUE 'AIBP_CALL_AIANSWER',
               GC_AIBP_DOWNLOAD      TYPE STRING VALUE 'AIBP_DOWNLOAD',
               GC_AIBP_EXEC_RUN      TYPE STRING VALUE 'AIBP_EXEC_RUN'.
    METHODS:
      SHOW_NEW_VFILE CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
      DOWNLOAD_VFILE,
      SUGGEST_FILENAME RETURNING VALUE(R_FULLPATH) TYPE STRING,
      SHOW_AIANSWER,
      SET_DEBUG_FLAG,
      HIDE_COL,
      TEST_OR_EXEC_RUN IMPORTING I_UCOMM TYPE SY-UCOMM,

      ON_NEW_BP_DLG_CLOSE FOR EVENT CLOSE OF CL_GUI_DIALOGBOX_CONTAINER,
      ON_HANDLE_TOOLBAR  FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID IMPORTING E_OBJECT E_INTERACTIVE,
      ON_HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID IMPORTING E_UCOMM.

    DATA: MS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
          MO_DIALOG        TYPE REF TO CL_GUI_DIALOGBOX_CONTAINER,
          MS_LAYOUT        TYPE LVC_S_LAYO,
          MO_GRID_SOURCE   TYPE REF TO CL_GUI_ALV_GRID,
          M_DEBUG          TYPE ABAP_BOOLEAN,
          M_HIDE           TYPE ABAP_BOOLEAN,
          MT_FIELDCATALOG  TYPE LVC_T_FCAT.
ENDCLASS.


*CLASS LCL_MM_CREATOR DEFINITION.
*  PUBLIC SECTION.
*
*    METHODS: CONSTRUCTOR,
*      CREATE_MM_VFILE IMPORTING I_TARCOUNTRY TYPE T005-LAND1 I_FORMAT TYPE C I_NUMCREATE TYPE I
*                                IT_OPTION_FIELDS TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS
*                                IT_ROW_NO        TYPE LVC_T_ROID
*                                ING_SIR_SI_ID   TYPE LCL_TYPE_DEFINE=>RNG_SIRID
*                       CHANGING CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES.
*
*  PROTECTED SECTION.
*  PRIVATE SECTION.
*    METHODS:
*      INIT_RULE,
*      ASSIGN_FIELDS_BY_RULE IMPORTING IT_OPTION_FIELDS TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS
*                                      IS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
*      PROCESS_RULE CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
*      COPY_CONTENT_TO_NEW_TABLE IMPORTING IT_ROW_NO        TYPE LVC_T_ROID
*                                          I_NUMCREATE      TYPE I
*                                CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES.
*
*ENDCLASS.

*CLASS LCL_NEW_MM_TESTER DEFINITION.
*  PUBLIC SECTION.
*    CONSTANTS: GC_AIBP_TEST_RUN      TYPE STRING VALUE 'AIBP_TEST_RUN',
*               GC_AIBP_DEBUG_RUN     TYPE STRING VALUE 'AIBP_DEBUG_RUN',
*               GC_AIBP_HIDE_COL      TYPE STRING VALUE 'AIBP_HIDE_COL',
*               GC_AIBP_CALL_AIANSWER TYPE STRING VALUE 'AIBP_CALL_AIANSWER',
*               GC_AIBP_DOWNLOAD      TYPE STRING VALUE 'AIBP_DOWNLOAD',
*               GC_AIBP_EXEC_RUN      TYPE STRING VALUE 'AIBP_EXEC_RUN'.
*    METHODS:
*      SHOW_NEW_MM_VFILE CHANGING  CS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
*      DOWNLOAD_VFILE,
*      SUGGEST_FILENAME RETURNING VALUE(R_FULLPATH) TYPE STRING,
*      SHOW_AIANSWER,
*      SET_DEBUG_FLAG,
*      HIDE_COL,
*      TEST_OR_EXEC_RUN IMPORTING I_UCOMM TYPE SY-UCOMM,
*
*      ON_NEW_MM_DLG_CLOSE FOR EVENT CLOSE OF CL_GUI_DIALOGBOX_CONTAINER,
*      ON_HANDLE_TOOLBAR  FOR EVENT TOOLBAR OF CL_GUI_ALV_GRID IMPORTING E_OBJECT E_INTERACTIVE,
*      ON_HANDLE_USER_COMMAND FOR EVENT USER_COMMAND OF CL_GUI_ALV_GRID IMPORTING E_UCOMM.
*
*    DATA: MS_ECATT_DEFINES TYPE LCL_TYPE_DEFINE=>TYP_ECATT_DEFINES,
*          MO_DIALOG        TYPE REF TO CL_GUI_DIALOGBOX_CONTAINER,
*          MS_LAYOUT        TYPE LVC_S_LAYO,
*          MO_GRID_SOURCE   TYPE REF TO CL_GUI_ALV_GRID,
*          M_DEBUG          TYPE ABAP_BOOLEAN,
*          M_HIDE           TYPE ABAP_BOOLEAN,
*          MT_FIELDCATALOG  TYPE LVC_T_FCAT.
*ENDCLASS.

CLASS LCL_UTILITY IMPLEMENTATION.
  METHOD SHUFFLE_TABLE.

    DATA: LT_HISTORY TYPE TABLE OF I.

    FIELD-SYMBOLS: <RT_TABLE>  TYPE STANDARD TABLE,
                   <FS_LINE>   TYPE ANY,
                   <FS_LINE_2> TYPE ANY,
                   <FS_LINE_T> TYPE ANY.
    CREATE DATA RT_TABLE LIKE IT_TABLE.
    ASSIGN RT_TABLE->* TO <RT_TABLE>.


*    DATA: LO_DATA TYPE REF TO DATA,
*          L_LINES TYPE I.
*
*    ASSIGN CT_TABLE->* TO <FT_DATA>.

    IF GO_RANDOM IS INITIAL.
      " Initialize the random seed, using system time as the seed value.
      GET TIME STAMP FIELD DATA(GV_TIMESTAMP).
      GV_SEED = GV_TIMESTAMP MOD 1000000. " Taking a modulus to keep the seed small
      " Create an instance of the random class
      GO_RANDOM = CL_ABAP_RANDOM=>CREATE( SEED = GV_SEED ).
    ELSE.
      GV_SEED = GO_RANDOM->INT31( ).
      GO_RANDOM = CL_ABAP_RANDOM=>CREATE( SEED = GV_SEED ).
    ENDIF.

    DATA(L_ROWS_TO_RETURN) = NMIN( VAL1 = LINES( IT_TABLE ) VAL2 = I_ROWS_TO_RETURN ).

    WHILE LINES( <RT_TABLE> ) < L_ROWS_TO_RETURN.
      DATA(L_IDX) = GO_RANDOM->INTINRANGE(
        LOW  = 1 " lower bound of interval
        HIGH = LINES( IT_TABLE ) " upper bound of interval
      ).

      READ TABLE LT_HISTORY TRANSPORTING NO FIELDS WITH KEY TABLE_LINE = L_IDX.
      IF SY-SUBRC <> 0.
        APPEND L_IDX TO LT_HISTORY.

        READ TABLE IT_TABLE ASSIGNING <FS_LINE> INDEX L_IDX.
        APPEND <FS_LINE> TO <RT_TABLE>.
      ENDIF.
    ENDWHILE.
*    CREATE DATA LO_DATA LIKE <FT_DATA>.
*    ASSIGN LS_LINE_T->* TO <FS_LINE_T>.
*
*    DO L_LINES TIMES.
*      DATA(L_IDX) = GO_RANDOM->INTINRANGE(
*        LOW  = 1 " lower bound of interval
*        HIGH = L_LINES " upper bound of interval
*      ).
*
*      IF L_IDX <> SY-INDEX.
*        READ TABLE <FT_DATA> ASSIGNING <FS_LINE_1> INDEX L_IDX.
*        READ TABLE <FT_DATA> ASSIGNING <FS_LINE_2> INDEX SY-INDEX.
*
*        <FS_LINE_T> = <FS_LINE_2>.
*        <FS_LINE_2> = <FS_LINE_1>.
*        <FS_LINE_1> = <FS_LINE_T>.
*
*      ENDIF.
*
*      IF I_NUM > 0.
*
*      ENDIF.
*    ENDDO.

  ENDMETHOD.
ENDCLASS.


CLASS LCL_SETTING IMPLEMENTATION.
  METHOD CLASS_CONSTRUCTOR.
    MS_INDX-RELID = 'AI'.
    MS_INDX-SRTFD = |SET{ SY-UNAME }|.
    READ_SETTING( ).
  ENDMETHOD.

  METHOD READ_SETTING.
    IMPORT SETTING = MT_SETTING
    FROM DATABASE INDX(AI) ID MS_INDX-SRTFD TO MS_INDX.
  ENDMETHOD.

  METHOD SAVE_SETTING.
    DATA: LS_INDX TYPE INDX.
    MS_INDX-AEDAT = SY-DATUM.
    MS_INDX-USERA = SY-UNAME.
    MS_INDX-PGMID = SY-REPID.

    EXPORT SETTING = MT_SETTING
    TO DATABASE INDX(AI) ID MS_INDX-SRTFD
    FROM MS_INDX
    COMPRESSION ON.
  ENDMETHOD.

  METHOD MODIFY_SETTING.
    READ TABLE MT_SETTING ASSIGNING FIELD-SYMBOL(<FS_SETTING>) WITH KEY SETTING_ID = I_SETTING_ID.
    IF SY-SUBRC = 0 AND <FS_SETTING> IS ASSIGNED.
      <FS_SETTING>-SETTING_VALUE = I_SETTING_VALUE.
    ELSE.
      APPEND INITIAL LINE TO MT_SETTING ASSIGNING <FS_SETTING>.
      <FS_SETTING>-SETTING_ID = I_SETTING_ID.
      <FS_SETTING>-SETTING_VALUE = I_SETTING_VALUE.
    ENDIF.
    SAVE_SETTING( ).
  ENDMETHOD.
ENDCLASS.

CLASS LCL_BANK_KEY_LOADER IMPLEMENTATION.
  METHOD CONSTRUCTOR.
    MO_P4_INSTANCE = IO_P4_INSTANCE.
  ENDMETHOD.

  METHOD GET_BANK_KEY_LIST.
    DATA: L_PARAM_NAME TYPE STRING,
          LNG_BBID     TYPE LCL_TYPE_DEFINE=>RNG_BBID.

    IF ING_SCOPE[] IS INITIAL.
      LNG_BBID = VALUE #( ( OPTION = IF_FSBP_CONST_RANGE=>OPTION_CONTAINS_PATTERN
                            SIGN   = IF_FSBP_CONST_RANGE=>SIGN_INCLUDE
                            LOW    = 'J74 (++)' ) ).
    ENDIF.
    SELECT DISTINCT S~SCOPE, B~BBID, L~OBJTY, L~FILENAME
      FROM /SMB/BB_PRJ_SCO AS S INNER JOIN /SMB/BB_PRJ_ET01 AS E
        ON S~SCOPE = E~SCOPE INNER JOIN /SMB/BB_PRJ_H AS H
        ON E~PRJID = H~PRJID INNER JOIN /SMB/BBPR_I AS B
        ON E~PRJID = B~PRJID INNER JOIN /SMB/BB_LIB_I AS L
        ON B~BBID = L~BBID
      INTO TABLE @DATA(LT_SMB_BB_LIB_I)
     WHERE S~SCOPE IN @ING_SCOPE
       AND H~SIR_SI_ID IN @ING_SIR_SI_ID
       AND S~LAND1 IN @ING_LAND1
*       AND E~PRJID IN @ING_PRJID
       AND B~BBID IN @LNG_BBID
       AND L~OBJID = @GC_BANKKEY_ECATT
     ORDER BY S~SCOPE, B~BBID, L~OBJTY, L~FILENAME.

    LOOP AT LT_SMB_BB_LIB_I INTO DATA(LS_SMB_BB_LIB_I).
      TRY.
          DATA: ES_P4_FILE_METADATA	TYPE /SMB/S_P4_FILE_METADATA,
                ET_P4_PME	          TYPE /SMB/TT_P4_PME,
                RT_PME              TYPE /SMB/SBA1_I_FILE_TS.

          MO_P4_INSTANCE->READ_INSTALLATION_DATA_FILE(
            EXPORTING
              IV_SOLUTION_ID      = LS_SMB_BB_LIB_I-SCOPE  " Solution
              IV_FILENAME         = CONV #( LS_SMB_BB_LIB_I-FILENAME )   " File name
              IV_OBJTY            = LS_SMB_BB_LIB_I-OBJTY            " Activity Type
              IV_DEREFERENCED     = ABAP_TRUE
            IMPORTING
              ES_P4_FILE_METADATA = ES_P4_FILE_METADATA " Meta data for perforce file
              ET_P4_PME           = ET_P4_PME           " Table Type for P4 PME filedata
            RECEIVING
              RT_PME              = RT_PME              " SBA1 - Sorted Table type for structure /SMB/SBA1_T_FILE
          ).

          LOOP AT RT_PME ASSIGNING FIELD-SYMBOL(<FS_PME>).
            AT NEW VARIANT_ID.
              APPEND INITIAL LINE TO RT_BNKA ASSIGNING FIELD-SYMBOL(<FS_BNKA>).
            ENDAT.

            L_PARAM_NAME = <FS_PME>-PARAM_NAME.

            IF L_PARAM_NAME+0(2) = 'I_'.
              IF L_PARAM_NAME = 'I_BANKK'.
                L_PARAM_NAME = 'I_BANKL'.
              ENDIF.

              ASSIGN COMPONENT L_PARAM_NAME+2 OF STRUCTURE <FS_BNKA> TO FIELD-SYMBOL(<F_VALUE>).
              IF SY-SUBRC = 0.
                <F_VALUE> = CONV #( <FS_PME>-VALUE ).
              ENDIF.
            ENDIF.
          ENDLOOP.
        CATCH /SMB/CX_ERROR. " Solution Builder General purpose exception class
      ENDTRY.
    ENDLOOP.

  ENDMETHOD.
ENDCLASS.

CLASS LCL_RULE_PROCESS IMPLEMENTATION.
  METHOD CLASS_CONSTRUCTOR.
    REGISTER_INSTANCE( LO_RULE = NEW LCL_COPY_DIRECTLY( ) ).
    REGISTER_INSTANCE( LO_RULE = NEW LCL_BY_RULE( ) ).
    REGISTER_INSTANCE( LO_RULE = NEW LCL_USER_INPUT( ) ).
    REGISTER_INSTANCE( LO_RULE = NEW LCL_SUGGEST_BY_AI( ) ).
  ENDMETHOD.

  METHOD INIT_RULE.
    LOOP AT MT_INSTANCES INTO DATA(LO_RULE).
      LO_RULE->INIT_RULE(  ).
    ENDLOOP.

  ENDMETHOD.

  METHOD REGISTER_INSTANCE.

    APPEND LO_RULE TO MT_INSTANCES.
  ENDMETHOD.

  METHOD ADD_FIELD.
    LOOP AT MT_INSTANCES INTO DATA(LO_RULE).
      IF LO_RULE->M_MY_OPERTION_TYPE = I_OPERTION_TYPE.
        LO_RULE->ADD_FIELD( IS_FIELD ).
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD GET_DATA_TABLE.
    LOOP AT MT_INSTANCES INTO DATA(LO_RULE).
      IF LO_RULE->M_MY_OPERTION_TYPE = I_OPERTION_TYPE.
        RO_DATA_TABLE = LO_RULE->GET_DATA_TABLE( ).
        RETURN.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD GET_EXPLAIN_TABLE.
    DATA:LT_FIELD_EXPLAINS TYPE LCL_TYPE_DEFINE=>TBL_FIELDS_EXP.
    LOOP AT MT_INSTANCES INTO DATA(LO_RULE).
      IF LO_RULE->M_MY_OPERTION_TYPE = I_OPERTION_TYPE.
        LO_RULE->GET_EXPLAIN_TABLE(
          CHANGING
            CT_FIELD_EXPLAINS = LT_FIELD_EXPLAINS
        ).
        RETURN.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD FILL_CONTENT_TABLE.

    FIELD-SYMBOLS:<FS_CONTENT> TYPE ANY,
                  <F_VALUE>    TYPE ANY.

    ASSIGN IS_CONTENT TO <FS_CONTENT>.
    ASSIGN COMPONENT I_FIELDNAME OF STRUCTURE <FS_CONTENT> TO <F_VALUE>.

    LOOP AT MT_INSTANCES INTO DATA(LO_RULE).
      IF LO_RULE->M_MY_OPERTION_TYPE = I_OPERTION_TYPE.
        LO_RULE->FILL_CONTENT_TABLE(
          EXPORTING
            I_FIELDNAME = I_FIELDNAME
            I_VALUE     = <F_VALUE>
        ).
        RETURN.
      ENDIF.
    ENDLOOP.

  ENDMETHOD.

  METHOD PROCESS_RULE.
    DATA LO_RULE LIKE LINE OF MT_INSTANCES.

    LOOP AT MT_INSTANCES INTO LO_RULE.
      LO_RULE->BEFORE_PROCESS(
        CHANGING
          CS_ECATT_DEFINES = CS_ECATT_DEFINES
      ).
    ENDLOOP.

    LOOP AT MT_INSTANCES INTO LO_RULE.
      LO_RULE->PROCESS(
        CHANGING
          CS_ECATT_DEFINES = CS_ECATT_DEFINES
      ).
    ENDLOOP.

    LOOP AT MT_INSTANCES INTO LO_RULE.
      LO_RULE->AFTER_PROCESS(
        CHANGING
          CS_ECATT_DEFINES = CS_ECATT_DEFINES
      ).
    ENDLOOP.

*    NEW LCL_NEW_MM_TESTER( )->SHOW_NEW_MM_VFILE(
*      CHANGING
*        CS_ECATT_DEFINES = CS_ECATT_DEFINES
*    ).

  ENDMETHOD.

ENDCLASS.

CLASS LCL_RULE IMPLEMENTATION.
  METHOD CONSTRUCTOR.
  ENDMETHOD.

  METHOD GET_COUNTRY_TABLE.
    FIELD-SYMBOLS: <FT_CONTENT> TYPE STANDARD TABLE,
                   <FS_CONTENT> TYPE ANY,
                   <F_VALUE>    TYPE ANY.

    ASSIGN IS_ECATT_DEFINES-VARIANT_CONTENT->* TO <FT_CONTENT>.
    LOOP AT IS_ECATT_DEFINES-ROW_NO INTO DATA(LS_ROW_NO).
      READ TABLE <FT_CONTENT> ASSIGNING <FS_CONTENT> INDEX LS_ROW_NO-ROW_ID.
      IF SY-SUBRC = 0.
        APPEND <FS_CONTENT>-(LCL_SCREEN_1000=>MC_FIELD_LAND1) TO ET_SRC_LAND1.
      ENDIF.
    ENDLOOP.

    SORT ET_SRC_LAND1.
    DELETE ADJACENT DUPLICATES FROM ET_SRC_LAND1.

    APPEND IS_ECATT_DEFINES-TARCOUNTRY TO ET_TAR_LAND1.
  ENDMETHOD.

  METHOD FILL_CONTENT_TABLE.

  ENDMETHOD.

  METHOD GET_EXPLAIN_TABLE.
    REFRESH CT_FIELD_EXPLAINS.
    LOOP AT MT_FIELDS INTO DATA(LS_PARAMS).
      " 字段定义需要传输给AI，清空不需要的内容
      CLEAR: LS_PARAMS-PTYP, LS_PARAMS-PINDEX, LS_PARAMS-PGROUP, LS_PARAMS-PREF_TYPE,
             LS_PARAMS-PDOM, LS_PARAMS-PINTTYP, LS_PARAMS-PINTLEN, LS_PARAMS-PINTLEN,
             LS_PARAMS-PINTTYP, LS_PARAMS-PINTLEN, LS_PARAMS-SORT_LNR, LS_PARAMS-PREF_NAME2
             .

      APPEND INITIAL LINE TO CT_FIELD_EXPLAINS ASSIGNING FIELD-SYMBOL(<FS_FIELD_EXPLAINS>).
      MOVE-CORRESPONDING LS_PARAMS TO <FS_FIELD_EXPLAINS>.
    ENDLOOP.

  ENDMETHOD.

  METHOD GET_DATA_TABLE.
    DATA: LO_NEW_TAB   TYPE REF TO CL_ABAP_TABLEDESCR,
          LO_ESTRUTURA TYPE REF TO CL_ABAP_STRUCTDESCR.
    FREE MO_DATA_TABLE .
    IF MT_COMP_TAB[] IS NOT INITIAL.
      LO_ESTRUTURA = CL_ABAP_STRUCTDESCR=>CREATE( MT_COMP_TAB ).
      LO_NEW_TAB = CL_ABAP_TABLEDESCR=>CREATE( P_LINE_TYPE  = LO_ESTRUTURA
                                               P_TABLE_KIND = CL_ABAP_TABLEDESCR=>TABLEKIND_STD
                                               P_UNIQUE     = ABAP_FALSE ).
      CREATE DATA MO_DATA_TABLE TYPE HANDLE LO_NEW_TAB.
    ENDIF.
    RO_DATA_TABLE = MO_DATA_TABLE.
  ENDMETHOD.

  METHOD INIT_RULE.
    CLEAR: MT_FIELDS,
           MT_COMP_TAB,
           MO_DATA_TABLE,
           MS_DATA_LINE.

  ENDMETHOD.

  METHOD ADD_FIELD.
    DATA: LS_COMP              TYPE CL_ABAP_STRUCTDESCR=>COMPONENT.

    APPEND IS_FIELD TO MT_FIELDS.
    LS_COMP-NAME = IS_FIELD-PNAME.
    LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_BY_KIND( P_TYPE_KIND = IS_FIELD-PINTTYP P_LENGTH = CONV #( IS_FIELD-PINTLEN ) P_DECIMALS = CONV #( IS_FIELD-PDECIMALS ) ).
    APPEND LS_COMP TO MT_COMP_TAB.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_COPY_DIRECTLY IMPLEMENTATION.
  METHOD CONSTRUCTOR.
    SUPER->CONSTRUCTOR( ).
    M_MY_OPERTION_TYPE = LCL_TYPE_DEFINE=>COPY_DIRECTLY.
  ENDMETHOD.
  METHOD BEFORE_PROCESS.
  ENDMETHOD.
  METHOD PROCESS.
  ENDMETHOD.
  METHOD AFTER_PROCESS.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_BY_RULE IMPLEMENTATION.
  METHOD CONSTRUCTOR.
    SUPER->CONSTRUCTOR( ).
    M_MY_OPERTION_TYPE = LCL_TYPE_DEFINE=>BY_RULE.
  ENDMETHOD.
  METHOD BEFORE_PROCESS.

  ENDMETHOD.

  METHOD PROCESS.
    FIELD-SYMBOLS: <FT_CONTENT_NEW> TYPE ANY TABLE,
                   <FS_CONTENT_NEW> TYPE ANY,
                   <F_VALUE>        TYPE ANY.
    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_CONTENT_NEW>.

    LOOP AT <FT_CONTENT_NEW> ASSIGNING <FS_CONTENT_NEW>.
      LOOP AT MT_FIELDS INTO DATA(LS_FIELDS).
        ASSIGN COMPONENT LS_FIELDS-PNAME OF STRUCTURE <FS_CONTENT_NEW> TO <F_VALUE>.
        IF SY-SUBRC = 0 .
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.

  METHOD AFTER_PROCESS.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_USER_INPUT IMPLEMENTATION.
  METHOD CONSTRUCTOR.
    SUPER->CONSTRUCTOR( ).
    M_MY_OPERTION_TYPE = LCL_TYPE_DEFINE=>USER_INPUT.
  ENDMETHOD.
  METHOD BEFORE_PROCESS.
  ENDMETHOD.
  METHOD PROCESS.
  ENDMETHOD.
  METHOD AFTER_PROCESS.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_SUGGEST_BY_AI IMPLEMENTATION.
  METHOD CONSTRUCTOR.
    SUPER->CONSTRUCTOR( ).
    M_MY_OPERTION_TYPE = LCL_TYPE_DEFINE=>SUGGEST_BY_AI.

  ENDMETHOD.

  METHOD INIT_RULE.
    SUPER->INIT_RULE( ).
    CLEAR: M_SYSTEM_ROLE,
           M_ANSWER     ,
           MT_ALL_LAND1 ,
           MT_SRC_LAND1 ,
           MT_TAR_LAND1 ,
           MT_ZCOMPANY_SETTING,
           MT_IBANS.
  ENDMETHOD.

  METHOD BEFORE_PROCESS.
    " 由于AI必须提供系统中存在的配置,所以并不是所有的值都通过AI来决定,某些字段的值需要读取系统已经存在的配置
    DATA: LT_FIELD_EXPLAINS TYPE LCL_TYPE_DEFINE=>TBL_FIELDS_EXP,
          LT_IBANS          TYPE CL_IBAN_GENERATOR=>TBL_IBANS,
          LS_ALL_LAND1      TYPE LAND1,
          MD_TYPE           TYPE STRING.


    GET_COUNTRY_TABLE(
      EXPORTING
        IS_ECATT_DEFINES = CS_ECATT_DEFINES
      IMPORTING
        ET_SRC_LAND1     = MT_SRC_LAND1
        ET_TAR_LAND1     = MT_TAR_LAND1
    ).

    MT_ALL_LAND1[] = MT_SRC_LAND1[].
    APPEND LINES OF MT_TAR_LAND1 TO MT_ALL_LAND1.
    SORT MT_ALL_LAND1.
    DELETE ADJACENT DUPLICATES FROM MT_ALL_LAND1.

    IF MT_ALL_LAND1[] IS NOT INITIAL.
      SELECT * FROM ZCOMPANY_SETTING INTO TABLE @MT_ZCOMPANY_SETTING
        FOR ALL ENTRIES IN @MT_ALL_LAND1 WHERE LAND1 = @MT_ALL_LAND1-TABLE_LINE.
    ENDIF.

    LOOP AT MT_ALL_LAND1 INTO LS_ALL_LAND1.

      READ TABLE MT_ZCOMPANY_SETTING INTO DATA(LS_ZCOMPANY_SETTING) WITH KEY LAND1 = LS_ALL_LAND1.
      IF SY-SUBRC = 0  AND LS_ZCOMPANY_SETTING-LIBAN > 0.
        REFRESH: LT_IBANS.

        CL_IBAN_GENERATOR=>GENERATE_DUMMY_IBAN(
          EXPORTING
            I_BANKS    = LS_ZCOMPANY_SETTING-LAND1
            I_IBAN_LEN = LS_ZCOMPANY_SETTING-LIBAN
          IMPORTING
            ET_IBANS   = MT_IBANS
        ).

        APPEND LINES OF LT_IBANS TO MT_IBANS.
      ENDIF.

    ENDLOOP.

    GET_DATA_TABLE(
      RECEIVING
        RO_DATA_TABLE = DATA(LO_SAMPLE_DATA_TABLE)
    ).
    CHECK LO_SAMPLE_DATA_TABLE IS NOT INITIAL.

    GET_EXPLAIN_TABLE(
      CHANGING
        CT_FIELD_EXPLAINS = LT_FIELD_EXPLAINS
    ).

    "$. Region 复制样本数据
    FIELD-SYMBOLS: <FT_SAMPLE_DATA_TABLE> TYPE STANDARD TABLE,
                   <FT_CONTENT>           TYPE STANDARD TABLE,
                   <FT_CONTENT_NEW>       TYPE STANDARD TABLE.

    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT->* TO <FT_CONTENT>.
    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_CONTENT_NEW>.
    ASSIGN LO_SAMPLE_DATA_TABLE->* TO <FT_SAMPLE_DATA_TABLE>.

    LOOP AT CS_ECATT_DEFINES-ROW_NO INTO DATA(LS_ROW_NO).
      READ TABLE <FT_CONTENT> ASSIGNING FIELD-SYMBOL(<FS_CONTENT>) INDEX LS_ROW_NO-ROW_ID.
      IF SY-SUBRC = 0.
        APPEND INITIAL LINE TO <FT_SAMPLE_DATA_TABLE> ASSIGNING FIELD-SYMBOL(<FS_SAMPLE_DATA>).
        MOVE-CORRESPONDING <FS_CONTENT> TO <FS_SAMPLE_DATA>.
      ENDIF.
    ENDLOOP.

    "$. Endregion 复制样本数据

    "$. Region 添加字段注释
    LOOP AT LT_FIELD_EXPLAINS ASSIGNING FIELD-SYMBOL(<FS_FIELD_EXPLAINS>).
      CASE <FS_FIELD_EXPLAINS>-PNAME.
        WHEN 'I_AKONT'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `This is the GL Account. Please fill it with the reference data and do not simulate new values.` ) ).
        WHEN 'I_LANGU' OR 'I_LANGUISO'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `Fill in the fields by referring to the information in the country.` ) ).
        WHEN 'I_COUNTRY' OR 'I_BANKS' OR 'I_ADD_PH_COUNTRY' OR 'I_ADD_PH_COUNTRYCOUNTRYISO'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `Be consistent with the country that needs to be created. ` &&
                                                        `If an overseas factory is being created, the country to be ` &&
                                                        `created can refer to the content of the template country, ` &&
                                                        `and it should not be the same as the target country.` ) ).
        WHEN 'I_ADD_PH_COUNTRYCONSNUMBER' OR 'I_ADD_SMTP_STD_NOCONSNUMBER'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `001` ) ).
        WHEN 'I_ISTYPE'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `0001` ) ).
        WHEN 'I_SECTOR'.
          " I_ISTYPE hard code  `0001`
          SELECT A~ISTYPE, A~IND_SECTOR, B~TEXT
            FROM TB038A AS A INNER JOIN TB038B AS B ON A~ISTYPE = B~ISTYPE AND A~IND_SECTOR = B~IND_SECTOR AND B~SPRAS = @SY-LANGU
             INTO TABLE @DATA(LT_TB038A)
            WHERE A~ISTYPE = '0001'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_TB038A IN LT_TB038A ( |{ LS_TB038A-IND_SECTOR } ({ LS_TB038A-TEXT })| ) ).
        WHEN 'I_ADD_SMTP_STD_NOEMAIL_SRCH'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `Keep blank` ) ).
        WHEN 'I_ADD_PH_COUNTRYR_3_USER'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #(
            ( `' ' - Telephone is Landline Telephone` )
            ( `1 - Telephone is Default Under Landline Telephones` )
            ( `2 - Telephone is Mobile Telephone but Not Default Mobile Phone` )
            ( `3 - Telephone is Default Mobile Telephone` )
            ( `X - Obsolete - No Longer Valid` )
          ).
        WHEN 'I_ADD_PH_COUNTRYSTD_NO' OR 'I_ADD_SMTP_STD_NO'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `X - Yes` ) ( `' ' - No` ) ).
        WHEN 'I_ADD_PH_COUNTRYVALID_FROM' OR 'I_ADD_SMTP_STD_NOVALID_FROM'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `19000101` ) ).
        WHEN 'I_ADD_PH_COUNTRYVALID_TO' OR 'I_ADD_SMTP_STD_NOVALID_TO'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `99991231` ) ).
        WHEN 'I_ADDR_USAGE_TASK' OR 'I_ROLES_TASK_2' OR 'I_TAXNUMBER_TASK' OR
             'I_ROLES_TASK_1' OR 'I_ADDRESS_SMTP_TASK' OR 'I_ADDRESS_TASK'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `I - Insert` ) ).
        WHEN 'I_CATEGORY'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `1  Person` ) ( `2  Organization` ) ( `3  Group` ) ).
        WHEN 'I_CHCKSTATUS'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `   Not Checked` )
                                                        ( `C  Checked Against City Index` )
                                                        ( `D  Differs from City Index` ) ).
        WHEN 'I_CTRL_KEY'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( (
`Bank Control Key\n` &&
`Use Brazil, France, Spain, Portugal and Italy\n` &&
`The field contains a check key for the combination bank number and bank account number.\n` &&
`Use USA\n` &&
`In USA this field is used to differentiate between a savings and a current account (if no value is entered, the default value 01 is used).\n` &&
`	○ 01 Current account\n` &&
`	○ 02 Savings account\n` &&
`	○ 03 Loan account\n` &&
`	○ 04 General ledger\n` &&
`Use Japan\n` &&
`In Japan this field specifies the type of account. This information is is copied from the payment medium print program into payment medium. The following is an example of the account types used:\n` &&
`	○ 01 FUTSU (similar to a savings account)\n` &&
`	○ 02 TOUZA (similar to a current account)\n` &&
`	○ 04 CHOCHIKU (similar to an investment account)\n` &&
`	○ 09 Other types of bank accounts\n` &&
`Use South Africa\n` &&
`In South Africa this field specifies the type of account. The information entered here is forwarded to the bank that carries out the payment order. The following account types are permitted in ABC format:\n` &&
`	○ 01 Current (Cheque) Account\n` &&
`	○ 02 Savings Account\n` &&
`	○ 03 Transmission Account\n` &&
`	○ 04 Bond Account\n` &&
`	○ 06 Subscription Share Account\n` &&
`Use Argentina\n` &&
`In Argentina this field specifies the type of account:\n` &&
`	○ CC Current Account (Cuenta corriente)\n` &&
`	○ CA Saving Account (Caja de ahorro)\n` &&
`	○ CE Special Saving Account (Caja de ahorro especial)\n` &&
`	○ CS Salary Account (Cuenta sueldos)\n` &&
`Use Venezuela\n` &&
`In Venezuela this field specifies the type of account:\n` &&
`	○ CC Checking Account (Cuenta corriente)\n` &&
`	○ CA Saving Account (Cuenta de ahorro)\n` &&
`	○ CE Special Saving Account (Cuenta de ahorro especial)\n` &&
`	○ CS Salary Account (Cuenta sueldos)\n` &&
`Use Mexico\n` &&
`In Mexico this field contains a two-digit key for classifying the bank account (for example, as a savings or current account). This key have different definitions, depending on the bank.\n` &&
`Note\n` &&
`For countries that are not listed here, this field can be used for account-specific information.`
           ) ).
        WHEN 'I_BANKL'.
          " TODO /SMBA0/BANK_CREATE_O001_J16
          DATA LT_BNKA TYPE BF_BNKA.

          IF MO_BANK_KEY IS INITIAL.
            MO_BANK_KEY = NEW LCL_BANK_KEY_LOADER( IO_P4_INSTANCE = CS_ECATT_DEFINES-P4_INSTANCE ).
          ENDIF.

          MO_BANK_KEY->GET_BANK_KEY_LIST(
            EXPORTING
              ING_SIR_SI_ID = CS_ECATT_DEFINES-RNG_SIR_SI_ID
              ING_SCOPE     = VALUE LCL_TYPE_DEFINE=>RNG_SCOPE(                       ( OPTION = IF_FSBP_CONST_RANGE=>OPTION_CONTAINS_PATTERN
                                                                                        SIGN   = IF_FSBP_CONST_RANGE=>SIGN_INCLUDE
                                                                                        LOW    = 'BP_S4BL_S4HANAX_++V1' ) )
              ING_LAND1     = VALUE LCL_TYPE_DEFINE=>RNG_LAND1( FOR L IN MT_TAR_LAND1 ( OPTION = IF_FSBP_CONST_RANGE=>OPTION_EQUAL
                                                                                        SIGN   = IF_FSBP_CONST_RANGE=>SIGN_INCLUDE
                                                                                        LOW    = L ) )
            RECEIVING
              RT_BNKA       = LT_BNKA
          ).

*          SELECT * FROM BNKA INTO TABLE @LT_BNKA
*            FOR ALL ENTRIES IN @MT_ALL_LAND1
*            WHERE BANKS = @MT_ALL_LAND1-TABLE_LINE.

          IF LT_BNKA[] IS NOT INITIAL.
            APPEND LINES OF  VALUE STRING_TABLE( FOR GROUPS OF GP_BNKA IN LT_BNKA
                                           GROUP BY GP_BNKA-BANKS
                                           ASCENDING
                                           ( REDUCE STRING(
                                           INIT
                                           R = |Bank key for { GP_BNKA-BANKS } =>|
                                           FOR LS_BNKA IN GROUP GP_BNKA
                                           NEXT R = |{ R } { LS_BNKA-BANKL } ({ LS_BNKA-BANKA }) | )
                                            ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          ENDIF.
        WHEN 'I_BANKN'.

*          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES =
*                                           VALUE STRING_TABLE(
*                                           FOR GROUPS OF GP_IBANS IN MT_IBANS
*                                           GROUP BY GP_IBANS-BANK_COUNTRY
*                                           ASCENDING
*                                           ( REDUCE STRING(
*                                           INIT
*                                           R TYPE STRING
*                                           FOR LS_IBANS IN GROUP GP_IBANS
*                                           NEXT R = COND #( WHEN R = `` THEN |Bank account list of { GP_IBANS-BANK_COUNTRY }:| ELSE
*                                           |{ R }, { LS_IBANS-BANK_ACCOUNT }(for bank key: { LS_IBANS-BANK_KEY_IN_IBAN })| ) )
*                                            ) ) .
*          APPEND 'If there is an IBAN, select the corresponding bank account. ' &&
*                 'If there is no IBAN, create a virtual bank account.' TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
*          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_IBANS IN MT_IBANS (
*            |Bank key { LS_IBANS-BANK_ACCOUNT } of { LS_IBANS-BANK_COUNTRY } Bank key: { LS_IBANS-BANK_KEY } | )
*            ).
*
          SELECT * FROM T005 INTO TABLE @DATA(LT_T005)
            FOR ALL ENTRIES IN @MT_ALL_LAND1
            WHERE LAND1 = @MT_ALL_LAND1-TABLE_LINE.
          IF LT_T005[] IS NOT INITIAL.
*            DATA: LO_T005 TYPE REF TO DATA.
*
*            LCL_UTILITY=>SHUFFLE_TABLE(
*              EXPORTING
*                IT_TABLE = LT_T005
*              RECEIVING
*                RT_TABLE = LO_T005
*            ).
*
*            LT_T005 = LO_T005->*.

            APPEND LINES OF VALUE STRING_TABLE( FOR LS_T005 IN LT_T005 (
            COND #(
            WHEN LS_T005-LNBKN = 0 THEN |Bank account length of { LS_T005-LAND1 } is no limit. |
            ELSE |Bank account length of { LS_T005-LAND1 } is limit to { LS_T005-LNBKN }. |
            ) )
            ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          ENDIF.
*          APPEND 'The Bank account should be consistent with the selected bank key.' TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.

        WHEN 'I_IBAN00'.

*          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_IBANS IN MT_IBANS (
*            |IBAN number { LS_IBANS-IBAN } of { LS_IBANS-BANK_COUNTRY } Bank account: { LS_IBANS-BANK_ACCOUNT } Bank key: { LS_IBANS-BANK_KEY } | )
*            ).
*          APPEND 'The IBAN number should be consistent with the selected bank key.' TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
*          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR GROUPS OF GP_IBANS IN MT_IBANS
*                                           GROUP BY GP_IBANS-BANK_COUNTRY
*                                           ASCENDING
*                                           ( REDUCE STRING(
*                                           INIT
*                                           R TYPE STRING
*                                           FOR LS_IBANS IN GROUP GP_IBANS
*                                           NEXT R = COND #( WHEN R = `` THEN |IBAN list of { GP_IBANS-BANK_COUNTRY }:| ELSE
*                                           |{ R }, { LS_IBANS-IBAN }(for bank key: { LS_IBANS-BANK_KEY_IN_IBAN })| ) )
*                                            ) ).
*          APPEND 'If there is an IBAN, select the corresponding IBAN. ' &&
*                 'If there is no IBAN, leave it blank.' TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.


        WHEN 'I_XERSY' OR 'I_WEBRE'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `Indicator value, choice X or '' only` ) ).
        WHEN 'I_POSTL_COD1'.
          " CHECK RULE T005
        WHEN 'I_QLAND'.
          SELECT * FROM T005Q INTO TABLE @DATA(LT_T005Q)
            FOR ALL ENTRIES IN @MT_ALL_LAND1
            WHERE LAND1 = @MT_ALL_LAND1-TABLE_LINE.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR GROUPS OF GP_T005Q IN LT_T005Q
                                           GROUP BY GP_T005Q-LAND1
                                           ASCENDING
                                           ( REDUCE STRING(
                                           INIT
                                           R = |Choose one of I_QLAND in list for { GP_T005Q-LAND1 } =>|
                                           FOR LS_T005Q IN GROUP GP_T005Q
                                           NEXT R = |{ R } { LS_T005Q-QLAND } | )
                                            ) ).
        WHEN 'I_WITHT_1' OR 'I_WITHT_2' OR 'I_WITHT_3' OR 'I_WITHT_4' OR 'I_WITHT_5'.
          SELECT * FROM T059Z INTO TABLE @DATA(LT_T059Z)
            FOR ALL ENTRIES IN @MT_ALL_LAND1
            WHERE LAND1 = @MT_ALL_LAND1-TABLE_LINE.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR GROUPS OF GP_T059Z IN LT_T059Z
                                           GROUP BY GP_T059Z-LAND1
                                           ASCENDING
                                           ( REDUCE STRING(
                                           INIT
                                           R = |Choose one of { <FS_FIELD_EXPLAINS>-PNAME } in list for { GP_T059Z-LAND1 } =>|
                                           FOR LS_T059Z IN GROUP GP_T059Z
                                           NEXT R = |{ R } { LS_T059Z-WITHT } | )
                                            ) ).

        WHEN 'I_WT_WITHCD_1' OR 'I_WT_WITHCD_2' OR 'I_WT_WITHCD_3' OR 'I_WT_WITHCD_4' OR 'I_WT_WITHCD_5'.
          SELECT * FROM T059Z INTO TABLE @LT_T059Z
            FOR ALL ENTRIES IN @MT_ALL_LAND1
            WHERE LAND1 = @MT_ALL_LAND1-TABLE_LINE.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR GROUPS OF GP_T059Z IN LT_T059Z
                                           GROUP BY GP_T059Z-LAND1
                                           ASCENDING
                                           ( REDUCE STRING(
                                           INIT
                                           R = |Choose one of { <FS_FIELD_EXPLAINS>-PNAME } in list for { GP_T059Z-LAND1 } =>|
                                           FOR LS_T059Z IN GROUP GP_T059Z
                                           NEXT R = |{ R } { LS_T059Z-WT_WITHCD } | )
                                            ) ).

        WHEN 'I_INCO'.
          "TINC
          SELECT TINC~INCO1, TINCT~BEZEI FROM TINC INNER JOIN TINCT
            ON TINCT~INCO1 = TINCT~INCO1 AND TINCT~SPRAS = @SY-LANGU
            INTO TABLE @DATA(LT_TINC).
          APPEND LINES OF VALUE STRING_TABLE( FOR LS_TINC IN LT_TINC (
          | { LS_TINC-INCO1 } ( { LS_TINC-BEZEI } ) |
          ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
        WHEN 'I_INCO2'.
        WHEN 'I_REGION'.
          " T005S
          " LT_SRC_LAND1
          " LT_TAR_LAND1
          IF MT_ALL_LAND1[] IS NOT INITIAL.
            LOOP AT MT_ALL_LAND1 INTO LS_ALL_LAND1.
              SELECT * FROM T005S INTO TABLE @DATA(LT_T005S)
                WHERE LAND1 = @LS_ALL_LAND1.
              SELECT * FROM T005U INTO TABLE @DATA(LT_T005U)
                FOR ALL ENTRIES IN @LT_T005S
                WHERE LAND1 = @LT_T005S-LAND1
                 AND SPRAS = @SY-LANGU.

*              DATA: LO_T005S TYPE REF TO DATA.
*
*              LCL_UTILITY=>SHUFFLE_TABLE(
*                EXPORTING
*                  IT_TABLE = LT_T005S
*                RECEIVING
*                  RT_TABLE = LO_T005S
*              ).
*
*              LT_T005S = LO_T005S->*.

              APPEND LINES OF VALUE STRING_TABLE( FOR GROUPS OF GP_T005S IN LT_T005S
                                                     GROUP BY GP_T005S-LAND1
                                                     ASCENDING
                                                     ( REDUCE STRING(
                                                     INIT
                                                     R = |Choose the value of I_REGION from the list for { GP_T005S-LAND1 } =>|
                                                     FOR LS_T005S IN GROUP GP_T005S
                                                     NEXT R = |{ R } { LS_T005S-BLAND }({ VALUE #( LT_T005U[ SPRAS = SY-LANGU LAND1 = GP_T005S-LAND1 BLAND = LS_T005S-BLAND ]-BEZEI ) }) | )
                                                      ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.

            ENDLOOP.
          ENDIF.

        WHEN 'I_MATNR'.
          MD_TYPE = 'Material'.

        WHEN 'I_BP_KUNNR' OR 'I_BP_LIFNR'.
          MD_TYPE = 'Busines partner'.

          APPEND |Consider the changes in the first two digits of the 'BUKRS' corresponding to the countries.| TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          APPEND LINES OF VALUE STRING_TABLE( FOR LS_SRC_LAND1 IN MT_SRC_LAND1 ( | If { LS_SRC_LAND1 } BP number is 00{ MT_ZCOMPANY_SETTING[ LAND1 = LS_SRC_LAND1 ]-BUKRS+0(2) }100001 | ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          APPEND LINES OF VALUE STRING_TABLE( FOR LS_TAR_LAND1 IN MT_TAR_LAND1 ( | Then { LS_TAR_LAND1 } BP number is 00{ MT_ZCOMPANY_SETTING[ LAND1 = LS_TAR_LAND1 ]-BUKRS+0(2) }100001 | ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          APPEND LINES OF VALUE STRING_TABLE( FOR LS_SRC_LAND1 IN MT_SRC_LAND1 ( | If { LS_SRC_LAND1 } BP number is 00{ MT_ZCOMPANY_SETTING[ LAND1 = LS_SRC_LAND1 ]-BUKRS+0(2) }300001 | ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
          APPEND LINES OF VALUE STRING_TABLE( FOR LS_TAR_LAND1 IN MT_TAR_LAND1 ( | Then { LS_TAR_LAND1 } BP number is 00{ MT_ZCOMPANY_SETTING[ LAND1 = LS_TAR_LAND1 ]-BUKRS+0(2) }300001 | ) ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.
        WHEN 'I_GROUPING'.
          " TB001
          SELECT * FROM TB001 INTO TABLE @DATA(LT_TB001). " WHERE BU_GROUP IN ( 'BP03', 'BP04' ).
          SELECT * FROM NRIV INTO TABLE @DATA(LT_NRIV) WHERE OBJECT = 'BU_PARTNER'.

          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_TB001 IN LT_TB001
                                                                   ( |The value range of BP groupings { LS_TB001-BU_GROUP } is from { LT_NRIV[ NRRANGENR = LS_TB001-NRRNG ]-FROMNUMBER } to { LT_NRIV[ NRRANGENR = LS_TB001-NRRNG ]-TONUMBER }. | ) ).

          APPEND LINES OF VALUE STRING_TABLE(
          ( |Pay attention to the start and end ranges of the number and letter groupings for I_MATNR , then carefully select the corresponding I_GROUPING value.| )
          ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.

          APPEND LINES OF VALUE STRING_TABLE(
          ( |Note that for the BUKRS number corresponding to the country to be created, if it consists of only numbers, select BP03; if it contains letters, select BP04.| )
          ) TO <FS_FIELD_EXPLAINS>-SUGGEST_VALUES.

        WHEN 'I_TAXJURCODE' OR 'I_TAXJURCODE_NV'.
          "BR: J_1BTREG_CITY
          "CA/US: TTXJ  "
          " 等 AI  返回后在处理
        WHEN 'I_TAXNUMBER_TAXNUMBER'.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `If the sample data exists, reuse it; otherwise, leave it blank.` ) ).
        WHEN 'I_TAXNUMBER_TAXTYPE'.
          "TFKTAXNUMTYPE

          TYPES: TNG_TAXTYPE TYPE RANGE OF V_TFKTAXNUMTYPE-TAXTYPE.

          DATA(RNG_TAXTYPE) = VALUE TNG_TAXTYPE( FOR LS_TMP_LAND1 IN MT_ALL_LAND1 ( OPTION = IF_FSBP_CONST_RANGE=>OPTION_CONTAINS_PATTERN
                                                                                    SIGN   = IF_FSBP_CONST_RANGE=>SIGN_INCLUDE
                                                                                    LOW    = |{ LS_TMP_LAND1 }*|
                                                                                    HIGH   = `` ) ).
          SELECT TFKTAXNUMTYPE~TAXTYPE, TFKTAXNUMTYPE_T~TEXT FROM TFKTAXNUMTYPE INNER JOIN TFKTAXNUMTYPE_T
            ON TFKTAXNUMTYPE~TAXTYPE = TFKTAXNUMTYPE_T~TAXTYPE AND TFKTAXNUMTYPE_T~SPRAS = @SY-LANGU
            INTO TABLE @DATA(LT_TFKTAXNUMTYPE)
            WHERE TFKTAXNUMTYPE~TAXTYPE IN @RNG_TAXTYPE.

          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_TFKTAXNUMTYPE IN LT_TFKTAXNUMTYPE ( |{ LS_TFKTAXNUMTYPE-TAXTYPE }-{ LS_TFKTAXNUMTYPE-TEXT }| ) ).

        WHEN 'I_TIME_ZONE'.
          DATA EF_TIMEZONE TYPE TTZDATA-TZONE.

          CALL FUNCTION 'TZON_LOCATION_TIMEZONE'
            EXPORTING
              IF_COUNTRY        = CS_ECATT_DEFINES-TARCOUNTRY
*             IF_REGION         = ' '
*             IF_ZIPCODE        = IF_ZIPCODE
            IMPORTING
              EF_TIMEZONE       = EF_TIMEZONE
            EXCEPTIONS
              NO_TIMEZONE_FOUND = 1.
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( CONV #( EF_TIMEZONE ) ) ).
        WHEN 'I_TRANSPZONE'.
          " LZONE
          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE #( ( `0000000001` ) ( `0000000002` ) ).
        WHEN 'I_ZTERM_COMP' OR 'I_ZTERM_PORG'.
          SELECT T052~ZTERM, T052U~TEXT1
            FROM T052 INNER JOIN T052U
              ON T052~ZTERM = T052U~ZTERM
             AND T052~ZTAGG = T052U~ZTAGG
             AND T052U~SPRAS = @SY-LANGU
            INTO TABLE @DATA(LT_T052).

          <FS_FIELD_EXPLAINS>-SUGGEST_VALUES = VALUE STRING_TABLE( FOR LS_T052 IN LT_T052 ( |{ LS_T052-ZTERM }-{ LS_T052-TEXT1 }| ) ).

        WHEN OTHERS.
      ENDCASE.
    ENDLOOP.
    "$. Endregion 添加字段注释


    "$. Region 准备prompt需要的参数
*    ${COUTRY_LIST}
    DATA(COUTRY_LIST) = REDUCE STRING( INIT R = `` FOR C IN MT_SRC_LAND1 NEXT R = COND #( WHEN R IS INITIAL THEN C ELSE |{ R }, { C }| ) ).
*    ${TARGET_COUNTRY}
    DATA(TARGET_COUNTRY) = REDUCE STRING( INIT R = `` FOR C IN MT_TAR_LAND1 NEXT R = COND #( WHEN R IS INITIAL THEN C ELSE |{ R }, { C }| ) ).
*    ${NUM_CREATE}
    DATA(NUM_CREATE) = |{ CS_ECATT_DEFINES-NUMCREATE }|.
*    ${FIELD_EXPLAIN}
    /UI2/CL_JSON=>SERIALIZE(
      EXPORTING
        DATA          = LT_FIELD_EXPLAINS  " Data to serialize
        COMPRESS      = ABAP_TRUE         " Skip empty elements
        FORMAT_OUTPUT = ABAP_TRUE    " Indent and split in lines serialized JSON
      RECEIVING
        R_JSON        = DATA(FIELD_EXPLAIN)           " JSON string
    ).
*    ${OUTPUT_FORMAT}
    DATA(OUTPUT_FORMAT) = COND #( WHEN CS_ECATT_DEFINES-FORMAT = ABAP_FALSE THEN 'TABLE' ELSE 'JSON' ).
*    ${COUNTRY_BASICINFO}
    /UI2/CL_JSON=>SERIALIZE(
      EXPORTING
        DATA          = MT_ZCOMPANY_SETTING  " Data to serialize
        COMPRESS      = ABAP_TRUE         " Skip empty elements
        FORMAT_OUTPUT = ABAP_TRUE    " Indent and split in lines serialized JSON
      RECEIVING
        R_JSON        = DATA(COUNTRY_BASICINFO)           " JSON string
    ).
*    ${SAMPLE_DATA}
    /UI2/CL_JSON=>SERIALIZE(
      EXPORTING
        DATA          = LO_SAMPLE_DATA_TABLE  " Data to serialize
        COMPRESS      = ABAP_TRUE         " Skip empty elements
        FORMAT_OUTPUT = ABAP_TRUE    " Indent and split in lines serialized JSON
      RECEIVING
        R_JSON        = DATA(SAMPLE_DATA)           " JSON string
    ).
    "$. Endregion 准备prompt需要的参数


    " 暂时从本地读取Prompt文本
    DATA: LT_SYSTEM_ROLE TYPE STANDARD TABLE OF STRING,
          LS_INDX        TYPE INDX.
    IMPORT SYSTEM_ROLE = LT_SYSTEM_ROLE
    FROM DATABASE INDX(AI) ID 'PromptMD' TO LS_INDX
    .

    " 本地文本多行内表转换成1行
    M_SYSTEM_ROLE = REDUCE #( INIT R = `` FOR ROL IN LT_SYSTEM_ROLE NEXT R = |{ R }{ CL_ABAP_CHAR_UTILITIES=>CR_LF }{ ROL }| ).

    "$. Region 替换Prompt中的变量值
    REPLACE :'${COUTRY_LIST}'    IN M_SYSTEM_ROLE WITH COUTRY_LIST,
             '${TARGET_COUNTRY}' IN M_SYSTEM_ROLE WITH TARGET_COUNTRY,
             '${FIELD_EXPLAIN}'  IN M_SYSTEM_ROLE WITH FIELD_EXPLAIN,
             '${OUTPUT_FORMAT}'  IN M_SYSTEM_ROLE WITH OUTPUT_FORMAT,
             '${COUNTRY_BASICINFO}' IN M_SYSTEM_ROLE WITH COUNTRY_BASICINFO,
             '${SAMPLE_DATA}'    IN M_SYSTEM_ROLE WITH SAMPLE_DATA,
             '${NUM_CREATE}'     IN M_SYSTEM_ROLE WITH NUM_CREATE,
             '${MD_TYPE}'        IN M_SYSTEM_ROLE WITH MD_TYPE.

    "$. Endregion 替换Prompt中的变量值
  ENDMETHOD.

  METHOD PROCESS.
    CHECK M_SYSTEM_ROLE IS NOT INITIAL.

    "$. Region 调用AI 引擎
    DATA: LO_AI TYPE REF TO CL_CONVERSATION.
    LO_AI = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).

    LO_AI->SET_SYSTEM_ROLE( I_SYSTEM_ROLE = M_SYSTEM_ROLE ).
    CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
      EXPORTING
        " percentage = 100
        TEXT = 'AI is thinking...'(002).


    LO_AI->CALL_AI_ENGINEER(
*        IMPORTING
*          EO_API_RESULT = EO_API_RESULT
      RECEIVING
        R_ANSWER = M_ANSWER
    ).


    "$. Region 保存AI 返回结果
**    DATA(LT_JSON_OUTPUT) = VALUE STRING_TABLE(
**     ( `-------------------------------------------------` )
**     ( `----------------------PROMPT---------------------` )
**     ( `-------------------------------------------------` )
**     ( M_SYSTEM_ROLE )
**     ( `-------------------------------------------------` )
**     ( `--------------------AI OUTPUT--------------------` )
**     ( `-------------------------------------------------` )
**     ( M_ANSWER ) ).
**    CL_GUI_FRONTEND_SERVICES=>GUI_DOWNLOAD(
**      EXPORTING
***       BIN_FILESIZE            = BIN_FILESIZE         " File length for binary files
**        FILENAME                = 'C:\tmp\BP_AI\Result\New_MM_BP_GEN_O001.txt'             " Name of file
**        FILETYPE                = 'ASC'                " File type (ASCII, binary ...)
***       APPEND                  = SPACE                " Character Field of Length 1
***       WRITE_FIELD_SEPARATOR   = SPACE                " Separate Columns by Tabs in Case of ASCII Download
***       HEADER                  = '00'                 " Byte Chain Written to Beginning of File in Binary Mode
***       TRUNC_TRAILING_BLANKS   = SPACE                " Do not Write Blank at the End of Char Fields
***       WRITE_LF                = 'X'                  " Insert CR/LF at End of Line in Case of Char Download
***       COL_SELECT              = SPACE                " Copy Only Selected Columns of the Table
***       COL_SELECT_MASK         = SPACE                " Vector Containing an 'X' for the Column To Be Copied
***       DAT_MODE                = SPACE                " Numeric and date fields are in DAT format in WS_DOWNLOAD
***       CONFIRM_OVERWRITE       = SPACE                " Overwrite File Only After Confirmation
***       NO_AUTH_CHECK           = SPACE                " Switch off Check for Access Rights
**        CODEPAGE                = '4110'             " Character Representation for Output
***       IGNORE_CERR             = ABAP_TRUE            " Ignore character set conversion errors?
***       REPLACEMENT             = '#'                  " Replacement Character for Non-Convertible Characters
***       WRITE_BOM               = SPACE                " If set, writes a Unicode byte order mark
***       TRUNC_TRAILING_BLANKS_EOL = 'X'                  " Remove Trailing Blanks in Last Column
***       WK1_N_FORMAT            = SPACE
***       WK1_N_SIZE              = SPACE
***       WK1_T_FORMAT            = SPACE
***       WK1_T_SIZE              = SPACE
***       SHOW_TRANSFER_STATUS    = 'X'                  " Enables suppression of transfer status message
***       FIELDNAMES              = FIELDNAMES           " Table Field Names
***       WRITE_LF_AFTER_LAST_LINE  = 'X'                  " Writes a CR/LF after final data record
***       VIRUS_SCAN_PROFILE      = '/SCET/GUI_DOWNLOAD' " Virus Scan Profile
***      IMPORTING
***       FILELENGTH              = FILELENGTH           " Number of bytes transferred
**      CHANGING
**        DATA_TAB                = LT_JSON_OUTPUT   " Transfer table
**      EXCEPTIONS
**        FILE_WRITE_ERROR        = 1                    " Cannot write to file
**        NO_BATCH                = 2                    " Cannot execute front-end function in background
**        GUI_REFUSE_FILETRANSFER = 3                    " Incorrect Front End
**        INVALID_TYPE            = 4                    " Invalid value for parameter FILETYPE
**        NO_AUTHORITY            = 5                    " No Download Authorization
**        UNKNOWN_ERROR           = 6                    " Unknown error
**        HEADER_NOT_ALLOWED      = 7                    " Invalid header
**        SEPARATOR_NOT_ALLOWED   = 8                    " Invalid separator
**        FILESIZE_NOT_ALLOWED    = 9                    " Invalid file size
**        HEADER_TOO_LONG         = 10                   " Header information currently restricted to 1023 bytes
**        DP_ERROR_CREATE         = 11                   " Cannot create DataProvider
**        DP_ERROR_SEND           = 12                   " Error Sending Data with DataProvider
**        DP_ERROR_WRITE          = 13                   " Error Writing Data with DataProvider
**        UNKNOWN_DP_ERROR        = 14                   " Error when calling data provider
**        ACCESS_DENIED           = 15                   " Access to File Denied
**        DP_OUT_OF_MEMORY        = 16                   " Not enough memory in data provider
**        DISK_FULL               = 17                   " Storage medium is full.
**        DP_TIMEOUT              = 18                   " Data provider timeout
**        FILE_NOT_FOUND          = 19                   " Could not find file
**        DATAPROVIDER_EXCEPTION  = 20                   " General Exception Error in DataProvider
**        CONTROL_FLUSH_ERROR     = 21                   " Error in Control Framework
**        NOT_SUPPORTED_BY_GUI    = 22                   " GUI does not support this
**        ERROR_NO_GUI            = 23                   " GUI not available
**    ).
**    IF SY-SUBRC <> 0.
***     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
***       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
**    ENDIF.
    "$. Endregion 保存AI 返回结果

    "$. Endregion 调用AI 引擎
  ENDMETHOD.

  METHOD AFTER_PROCESS.
    CHECK M_ANSWER IS NOT INITIAL.
    DATA: LO_JSON_DATA    TYPE CL_AI_RESULT_PROCESSER=>TBL_DATA,
          L_N             TYPE N LENGTH 10,
          L_R             TYPE I,
          L_L             TYPE I,
          L_VALUE_FROM_AI TYPE STRING.

    CS_ECATT_DEFINES-AI_ANSWER = M_ANSWER.
    CS_ECATT_DEFINES-SYSTEM_ROLE = M_SYSTEM_ROLE.

    CL_AI_RESULT_PROCESSER=>FIND_JSON(
      EXPORTING
        I_TEXT        = M_ANSWER
      IMPORTING
        ET_JSON_DATA  = LO_JSON_DATA
      RECEIVING
        IS_FOUND_JSON = DATA(LS_FOUND_JSON)
    ).

    IF LS_FOUND_JSON = ABAP_TRUE.
      FIELD-SYMBOLS: <FT_CONTENT_NEW>  TYPE STANDARD TABLE,
                     <FS_CONTENT_NEW>  TYPE ANY,
                     <FT_JSON_DATA>    TYPE ANY,
                     <FS_JSON_DATA>    TYPE ANY,
                     <F_VALUE_FROM_AI> TYPE ANY,
                     <F_VALUE_NEW>     TYPE ANY,
                     <F_VALUE_NEW_X>   TYPE ANY.

      ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_CONTENT_NEW>.

      LOOP AT LO_JSON_DATA INTO DATA(LT_JSON_DATA).
        ASSIGN LT_JSON_DATA TO <FT_JSON_DATA>.
        LOOP AT <FT_JSON_DATA>->* ASSIGNING <FS_JSON_DATA> .
          READ TABLE <FT_CONTENT_NEW> ASSIGNING <FS_CONTENT_NEW> INDEX SY-TABIX.
          CHECK SY-SUBRC = 0.
          LOOP AT MT_FIELDS INTO DATA(LS_FIELDS).
            ASSIGN COMPONENT LS_FIELDS-PNAME OF STRUCTURE <FS_JSON_DATA>->* TO <F_VALUE_FROM_AI>.
            IF SY-SUBRC = 0 AND <F_VALUE_FROM_AI> IS NOT INITIAL.
              ASSIGN COMPONENT LS_FIELDS-PNAME OF STRUCTURE <FS_CONTENT_NEW> TO <F_VALUE_NEW>.
              IF SY-SUBRC = 0 AND <F_VALUE_NEW> IS ASSIGNED.
                L_VALUE_FROM_AI = <F_VALUE_FROM_AI>->*.
                READ TABLE CS_ECATT_DEFINES-PARAMS ASSIGNING FIELD-SYMBOL(<FS_PARAMS>) WITH KEY PNAME = LS_FIELDS-PNAME.
                IF SY-SUBRC = 0.
                  CASE <FS_PARAMS>-PINTTYP.
                    WHEN 'C'.
                      <F_VALUE_NEW> = L_VALUE_FROM_AI.
                    WHEN 'D'.
                      IF L_VALUE_FROM_AI IS INITIAL.
                        CLEAR <F_VALUE_NEW>.
                      ELSE.
                        <F_VALUE_NEW> = L_VALUE_FROM_AI.
                      ENDIF.
                    WHEN OTHERS.
                      TRY.
                          <F_VALUE_NEW> = L_VALUE_FROM_AI.

                        CATCH CX_SY_CONVERSION_NO_NUMBER.

                      ENDTRY.
                  ENDCASE.
                ENDIF.

                UNASSIGN <F_VALUE_NEW_X>.
                ASSIGN COMPONENT |{ LS_FIELDS-PNAME }_X| OF STRUCTURE <FS_CONTENT_NEW> TO <F_VALUE_NEW_X>.
                IF SY-SUBRC = 0 AND <F_VALUE_NEW_X> IS ASSIGNED.
                  IF <F_VALUE_NEW> IS INITIAL.
                    <F_VALUE_NEW_X> = ABAP_FALSE.
                  ELSE.
                    <F_VALUE_NEW_X> = ABAP_TRUE.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDLOOP.
        ENDLOOP.
      ENDLOOP.

      TRY.
          " UPDATE IBAN Number
          READ TABLE CS_ECATT_DEFINES-PARAMS TRANSPORTING NO FIELDS WHERE PNAME = 'I_COUNTRY' OR PNAME = 'I_BANKL' OR PNAME = 'I_IBAN00'.
          IF SY-SUBRC = 0.
            LOOP AT <FT_CONTENT_NEW> ASSIGNING <FS_CONTENT_NEW>.
              ASSIGN COMPONENT 'I_COUNTRY' OF STRUCTURE <FS_CONTENT_NEW> TO FIELD-SYMBOL(<F_I_COUNTRY>).
              ASSIGN COMPONENT 'I_BANKL' OF STRUCTURE <FS_CONTENT_NEW> TO FIELD-SYMBOL(<F_I_BANKL>).
              ASSIGN COMPONENT 'I_IBAN00' OF STRUCTURE <FS_CONTENT_NEW> TO FIELD-SYMBOL(<F_I_IBAN00>).
              IF <F_I_COUNTRY> IS ASSIGNED AND <F_I_BANKL> IS ASSIGNED AND <F_I_IBAN00> IS ASSIGNED.
                READ TABLE MT_ZCOMPANY_SETTING INTO DATA(LS_ZCOMPANY_SETTING) WITH KEY LAND1 = <F_I_COUNTRY>.
                IF SY-SUBRC = 0 AND LS_ZCOMPANY_SETTING-LIBAN > 0.
                  READ TABLE MT_IBANS INTO DATA(LS_IBANS) WITH KEY
                    BANK_COUNTRY = <F_I_COUNTRY>
                    BANK_KEY = <F_I_BANKL>.
                  IF SY-SUBRC = 0.
                    <F_I_IBAN00> = LS_IBANS-IBAN.
*                  <FS_CONTENT_NEW>-('I_BANKN') = LS_IBANS-BANK_ACCOUNT.
                  ENDIF.
                ELSE.
                  CLEAR <F_I_IBAN00>.
                ENDIF.
              ENDIF.
            ENDLOOP.
          ENDIF.

        CATCH CX_SY_ASSIGN_ILLEGAL_COMPONENT.

      ENDTRY.
    ENDIF.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_SCREEN_1000 IMPLEMENTATION.
  METHOD GET_ECATT_DEFINES.
    ET_ECATT_DEFINES = MT_ECATT_DEFINES.
  ENDMETHOD.

  METHOD LOAD_ECATT_DEFINE.
    DATA: LT_MAP_E2A     TYPE TABLE OF /SMB/MAP_E2A,
          LS_OBJECT_ID   TYPE ETAPI_OBJ,
          LO_TEST_CONFIG TYPE REF TO CL_APL_ECATT_TC_API.


    IF I_ECATT IS INITIAL.
      SELECT * FROM /SMB/MAP_E2A INTO TABLE LT_MAP_E2A
        WHERE ( REPLACING_CLASS IN ( MC_MM_ABAP_CLASS,
                                     MC_BP_ABAP_CLASS_CUSTOMER,
                                     MC_BP_ABAP_CLASS_VERNDOR )  ).

      LOOP AT LT_MAP_E2A INTO DATA(LS_MAP_E2A).
        APPEND INITIAL LINE TO MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>).
        <FS_ECATT_DEFINES>-ECATT = LS_MAP_E2A-ECATT.
        <FS_ECATT_DEFINES>-CLASS = LS_MAP_E2A-REPLACING_CLASS.
      ENDLOOP.
    ELSE.
      READ TABLE MT_ECATT_DEFINES TRANSPORTING NO FIELDS WITH KEY ECATT = I_ECATT.
      IF SY-SUBRC <> 0.
        SELECT * FROM /SMB/MAP_E2A INTO TABLE LT_MAP_E2A WHERE ECATT = I_ECATT .

        LOOP AT LT_MAP_E2A INTO LS_MAP_E2A.
          APPEND INITIAL LINE TO MT_ECATT_DEFINES ASSIGNING <FS_ECATT_DEFINES>.
          <FS_ECATT_DEFINES>-ECATT = LS_MAP_E2A-ECATT.
          <FS_ECATT_DEFINES>-CLASS = LS_MAP_E2A-REPLACING_CLASS.
        ENDLOOP.
      ENDIF.

      READ TABLE MT_ECATT_DEFINES ASSIGNING <FS_ECATT_DEFINES> WITH KEY ECATT = I_ECATT.
      IF SY-SUBRC = 0.
*    --> Test Config Details
        LS_OBJECT_ID-TYPE     = MC_TEST_CONFIG. " Type as test config
        LS_OBJECT_ID-NAME     = <FS_ECATT_DEFINES>-ECATT. " Ecatt Config Name
        LS_OBJECT_ID-VERSION  =  1. " Version

*    --> Get instance for test configuration
*        CL_APL_ECATT_API_FC=>GET_INSTANCE(
*          EXPORTING
*            IS_OBJECT_ID   = LS_OBJECT_ID   " eCATT Identification of Object in API Runtime
*          IMPORTING
*            EP_ECATT_TC_IF = DATA(LIF_TEST_CONFIG) ). " Inteface for Test Configuration


*    --> Get the parameters in the configuration
        TRY .
*            LO_TEST_CONFIG ?= LIF_TEST_CONFIG. " Broad casting
*            LO_TEST_CONFIG->IF_APL_ECATT_API~LOAD_OBJECT( )." Load the objects
**    --> List of params in the config
*            DATA(LT_PARAMS) =   LO_TEST_CONFIG->IF_APL_ECATT_API_PARAMS~GET_PARAMS( ).
            DATA(LRF_OBJ_ECATT_DEF) = /SMB/SBA1_CL_ECATT_DEF=>GET_INSTANCE(
              PVF_NEW   = ABAP_TRUE
              PVF_ECATT = LS_OBJECT_ID-NAME
*             pvf_soluid       = pvf_soluid
            ).

            DATA(LT_PARAMS) = LRF_OBJ_ECATT_DEF->GET_ECATT_PARAM( IV_RESOLVE_TDC_REF = ABAP_FALSE ).
            SORT LT_PARAMS BY PNAME ASCENDING.

            LOOP AT LT_PARAMS ASSIGNING FIELD-SYMBOL(<FS_PARAMS>) WHERE PDATTYP = 'DATS'.
              "<FS_PARAMS>-PDATTYP = 'CHAR'.
              <FS_PARAMS>-PDATLEN = '10'.
              "<FS_PARAMS>-PINTTYP = 'C'.
              "<FS_PARAMS>-PINTLEN = '10'.
            ENDLOOP.

            " 2 (hours) + 2 (minutes) + 2 (seconds) + 2 (separators) = 8 characters
            LOOP AT LT_PARAMS ASSIGNING <FS_PARAMS> WHERE PDATTYP = 'TIMS'.
              "<FS_PARAMS>-PDATTYP = 'CHAR'.
              <FS_PARAMS>-PDATLEN = '8'.
              "<FS_PARAMS>-PINTTYP = 'C'.
              "<FS_PARAMS>-PINTLEN = '8'.
            ENDLOOP.

            <FS_ECATT_DEFINES>-PARAMS = LT_PARAMS.
            <FS_ECATT_DEFINES>-ECATT_API = LRF_OBJ_ECATT_DEF.
          CATCH CX_ECATT_API  /SMB/CX_SBA1_ECATT_DEF /SMB/CX_GMD_ERROR /SMB/CX_TYPES.
        ENDTRY.
      ENDIF.
    ENDIF.
  ENDMETHOD.

  METHOD CONSTRUCTOR.
    ML_REPID = SY-REPID.
    ML_DYNNR = SY-DYNNR.

    /SMB/CL_P4_INTEGRATION=>GET_INSTANCE(
      RECEIVING
        RO_INSTANCE = MO_P4_INSTANCE
    ).

  ENDMETHOD.

  METHOD SAVE_SETTING.
    IF MO_DOCK_LEFT IS NOT INITIAL.
      MO_DOCK_LEFT->GET_EXTENSION(
        IMPORTING
          EXTENSION         = DATA(L_EXTENSION) " Current Extension
        EXCEPTIONS
          CNTL_ERROR        = 1         " CNTL_ERROR
          CNTL_SYSTEM_ERROR = 2         " CNTL_SYSTEM_ERROR
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      LCL_SETTING=>MODIFY_SETTING( I_SETTING_ID = 'MO_DOCK_LEFT_EXTENSION' I_SETTING_VALUE = CONV STRING( L_EXTENSION ) ).

    ENDIF.

    IF MO_TREE_REP_RULE IS NOT INITIAL.
      MO_TREE_REP_RULE->GET_HIERARCHY_HEADER_WIDTH(
        IMPORTING
          E_WIDTH = DATA(E_WIDTH) " Width of Hierarchy Column
      ).

      CL_GUI_CFW=>FLUSH( ).
      LCL_SETTING=>MODIFY_SETTING( I_SETTING_ID = 'LEFT_HIERARCHY_HEADER-WIDTH' I_SETTING_VALUE = CONV STRING( E_WIDTH ) ).
    ENDIF.

    IF MO_DOCK_BOTTOM IS NOT INITIAL.
      MO_DOCK_BOTTOM->GET_EXTENSION(
        IMPORTING
          EXTENSION         = L_EXTENSION " Current Extension
        EXCEPTIONS
          CNTL_ERROR        = 1         " CNTL_ERROR
          CNTL_SYSTEM_ERROR = 2         " CNTL_SYSTEM_ERROR
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      LCL_SETTING=>MODIFY_SETTING( I_SETTING_ID = 'MO_DOCK_BOTTOM-EXTENSION' I_SETTING_VALUE = CONV STRING( L_EXTENSION ) ).
    ENDIF.
  ENDMETHOD.

  METHOD INIT_CNTL.
    DATA: L_HIERARCHY_HEADER TYPE TREEV_HHDR,
          LT_FIELDCATALOG    TYPE LVC_T_FCAT,
          L_NEW_NODE_KEY     TYPE LVC_NKEY,
          L_OUTPUT_LINE      TYPE LCL_TYPE_DEFINE=>TYP_OPTION_FIELDS.

    IF MO_DOCK_LEFT IS INITIAL.
      MO_DOCK_LEFT = NEW CL_GUI_DOCKING_CONTAINER(
*       PARENT    = PARENT                  " Parent container
        REPID     = ML_REPID                 " Report to Which This Docking Control is Linked
        DYNNR     = ML_DYNNR                 " Screen to Which This Docking Control is Linked
        SIDE      = CL_GUI_DOCKING_CONTAINER=>DOCK_AT_LEFT  " Side to Which Control is Docked
        EXTENSION = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'MO_DOCK_LEFT_EXTENSION' ]-SETTING_VALUE DEFAULT 300 ) " Control Extension
*       STYLE     = STYLE                   " Windows Style Attributes Applied to This Docking Container
*       LIFETIME  = LIFETIME_DEFAULT        " Lifetime
*       CAPTION   = CAPTION                 " Caption
*       METRIC    = 0                       " Metric
*       RATIO     = RATIO                   " Percentage of Screen: Takes Priority Over EXTENSION
*       NO_AUTODEF_PROGID_DYNNR     = NO_AUTODEF_PROGID_DYNNR " Don't Autodefined Progid and Dynnr?
        NAME      = 'DOCK_LEFT'             " Name
      ).
    ENDIF.

    IF MO_TREE_REP_RULE IS INITIAL.
      MO_TREE_REP_RULE = NEW CL_GUI_ALV_TREE(
*      LIFETIME       = LIFETIME  " Lifetime
        PARENT              = MO_DOCK_LEFT            " Parent Container
*       SHELLSTYLE          = SHELLSTYLE              " Shell Style
        NODE_SELECTION_MODE = CL_GUI_COLUMN_TREE=>NODE_SEL_MODE_MULTIPLE " Nodes: Single or Multiple Selection
*       HIDE_SELECTION      = HIDE_SELECTION          " Visibility of Selection
        ITEM_SELECTION      = ABAP_TRUE               " Can Individual Items be Selected?
        NO_TOOLBAR          = ABAP_FALSE              " NO_TOOLBAR
        NO_HTML_HEADER      = ABAP_FALSE              " NO_HTML_HEADER
*       I_PRINT             = I_PRINT                 " Print Only
*       I_FCAT_COMPLETE     = I_FCAT_COMPLETE
*       I_MODEL_MODE        = I_MODEL_MODE
      ).

      L_HIERARCHY_HEADER-HEADING = 'Type'.
      L_HIERARCHY_HEADER-TOOLTIP = ''.
      L_HIERARCHY_HEADER-WIDTH = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'LEFT_HIERARCHY_HEADER-WIDTH' ]-SETTING_VALUE DEFAULT 40 ). " Control Extension.
      L_HIERARCHY_HEADER-WIDTH_PIX = ''.

      LT_FIELDCATALOG = VALUE #(
      " ( COL_POS = 01 FIELDNAME = 'OPTION'      KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'Option type'   DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'Option type'   SCRTEXT_M = 'Option type'   SCRTEXT_S = 'Option type' )
      " ( COL_POS = 05 FIELDNAME = 'FIELDNAME'   KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'Field name'    DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'Field name'    SCRTEXT_M = 'Field name'    SCRTEXT_S = 'Fld' )
      ( COL_POS = 10 FIELDNAME = 'DESCRIPTION' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 100 REPTEXT = 'Description' DOMNAME = '' DD_OUTLEN = 100 SCRTEXT_L = 'Description' SCRTEXT_M = 'Description' SCRTEXT_S = 'Desc.' )
      " ( COL_POS = 15 FIELDNAME = 'REFERENCE'   KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 10 REPTEXT = 'TDC reference' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'TDC reference' SCRTEXT_M = 'TDC reference' SCRTEXT_S = 'TDC' )
      ).

      CALL METHOD MO_TREE_REP_RULE->SET_TABLE_FOR_FIRST_DISPLAY
        EXPORTING
          IS_HIERARCHY_HEADER = L_HIERARCHY_HEADER
        CHANGING
          IT_FIELDCATALOG     = LT_FIELDCATALOG
          IT_OUTTAB           = MT_OPTION_FIELDS. "table must be empty !

      CALL METHOD RESET_TREE_REP_RULE( ).

      DATA: LT_REGISTERED_EVENTS TYPE CNTL_SIMPLE_EVENTS,
            LS_REGISTERED_EVENTS TYPE CNTL_SIMPLE_EVENT.
      MO_TREE_REP_RULE->GET_REGISTERED_EVENTS(
        IMPORTING
          EVENTS     = LT_REGISTERED_EVENTS " simple_events
        EXCEPTIONS
          CNTL_ERROR = 1      " cntl_error
      ).
      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

*§4b. Frontend registration(ii): add additional event ids
      LS_REGISTERED_EVENTS-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_NODE_DOUBLE_CLICK.
      APPEND LS_REGISTERED_EVENTS TO LT_REGISTERED_EVENTS.
      LS_REGISTERED_EVENTS-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_NODE_CONTEXT_MENU_REQ.
      APPEND LS_REGISTERED_EVENTS TO LT_REGISTERED_EVENTS.

*§4c. Frontend registration(iii):provide new event table to alv tree
      CALL METHOD MO_TREE_REP_RULE->SET_REGISTERED_EVENTS
        EXPORTING
          EVENTS                    = LT_REGISTERED_EVENTS
        EXCEPTIONS
          CNTL_ERROR                = 1
          CNTL_SYSTEM_ERROR         = 2
          ILLEGAL_EVENT_COMBINATION = 3.
      IF SY-SUBRC <> 0.
        MESSAGE X208(00) WITH 'ERROR'.                      "#EC NOTEXT
      ENDIF.

      SET HANDLER ME->HANDLE_ECATT_DEFINE_DB_CLICK FOR MO_TREE_REP_RULE.
      SET HANDLER ME->HANDLE_NODE_CM_REQ FOR MO_TREE_REP_RULE.
      SET HANDLER ME->HANDLE_NODE_CM_SEL FOR MO_TREE_REP_RULE.

    ENDIF.

    IF MO_DOCK_BOTTOM IS INITIAL.
      MO_DOCK_BOTTOM = NEW CL_GUI_DOCKING_CONTAINER(
*       PARENT    = PARENT  " Parent container
        REPID     = ML_REPID                   " Report to Which This Docking Control is Linked
        DYNNR     = ML_DYNNR                   " Screen to Which This Docking Control is Linked
        SIDE      = CL_GUI_DOCKING_CONTAINER=>DOCK_AT_BOTTOM  " Side to Which Control is Docked
        EXTENSION = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'MO_DOCK_BOTTOM-EXTENSION' ]-SETTING_VALUE DEFAULT 200 )  " Control Extension
*       STYLE     = STYLE                   " Windows Style Attributes Applied to This Docking Container
*       LIFETIME  = LIFETIME_DEFAULT        " Lifetime
*       CAPTION   = CAPTION                 " Caption
*       METRIC    = 0                       " Metric
*       RATIO     = RATIO                   " Percentage of Screen: Takes Priority Over EXTENSION
*       NO_AUTODEF_PROGID_DYNNR     = NO_AUTODEF_PROGID_DYNNR " Don't Autodefined Progid and Dynnr?
        NAME      = 'DOCK_BOTTOM'           " Name
      ).
    ENDIF.

    IF MO_VARIANT_CONTENT IS INITIAL.
      CREATE OBJECT MO_VARIANT_CONTENT
        EXPORTING
          I_PARENT = MO_DOCK_BOTTOM.
    ENDIF.

    CALL METHOD MO_TREE_REP_RULE->FRONTEND_UPDATE( ).
  ENDMETHOD.

  METHOD RESET_TREE_REP_RULE.
    DATA: LS_LAYOUT_NODE TYPE LVC_S_LAYN,
          L_NODE_IMAGE   TYPE TV_IMAGE.

    LS_LAYOUT_NODE-ISFOLDER = ABAP_TRUE.   "=>add a folder, NOT a leaf
    LS_LAYOUT_NODE-N_IMAGE = L_NODE_IMAGE. "=>Display an icon

    MO_TREE_REP_RULE->DELETE_ALL_NODES(
      EXCEPTIONS
        FAILED            = 1 " General Error
        CNTL_SYSTEM_ERROR = 2 " "
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
        WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    MO_TREE_REP_RULE->ADD_NODE(
      EXPORTING
        I_RELAT_NODE_KEY     = ML_RELAT_NODE_KEY " Node Already in Tree Hierarchy
        I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
*       IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
        IS_NODE_LAYOUT       = LS_LAYOUT_NODE   " Node Layout
*       IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
        I_NODE_TEXT          = MC_COPY_DIRECTLY   " Hierarchy Node Text
      IMPORTING
        E_NEW_NODE_KEY       = ML_COPY_DIRECTLY_KEY   " Key of New Node Key
      EXCEPTIONS
        RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
        NODE_NOT_FOUND       = 2                " Node not Found
    ).

    MO_TREE_REP_RULE->EXPAND_NODE(
      EXPORTING
        I_NODE_KEY = ML_COPY_DIRECTLY_KEY       " Node Key
*       I_LEVEL_COUNT       = 1                " Number of Levels to be Expanded
*       I_EXPAND_SUBTREE    = I_EXPAND_SUBTREE " 'X': Expand all Subsequent Nodes
*      EXCEPTIONS
*       FAILED     = 1                " General Error
*       ILLEGAL_LEVEL_COUNT = 2                " LEVEL_COUNT Must Be GE 0
*       CNTL_SYSTEM_ERROR   = 3                " "
*       NODE_NOT_FOUND      = 4                " Node With Key NODE_KEY Does Not Exist
*       CANNOT_EXPAND_LEAF  = 5                " Node With Key NODE_KEY is a Leaf
    ).
    IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

*    MO_TREE_REP_RULE->ADD_NODE(
*      EXPORTING
*        I_RELAT_NODE_KEY     = ML_RELAT_NODE_KEY " Node Already in Tree Hierarchy
*        I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
**       IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
*        IS_NODE_LAYOUT       = LS_LAYOUT_NODE   " Node Layout
**       IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
*        I_NODE_TEXT          = MC_COPY_BY_RULE   " Hierarchy Node Text
*      IMPORTING
*        E_NEW_NODE_KEY       = ML_COPY_BY_RULE_KEY   " Key of New Node Key
*      EXCEPTIONS
*        RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
*        NODE_NOT_FOUND       = 2                " Node not Found
*    ).

*    MO_TREE_REP_RULE->ADD_NODE(
*      EXPORTING
*        I_RELAT_NODE_KEY     = ML_RELAT_NODE_KEY " Node Already in Tree Hierarchy
*        I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
**       IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
*        IS_NODE_LAYOUT       = LS_LAYOUT_NODE   " Node Layout
**       IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
*        I_NODE_TEXT          = MC_USER_INPUT   " Hierarchy Node Text
*      IMPORTING
*        E_NEW_NODE_KEY       = ML_COPY_USER_INPUT_KEY   " Key of New Node Key
*      EXCEPTIONS
*        RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
*        NODE_NOT_FOUND       = 2                " Node not Found
*    ).

    MO_TREE_REP_RULE->ADD_NODE(
      EXPORTING
        I_RELAT_NODE_KEY     = ML_RELAT_NODE_KEY " Node Already in Tree Hierarchy
        I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
*       IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
        IS_NODE_LAYOUT       = LS_LAYOUT_NODE   " Node Layout
*       IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
        I_NODE_TEXT          = MC_BY_AI   " Hierarchy Node Text
      IMPORTING
        E_NEW_NODE_KEY       = ML_SUGGEST_BY_AI_KEY   " Key of New Node Key
      EXCEPTIONS
        RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
        NODE_NOT_FOUND       = 2                " Node not Found
    ).

    MO_TREE_REP_RULE->EXPAND_NODE(
      EXPORTING
        I_NODE_KEY = ML_SUGGEST_BY_AI_KEY       " Node Key
*       I_LEVEL_COUNT       = 1                " Number of Levels to be Expanded
*       I_EXPAND_SUBTREE    = I_EXPAND_SUBTREE " 'X': Expand all Subsequent Nodes
*      EXCEPTIONS
*       FAILED     = 1                " General Error
*       ILLEGAL_LEVEL_COUNT = 2                " LEVEL_COUNT Must Be GE 0
*       CNTL_SYSTEM_ERROR   = 3                " "
*       NODE_NOT_FOUND      = 4                " Node With Key NODE_KEY Does Not Exist
*       CANNOT_EXPAND_LEAF  = 5                " Node With Key NODE_KEY is a Leaf
    ).
    IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDMETHOD.

  METHOD FILL_TBLCOLOR.
    FIELD-SYMBOLS: <FT_VARIANT_CONTENT> TYPE STANDARD TABLE.
    DATA: LT_TABCOL TYPE LVC_T_SCOL,
          LS_TABCOL TYPE LVC_S_SCOL.

    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT->* TO <FT_VARIANT_CONTENT>.
    REFRESH LT_TABCOL.
    LOOP AT MT_OPTION_FIELDS ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS>) WHERE FIELDNAME IS NOT INITIAL.
      CLEAR LS_TABCOL-COLOR-COL.
      CASE <FS_OPTION_FIELDS>-OPTION.
        WHEN LCL_TYPE_DEFINE=>COPY_DIRECTLY.
          " LS_TABCOL-COLOR-COL = 1. "CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED.
        WHEN LCL_TYPE_DEFINE=>BY_RULE.
          " LS_TABCOL-COLOR-COL = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_A.
        WHEN LCL_TYPE_DEFINE=>USER_INPUT.
          " LS_TABCOL-COLOR-COL = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_B.
        WHEN LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
          LS_TABCOL-COLOR-COL = 5. "CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_C.
      ENDCASE.
      IF LS_TABCOL-COLOR IS NOT INITIAL.
        LS_TABCOL-FNAME = <FS_OPTION_FIELDS>-FIELDNAME.
        APPEND LS_TABCOL TO LT_TABCOL.
      ENDIF.
    ENDLOOP.

    CS_ECATT_DEFINES-TBLCOL = LT_TABCOL.

    LOOP AT <FT_VARIANT_CONTENT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT>).
      <FS_VARIANT_CONTENT>-(MC_FIELD_TABCOL) = LT_TABCOL.
    ENDLOOP.
  ENDMETHOD.

  METHOD FILL_P4_VFILE.
    FIELD-SYMBOLS: <FT_VARIANT_CONTENT> TYPE STANDARD TABLE.

    CHECK MO_VARIANT_CONTENT IS NOT INITIAL AND I_ECATT IS NOT INITIAL.
    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = I_ECATT.
    CHECK SY-SUBRC = 0.

    ASSIGN <FS_ECATT_DEFINES>-VARIANT_CONTENT->* TO <FT_VARIANT_CONTENT>.
    CHECK <FT_VARIANT_CONTENT> IS ASSIGNED.

    FILL_TBLCOLOR( CHANGING CS_ECATT_DEFINES = <FS_ECATT_DEFINES> ).

    MO_VARIANT_CONTENT->SET_TABLE_FOR_FIRST_DISPLAY(
      EXPORTING
*       I_BUFFER_ACTIVE               = I_BUFFER_ACTIVE      " Buffering Active
*       I_BYPASSING_BUFFER            = I_BYPASSING_BUFFER   " Switch Off Buffer
*       I_CONSISTENCY_CHECK           = I_CONSISTENCY_CHECK  " Starting Consistency Check for Interface Error Recognition
*       I_STRUCTURE_NAME              = I_STRUCTURE_NAME     " Internal Output Table Structure Name
*       IS_VARIANT                    = IS_VARIANT           " Variant
*       I_SAVE                        = I_SAVE               " Save Layout
*       I_DEFAULT                     = 'X'                  " Default Display Variant
        IS_LAYOUT                     = VALUE LVC_S_LAYO( SEL_MODE = 'A' CWIDTH_OPT = ABAP_TRUE ZEBRA = ABAP_TRUE BOX_FNAME = MC_FIELD_CHKBOX CTAB_FNAME = MC_FIELD_TABCOL )  " Layout
*       IS_PRINT                      = IS_PRINT             " Print Control
*       IT_SPECIAL_GROUPS             = IT_SPECIAL_GROUPS    " Field Groups
*       IT_TOOLBAR_EXCLUDING          = IT_TOOLBAR_EXCLUDING " Excluded Toolbar Standard Functions
*       IT_HYPERLINK                  = IT_HYPERLINK         " Hyperlinks
*       IT_ALV_GRAPHICS               = IT_ALV_GRAPHICS      " Table of Structure DTC_S_TC
*       IT_EXCEPT_QINFO               = IT_EXCEPT_QINFO      " Table for Exception Quickinfo
*       IR_SALV_ADAPTER               = IR_SALV_ADAPTER      " Internal Usage only !!! - obsolete
      CHANGING
        IT_OUTTAB                     = <FT_VARIANT_CONTENT>            " Output Table
        IT_FIELDCATALOG               = <FS_ECATT_DEFINES>-FIELDCATALOG      " Field Catalog
*       IT_SORT                       = IT_SORT              " Sort Criteria
*       IT_FILTER                     = IT_FILTER            " Filter Criteria
      EXCEPTIONS
        INVALID_PARAMETER_COMBINATION = 1                    " Wrong Parameter
        PROGRAM_ERROR                 = 2                    " Program Errors
        TOO_MANY_LINES                = 3                    " Too many Rows in Ready for Input Grid
    ).
    IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.


  ENDMETHOD.

  METHOD LOAD_P4_VFILE.
    DATA: LS_P4_FILE_METADATA TYPE /SMB/S_P4_FILE_METADATA,
          " LT_PME              TYPE /SMB/SBA1_I_FILE_TS,
          LS_COMP             TYPE CL_ABAP_STRUCTDESCR=>COMPONENT,
          LV_SIZE             TYPE I,
          LT_COMP_TAB         TYPE CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
          LO_NEW_TAB          TYPE REF TO CL_ABAP_TABLEDESCR,
          LO_ESTRUTURA        TYPE REF TO CL_ABAP_STRUCTDESCR,
          L_COL_POS           TYPE I,
          LDF_ANY             TYPE REF TO DATA.
    FIELD-SYMBOLS: <FT_VARIANT_CONTENT> TYPE STANDARD TABLE,
                   <FS_FIELDCATALOG>    TYPE LVC_S_FCAT,
                   <FS_F_ANY>           TYPE ANY.

    DATA:RNG_BBID TYPE RANGE OF /SMB/BBID.

    CONSTANTS C_SIZE TYPE I VALUE 30.

    ML_ECATT = I_ECATT.
    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = ML_ECATT.
    CHECK SY-SUBRC = 0 ."AND <FS_ECATT_DEFINES>-P4_FILE IS INITIAL.

    DATA(LT_BBID) = IT_BBMID[].
    DELETE LT_BBID WHERE TABLE_LINE IS INITIAL.
    CHECK LT_BBID[] IS NOT INITIAL.
    LOOP AT LT_BBID INTO DATA(LS_BBMID) WHERE TABLE_LINE IS NOT INITIAL.
      APPEND INITIAL LINE TO RNG_BBID ASSIGNING FIELD-SYMBOL(<FS_BBID>).
      <FS_BBID>-LOW = |{ LS_BBMID }*|.
      <FS_BBID>-SIGN = 'I'.
      <FS_BBID>-OPTION = 'CP'.
    ENDLOOP.

    CLEAR <FS_ECATT_DEFINES>-REF_ECATT.
    SELECT SINGLE REF_ECATT INTO @<FS_ECATT_DEFINES>-REF_ECATT FROM ZSMB_MAP_E2A WHERE ECATT = @ML_ECATT.

    LOOP AT IT_LAND1 ASSIGNING FIELD-SYMBOL(<FS_LAND1>).
      DATA(L_SOLUTION) = |BP_S4BL_S4HANAX_{ <FS_LAND1> }V1|.

      SELECT * FROM /CFG/V_FILE_SOL_VIEW(
        P_MANDT = @SY-MANDT,
        P_SOLUTION = @L_SOLUTION
        )
        INTO TABLE @DATA(LT_V_FILE_SOL)
        WHERE OBJID = @ML_ECATT
          AND OBJTY = 'ECAT'
          AND BBID IN @RNG_BBID.

      IF <FS_ECATT_DEFINES>-REF_ECATT IS NOT INITIAL.
        SELECT * FROM /CFG/V_FILE_SOL_VIEW(
          P_MANDT = @SY-MANDT,
          P_SOLUTION = @L_SOLUTION
          )
          APPENDING TABLE @LT_V_FILE_SOL
          WHERE OBJID = @<FS_ECATT_DEFINES>-REF_ECATT
            AND OBJTY = 'ECAT'
            AND BBID IN @RNG_BBID.
      ENDIF.

      IF LT_V_FILE_SOL[] IS NOT INITIAL.
        SELECT * FROM /SMB/BB_PRJ_SCO INTO TABLE @DATA(LT_BB_PRJ_SCO)
          FOR ALL ENTRIES IN @LT_V_FILE_SOL
          WHERE SCOPE = @LT_V_FILE_SOL-SOLUTION_ID.
      ENDIF.

      LOOP AT LT_V_FILE_SOL ASSIGNING FIELD-SYMBOL(<FS_V_FILE_SOL>).
        " 已经读取过的BB 就忽略
        READ TABLE <FS_ECATT_DEFINES>-P4_FILE TRANSPORTING NO FIELDS
        WITH KEY BBID = <FS_V_FILE_SOL>-BBID
                 FILENAME = <FS_V_FILE_SOL>-FILENAME.
        CHECK SY-SUBRC <> 0.
        APPEND INITIAL LINE TO <FS_ECATT_DEFINES>-P4_FILE ASSIGNING FIELD-SYMBOL(<FS_P4_FILE>).

        <FS_P4_FILE>-P4_FILE_METADATA = LS_P4_FILE_METADATA.
        " <FS_P4_FILE>-PME = LT_PME[].
        <FS_P4_FILE>-P4_INSTANCE = MO_P4_INSTANCE.
        <FS_P4_FILE>-BBID = <FS_V_FILE_SOL>-BBID.
        READ TABLE LT_BB_PRJ_SCO INTO DATA(LS_BB_PRJ_SCO) WITH KEY SCOPE = <FS_V_FILE_SOL>-SOLUTION_ID.
        IF SY-SUBRC = 0.
          <FS_P4_FILE>-LAND1 = LS_BB_PRJ_SCO-LAND1.
        ENDIF.
        <FS_P4_FILE>-FILENAME = <FS_V_FILE_SOL>-FILENAME.
        <FS_P4_FILE>-INCLUDE = <FS_V_FILE_SOL>.

        TRY.
            MO_P4_INSTANCE->READ_INSTALLATION_DATA_FILE(
              EXPORTING
                IV_SOLUTION_ID      = <FS_V_FILE_SOL>-SOLUTION_ID        " Solution
                IV_FILENAME         = CONV #( <FS_V_FILE_SOL>-FILENAME ) " File name
                IV_OBJTY            = 'ECAT' " 'SOBJ'            " Activity Type
                IV_DEREFERENCED     = ABAP_TRUE
              IMPORTING
                ES_P4_FILE_METADATA = <FS_P4_FILE>-P4_FILE_METADATA " Meta data for perforce file
              RECEIVING
                RT_PME              = <FS_P4_FILE>-PME              " SBA1 - Sorted Table type for structure /SMB/SBA1_T_FILE
            ).

          CATCH /SMB/CX_ERROR.
        ENDTRY.
      ENDLOOP.
    ENDLOOP.

    DEFINE ADD_TABLE_FIX_COLS.
      APPEND INITIAL LINE TO <FS_ECATT_DEFINES>-FIELDCATALOG ASSIGNING <FS_FIELDCATALOG>.
      <FS_FIELDCATALOG>-COL_POS = L_COL_POS. <FS_FIELDCATALOG>-FIELDNAME = &1.
      <FS_FIELDCATALOG>-INTTYPE = 'C'.  <FS_FIELDCATALOG>-INTLEN = &2.
      <FS_FIELDCATALOG>-COLTEXT = &1. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = &1.
      <FS_FIELDCATALOG>-SCRTEXT_L = &1. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = &1.
      <FS_FIELDCATALOG>-OUTPUTLEN = COND #( WHEN <FS_FIELDCATALOG>-INTLEN > C_SIZE THEN C_SIZE ELSE <FS_FIELDCATALOG>-INTLEN ).
      LS_COMP-NAME = <FS_FIELDCATALOG>-FIELDNAME.
      LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_C( P_LENGTH = CONV #( <FS_FIELDCATALOG>-INTLEN ) ).
      APPEND LS_COMP TO LT_COMP_TAB.
      ADD 1 TO L_COL_POS.

    END-OF-DEFINITION.

    LS_COMP-NAME = MC_FIELD_CHKBOX.
    LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_C( P_LENGTH = 1 ).
    APPEND LS_COMP TO LT_COMP_TAB.

    IF <FS_ECATT_DEFINES>-FIELDCATALOG[] IS INITIAL.
      L_COL_POS = 1.
      LOOP AT <FS_ECATT_DEFINES>-PARAMS ASSIGNING FIELD-SYMBOL(<LS_PARAMS>).
        CLEAR: LS_COMP .

*--> Add Reciver ID ( Variant ) Field to the structure
        AT FIRST.
          ADD_TABLE_FIX_COLS MC_FIELD_SOLUID 40 .
          ADD_TABLE_FIX_COLS MC_FIELD_BBID 40 .
          ADD_TABLE_FIX_COLS MC_FIELD_LAND1 40 .
          ADD_TABLE_FIX_COLS MC_FIELD_FILENAME 255 .
          ADD_TABLE_FIX_COLS MC_FIELD_VARIANT 255 .
          ADD_TABLE_FIX_COLS MC_FIELD_VARIANT_DESC 255 .
        ENDAT.

*--> Prepare data type as char for each field
        LS_COMP-NAME = <LS_PARAMS>-PNAME.

        IF ( <LS_PARAMS>-PINTTYP IS NOT INITIAL AND <LS_PARAMS>-PINTLEN IS NOT INITIAL ) OR
           ( <LS_PARAMS>-PDATTYP IS NOT INITIAL AND <LS_PARAMS>-PDATLEN IS NOT INITIAL ).

          CASE <LS_PARAMS>-PINTTYP.
            WHEN 'D' OR 'F' OR 'I' OR 'STRING' OR 'T' OR 'XSTRING'.
              CREATE DATA LDF_ANY TYPE (<LS_PARAMS>-PINTTYP).
            WHEN 'C' OR 'N'. " => In normal unicode systems with UTF-16, two bytes are used per character, so the internal length is twice the actual length
              " So use external length for creation
              CREATE DATA LDF_ANY TYPE (<LS_PARAMS>-PINTTYP) LENGTH <LS_PARAMS>-PDATLEN.
            WHEN 'X'.
              " Type X uses 1 Byte to represent two characters, so use the internal length to create it, because this how the statement works...
              CREATE DATA LDF_ANY TYPE (<LS_PARAMS>-PINTTYP) LENGTH <LS_PARAMS>-PINTLEN.
            WHEN 'P'.
              CREATE DATA LDF_ANY TYPE P LENGTH <LS_PARAMS>-PINTLEN DECIMALS <LS_PARAMS>-PDECIMALS.
            WHEN 'b' OR 's'.
              CREATE DATA LDF_ANY TYPE (<LS_PARAMS>-PDATTYP).
            WHEN 'g'.
              CREATE DATA LDF_ANY TYPE STRING.
            WHEN OTHERS.
              RAISE EXCEPTION TYPE CX_SY_CREATE_DATA_ERROR.
          ENDCASE.
          ASSIGN LDF_ANY->* TO <FS_F_ANY>.
          LS_COMP-TYPE ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA( <FS_F_ANY> ).

        ELSEIF <LS_PARAMS>-PREF_NAME2 IS NOT INITIAL.
          LS_COMP-TYPE ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_NAME( <LS_PARAMS>-PREF_NAME2 ).
        ELSEIF <LS_PARAMS>-PDOM IS NOT INITIAL.
          LS_COMP-TYPE ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_NAME( <LS_PARAMS>-PDOM ).

        ELSEIF <LS_PARAMS>-PDATTYP IS NOT INITIAL AND
               <LS_PARAMS>-PDATLEN IS NOT INITIAL.

        ELSE.

        ENDIF.


        APPEND LS_COMP TO LT_COMP_TAB.

        APPEND INITIAL LINE TO <FS_ECATT_DEFINES>-FIELDCATALOG ASSIGNING <FS_FIELDCATALOG>.
        <FS_FIELDCATALOG>-COL_POS = SY-TABIX * 10 + L_COL_POS.
        <FS_FIELDCATALOG>-FIELDNAME = <LS_PARAMS>-PNAME.

        CASE <LS_PARAMS>-PNAME.
          WHEN 'I_MATNR' OR 'I_BP_KUNNR' OR 'I_BP_LIFNR'.
            <FS_FIELDCATALOG>-COL_POS = 20.
          WHEN 'I_GROUPING'.
            <FS_FIELDCATALOG>-COL_POS = 25.
        ENDCASE.
        <FS_FIELDCATALOG>-INTTYPE  = <LS_PARAMS>-PINTTYP.
        <FS_FIELDCATALOG>-INTLEN   = <LS_PARAMS>-PINTLEN.
        <FS_FIELDCATALOG>-ROLLNAME = <LS_PARAMS>-PDOM.
*        <FS_FIELDCATALOG>-OUTPUTLEN = COND #( WHEN <FS_FIELDCATALOG>-INTLEN > C_SIZE THEN C_SIZE ELSE <FS_FIELDCATALOG>-INTLEN ).
        <FS_FIELDCATALOG>-COLTEXT    = <LS_PARAMS>-PNAME. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = <LS_PARAMS>-PNAME.
        <FS_FIELDCATALOG>-REPTEXT    = <LS_PARAMS>-PNAME. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = <LS_PARAMS>-PNAME.
        <FS_FIELDCATALOG>-SCRTEXT_L  = <LS_PARAMS>-PNAME. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = <LS_PARAMS>-PNAME.
        <FS_FIELDCATALOG>-SELTEXT    = <LS_PARAMS>-PDESC.
        <FS_FIELDCATALOG>-DATATYPE   = <LS_PARAMS>-PDATTYP.
        <FS_FIELDCATALOG>-OUTPUTLEN  = <LS_PARAMS>-PDATLEN.
        <FS_FIELDCATALOG>-COL_OPT    = 'A'.
        <FS_FIELDCATALOG>-DECIMALS_O = <LS_PARAMS>-PDECIMALS.
        <FS_FIELDCATALOG>-DECIMALS   = <LS_PARAMS>-PDECIMALS.
      ENDLOOP.

*      L_COL_POS += LINES( <FS_ECATT_DEFINES>-FIELDCATALOG ) * 10.
*      APPEND INITIAL LINE TO <FS_ECATT_DEFINES>-FIELDCATALOG ASSIGNING <FS_FIELDCATALOG>.
*      <FS_FIELDCATALOG>-FIELDNAME = MC_FIELD_TABCOL.
*      <FS_FIELDCATALOG>-COL_POS = L_COL_POS.
*      <FS_FIELDCATALOG>-INTTYPE = 'C'.  <FS_FIELDCATALOG>-INTLEN = &2.
*      <FS_FIELDCATALOG>-SCRTEXT_L = &1. "<FS_FIELDCATALOG>-SCRTEXT_M = <FS_FIELDCATALOG>-SCRTEXT_S = &1.
*      <FS_FIELDCATALOG>-OUTPUTLEN = COND #( WHEN <FS_FIELDCATALOG>-INTLEN > C_SIZE THEN C_SIZE ELSE <FS_FIELDCATALOG>-INTLEN ).
*      LS_COMP-NAME = <FS_FIELDCATALOG>-FIELDNAME.
*      LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_C( P_LENGTH = CONV #( <FS_FIELDCATALOG>-INTLEN ) ).
*      APPEND LS_COMP TO LT_COMP_TAB.
      LS_COMP-NAME = MC_FIELD_TABCOL.
      LS_COMP-TYPE ?= CL_ABAP_TABLEDESCR=>DESCRIBE_BY_NAME( P_NAME = 'LVC_T_SCOL' ).
      APPEND LS_COMP TO LT_COMP_TAB.
      LO_ESTRUTURA = CL_ABAP_STRUCTDESCR=>CREATE( LT_COMP_TAB ).
      LO_NEW_TAB = CL_ABAP_TABLEDESCR=>CREATE( P_LINE_TYPE  = LO_ESTRUTURA
                                               P_TABLE_KIND = CL_ABAP_TABLEDESCR=>TABLEKIND_STD
                                               P_UNIQUE     = ABAP_FALSE ).
      <FS_ECATT_DEFINES>-VARIANT_TABLEDESCR = LO_NEW_TAB.
      <FS_ECATT_DEFINES>-VARIANT_STRUCTDESCR = LO_ESTRUTURA.
      <FS_ECATT_DEFINES>-P4_INSTANCE = MO_P4_INSTANCE.
    ENDIF.

    CREATE DATA <FS_ECATT_DEFINES>-VARIANT_CONTENT TYPE HANDLE <FS_ECATT_DEFINES>-VARIANT_TABLEDESCR.
    ASSIGN <FS_ECATT_DEFINES>-VARIANT_CONTENT->* TO <FT_VARIANT_CONTENT>.

    LOOP AT <FS_ECATT_DEFINES>-P4_FILE INTO DATA(LS_P4_FILE).
      LOOP AT LS_P4_FILE-PME ASSIGNING FIELD-SYMBOL(<FS_PME>).
        AT NEW VARIANT_ID.
          APPEND INITIAL LINE TO <FT_VARIANT_CONTENT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT>).

          <FS_VARIANT_CONTENT>-(MC_FIELD_VARIANT) = <FS_PME>-VARIANT_ID.
          <FS_VARIANT_CONTENT>-(MC_FIELD_VARIANT_DESC) = <FS_PME>-VARIANT_DESC.
          <FS_VARIANT_CONTENT>-(MC_FIELD_SOLUID) = <FS_PME>-SOLUID.
          <FS_VARIANT_CONTENT>-(MC_FIELD_BBID) = LS_P4_FILE-BBID.
          <FS_VARIANT_CONTENT>-(MC_FIELD_LAND1) = LS_P4_FILE-LAND1.
          <FS_VARIANT_CONTENT>-(MC_FIELD_FILENAME) = <FS_PME>-FILENAME.
        ENDAT.

        READ TABLE <FS_ECATT_DEFINES>-PARAMS ASSIGNING <LS_PARAMS> WITH KEY PNAME = <FS_PME>-PARAM_NAME.
        IF SY-SUBRC = 0.
          ASSIGN COMPONENT <FS_PME>-PARAM_NAME OF STRUCTURE <FS_VARIANT_CONTENT> TO FIELD-SYMBOL(<F_VALUE>).
          IF SY-SUBRC = 0.
            CASE <LS_PARAMS>-PINTTYP.
              WHEN 'C'.
                <F_VALUE> = <FS_PME>-VALUE.
              WHEN 'D'.
                IF <FS_PME>-VALUE+2(1) = '.'.
                  <F_VALUE>+0(4) = <FS_PME>-VALUE+6(4).
                  <F_VALUE>+4(2) = <FS_PME>-VALUE+3(2).
                  <F_VALUE>+6(2) = <FS_PME>-VALUE+0(2).
                ELSEIF <FS_PME>-VALUE+4(1) = '.'.
                  <F_VALUE>+0(4) = <FS_PME>-VALUE+0(4).
                  <F_VALUE>+4(2) = <FS_PME>-VALUE+5(2).
                  <F_VALUE>+6(2) = <FS_PME>-VALUE+7(2).
                ELSE.
                  <F_VALUE> = <FS_PME>-VALUE.
                ENDIF.
              WHEN OTHERS.
                TRY.
                    <F_VALUE> = <FS_PME>-VALUE.
                  CATCH CX_SY_CONVERSION_NO_NUMBER.
                    DATA: L_STR_VALUE TYPE C LENGTH 255,
                          L_STR_LEN   TYPE I.
                    L_STR_VALUE = <FS_PME>-VALUE.
                    TRANSLATE L_STR_VALUE USING '. '.
                    TRANSLATE L_STR_VALUE USING ',.'.
                    CONDENSE L_STR_VALUE NO-GAPS.
                    L_STR_LEN = STRLEN( L_STR_VALUE ) - 1.
                    IF L_STR_VALUE+L_STR_LEN(1) = '-'.
                      L_STR_VALUE+L_STR_LEN(1) = ''.
                      CONCATENATE '-' L_STR_VALUE INTO L_STR_VALUE.
                      CONDENSE L_STR_VALUE NO-GAPS.
                    ENDIF.
                    <F_VALUE> = L_STR_VALUE.
                ENDTRY.
            ENDCASE.
          ENDIF.
        ENDIF.

        TRY.
            IF <FS_PME>-TDC_ID IS NOT INITIAL.
              READ TABLE <FS_ECATT_DEFINES>-TDC_DEFINE ASSIGNING FIELD-SYMBOL(<FS_TDC_DEFINE>) WITH KEY PARAM_NAME = <FS_PME>-PARAM_NAME.
              IF SY-SUBRC <> 0.
                APPEND INITIAL LINE TO <FS_ECATT_DEFINES>-TDC_DEFINE ASSIGNING <FS_TDC_DEFINE>.
                <FS_TDC_DEFINE>-PARAM_NAME = <FS_PME>-PARAM_NAME.
                <FS_TDC_DEFINE>-TDC_PARAM_NAME = <FS_PME>-TDC_PARAM_NAME.
                <FS_TDC_DEFINE>-TDC_NAME = <FS_PME>-TDC_ID.
                /SMB/CL_TDC_REFERENCE=>GET(
                  RECEIVING
                    RO_INSTANCE = DATA(LO_INSTANCE) " TDC reference
                ).
                LO_INSTANCE->GET_TDC_DATA_BY_OBJECT(
                  EXPORTING
                    IV_TDC_NAME = <FS_TDC_DEFINE>-TDC_NAME " eCATT Object
                  IMPORTING
                    EV_FILENAME = <FS_TDC_DEFINE>-FILENAME " eCATT External Variants - File Name
                    EV_TITLE    = <FS_TDC_DEFINE>-TITLE    " eCATT Object Attributes: Title
                    EV_EXT_MODE = <FS_TDC_DEFINE>-EXT_MODE " eCATT Mode Usage of External Variants
                    EV_ALIAS    = <FS_TDC_DEFINE>-ALIAS    " Alias for a Test Data Container
                ).
              ENDIF.
            ENDIF.
          CATCH /SMB/CX_DEFINITION.

        ENDTRY.

      ENDLOOP.
    ENDLOOP.

  ENDMETHOD.

  METHOD FILL_ECATT_DEFINE.
    DATA: L_HIERARCHY_HEADER   TYPE TREEV_HHDR,
          LS_LAYOUT_NODE       TYPE LVC_S_LAYN,
          L_RELAT_NODE_KEY     TYPE LVC_NKEY,
          L_NODE_IMAGE         TYPE TV_IMAGE,
          LT_FIELDCATALOG      TYPE LVC_T_FCAT,
          L_NEW_NODE_KEY       TYPE LVC_NKEY,
          L_OUTPUT_LINE        TYPE LCL_TYPE_DEFINE=>TYP_OPTION_FIELDS,
          LT_CHILDREN          TYPE LVC_T_NKEY,
          LT_OPTION_FIELDS_MEM TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS,
          LS_NODE_LAYOUT       TYPE LVC_S_LAYN.

    CHECK I_ECATT IS NOT INITIAL AND I_ECATT <> ML_ECATT.
    ML_ECATT = I_ECATT.

    CALL METHOD RESET_TREE_REP_RULE( ).

    IMPORT OPTION_FIELDS = LT_OPTION_FIELDS_MEM
    FROM DATABASE ZSBINDX(BP) ID ML_ECATT
    IGNORING STRUCTURE BOUNDARIES
    IGNORING CONVERSION ERRORS.

    LOOP AT MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WHERE ECATT = ML_ECATT.
      LOOP AT <FS_ECATT_DEFINES>-PARAMS ASSIGNING FIELD-SYMBOL(<FS_PARAMS>).
        READ TABLE LT_OPTION_FIELDS_MEM ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES_MEM>)
          WITH KEY ECATT = ML_ECATT FIELDNAME = <FS_PARAMS>-PNAME.
        IF SY-SUBRC <> 0 OR <FS_ECATT_DEFINES_MEM>-OPTION IS INITIAL.
          L_RELAT_NODE_KEY = ML_COPY_DIRECTLY_KEY.
*          LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED.
        ELSE.
          CASE <FS_ECATT_DEFINES_MEM>-OPTION.
              "          	WHEN COPY_DIRECTLY.
              "              L_RELAT_NODE_KEY = MC_COPY_DIRECTLY_KEY.
*            WHEN LCL_TYPE_DEFINE=>BY_RULE.
*              L_RELAT_NODE_KEY = ML_COPY_BY_RULE_KEY.
*              LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_A.
*            WHEN LCL_TYPE_DEFINE=>USER_INPUT.
*              L_RELAT_NODE_KEY = ML_COPY_USER_INPUT_KEY.
*              LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_B.
            WHEN LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
              L_RELAT_NODE_KEY = ML_SUGGEST_BY_AI_KEY.
*              LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_C.
            WHEN OTHERS.
              L_RELAT_NODE_KEY = ML_COPY_DIRECTLY_KEY.
*              LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED.
          ENDCASE.
        ENDIF.

        MO_TREE_REP_RULE->ADD_NODE(
          EXPORTING
            I_RELAT_NODE_KEY     = L_RELAT_NODE_KEY " Node Already in Tree Hierarchy
            I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
*           IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
            IS_NODE_LAYOUT       = LS_NODE_LAYOUT   " Node Layout
*           IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
            I_NODE_TEXT          = CONV #( <FS_PARAMS>-PNAME )  " Hierarchy Node Text
          IMPORTING
            E_NEW_NODE_KEY       = L_NEW_NODE_KEY   " Key of New Node Key
          EXCEPTIONS
            RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
            NODE_NOT_FOUND       = 2                " Node not Found
        ).
        IF SY-SUBRC <> 0.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

        CALL METHOD MO_TREE_REP_RULE->GET_OUTTAB_LINE
          EXPORTING
            I_NODE_KEY     = L_NEW_NODE_KEY " Node Key
          IMPORTING
            E_OUTTAB_LINE  = L_OUTPUT_LINE    " Line of Outtab
*           e_node_text    =                  " node text
*           et_item_layout =                  " Layout structure for items of the ALV tree control
*           es_node_layout =                  " Node Layout of ALV Tree Control
          EXCEPTIONS
            NODE_NOT_FOUND = 1                " Node does not exist
            OTHERS         = 2.
        IF SY-SUBRC <> 0.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

        L_OUTPUT_LINE-ECATT = ML_ECATT.
        L_OUTPUT_LINE-FIELDNAME = <FS_PARAMS>-PNAME.
        L_OUTPUT_LINE-DESCRIPTION = <FS_PARAMS>-PDESC.
        L_OUTPUT_LINE-RELAT_NODE_KEY = L_RELAT_NODE_KEY.
        L_OUTPUT_LINE-NODE_KEY = L_NEW_NODE_KEY.

        CASE L_RELAT_NODE_KEY.
          WHEN ML_COPY_DIRECTLY_KEY.
            L_OUTPUT_LINE-OPTION = LCL_TYPE_DEFINE=>COPY_DIRECTLY.
*          WHEN ML_COPY_BY_RULE_KEY.
*            L_OUTPUT_LINE-OPTION = LCL_TYPE_DEFINE=>BY_RULE.
*          WHEN ML_COPY_USER_INPUT_KEY.
*            L_OUTPUT_LINE-OPTION = LCL_TYPE_DEFINE=>USER_INPUT.
          WHEN ML_SUGGEST_BY_AI_KEY.
            L_OUTPUT_LINE-OPTION = LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
          WHEN OTHERS.
        ENDCASE.

        CALL METHOD MO_TREE_REP_RULE->CHANGE_NODE(
          EXPORTING
            I_NODE_KEY     = L_NEW_NODE_KEY " Key of Changed Line
            I_OUTTAB_LINE  = L_OUTPUT_LINE  " Outtab Line to be Changed
*           IS_NODE_LAYOUT = IS_NODE_LAYOUT " Node Layout
*           IT_ITEM_LAYOUT = IT_ITEM_LAYOUT " Item Layout
*           I_NODE_TEXT    = I_NODE_TEXT    " Node Text
*           I_U_NODE_TEXT  = I_U_NODE_TEXT  " 'X': Change Node Text
          EXCEPTIONS
            NODE_NOT_FOUND = 1              " Node does not exist
        ).
        IF SY-SUBRC <> 0.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

    CALL METHOD MO_TREE_REP_RULE->FRONTEND_UPDATE( ).
  ENDMETHOD.

  METHOD HANDLE_ECATT_DEFINE_DB_CLICK.
    READ TABLE MT_OPTION_FIELDS ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS>) WITH KEY NODE_KEY = NODE_KEY.
    IF SY-SUBRC = 0  AND <FS_OPTION_FIELDS>-FIELDNAME+0(2) = 'I_'.
      MO_VARIANT_CONTENT->SET_SCROLL_INFO_VIA_ID(
*        IS_ROW_INFO = IS_ROW_INFO " Row ID
        IS_COL_INFO = VALUE LVC_S_COL( FIELDNAME = <FS_OPTION_FIELDS>-FIELDNAME ) " Column ID
*       IS_ROW_NO   = IS_ROW_NO   " Numeric Row ID
      ).
    ENDIF.
  ENDMETHOD.

  METHOD HANDLE_NODE_CM_REQ.
*   In this case the standard menu is cleared.
    CALL METHOD MENU->CLEAR.
*   The next line defines one line of the context menu.
    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = MC_COPY_DIRECTLY_CODE
        TEXT  = CONV GUI_TEXT( MC_COPY_DIRECTLY ).

*    CALL METHOD MENU->ADD_FUNCTION
*      EXPORTING
*        FCODE = MC_COPY_BY_RULE_CODE
*        TEXT  = CONV GUI_TEXT( MC_COPY_BY_RULE ).
*
*    CALL METHOD MENU->ADD_FUNCTION
*      EXPORTING
*        FCODE = MC_USER_INPUT_CODE
*        TEXT  = CONV GUI_TEXT( MC_USER_INPUT ).

    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = MC_BY_AI_CODE
        TEXT  = CONV GUI_TEXT( MC_BY_AI ).

  ENDMETHOD.

  METHOD HANDLE_NODE_CM_SEL.

    DATA: LS_OUTTAB_LINE   TYPE LCL_TYPE_DEFINE=>TYP_OPTION_FIELDS,
          LS_NODE_LAYOUT   TYPE LVC_S_LAYN,
          LS_NODE_LAYOUT_C TYPE LVC_S_LACN,
          L_RELATKEY       TYPE LVC_NKEY,
          L_OPTION         TYPE LCL_TYPE_DEFINE=>OPERTION_TYPE.

    MO_TREE_REP_RULE->GET_OUTTAB_LINE(
      EXPORTING
        I_NODE_KEY     = NODE_KEY     " Node Key
      IMPORTING
        E_OUTTAB_LINE  = LS_OUTTAB_LINE  " Line of Outtab
*       E_NODE_TEXT    = E_NODE_TEXT    " node text
*       ET_ITEM_LAYOUT = ET_ITEM_LAYOUT " Layout structure for items of the ALV tree control
        ES_NODE_LAYOUT = LS_NODE_LAYOUT " Node Layout of ALV Tree Control
      EXCEPTIONS
        NODE_NOT_FOUND = 1              " Node does not exist
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
        WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    CASE FCODE.
      WHEN MC_COPY_DIRECTLY_CODE.
        L_RELATKEY = ML_COPY_DIRECTLY_KEY.
        L_OPTION = LCL_TYPE_DEFINE=>COPY_DIRECTLY.
*        LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED.
*      WHEN MC_COPY_BY_RULE_CODE.
*        L_RELATKEY = ML_COPY_BY_RULE_KEY.
*        L_OPTION = LCL_TYPE_DEFINE=>BY_RULE.
*        LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_A.
*      WHEN MC_USER_INPUT_CODE.
*        L_RELATKEY = ML_COPY_USER_INPUT_KEY.
*        L_OPTION = LCL_TYPE_DEFINE=>USER_INPUT.
*        LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_B.
      WHEN MC_BY_AI_CODE.
        L_RELATKEY = ML_SUGGEST_BY_AI_KEY.
        L_OPTION = LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
*        LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_C.
    ENDCASE.

    IF L_OPTION <> LS_OUTTAB_LINE-OPTION.

      MO_TREE_REP_RULE->MOVE_NODE(
        EXPORTING
          I_NODE_KEY         = NODE_KEY  " ALV Tree Control: Node Key
          I_RELATKEY         = L_RELATKEY  " ALV Tree Control: Node Key
          I_RELATSHIP        = CL_GUI_COLUMN_TREE=>RELAT_FIRST_CHILD " Natural Number
        EXCEPTIONS
          NODE_NOT_FOUND     = 1           " Node With Key NODE_KEY Does Not Exist
          RELATIVE_NOT_FOUND = 2           " Unable To Find Node With Key RELAT_KEY
      ).
      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      LS_OUTTAB_LINE-RELAT_NODE_KEY = L_RELATKEY.
      LS_OUTTAB_LINE-OPTION = L_OPTION.

      MOVE-CORRESPONDING LS_NODE_LAYOUT TO LS_NODE_LAYOUT_C.
      LS_NODE_LAYOUT_C-U_STYLE = ABAP_TRUE.

      MO_TREE_REP_RULE->CHANGE_NODE(
        EXPORTING
          I_NODE_KEY     = NODE_KEY     " Key of Changed Line
          I_OUTTAB_LINE  = LS_OUTTAB_LINE  " Outtab Line to be Changed
          IS_NODE_LAYOUT = LS_NODE_LAYOUT_C " Node Layout
*         IT_ITEM_LAYOUT = IT_ITEM_LAYOUT " Item Layout
*         I_NODE_TEXT    = I_NODE_TEXT    " Node Text
*         I_U_NODE_TEXT  = I_U_NODE_TEXT  " 'X': Change Node Text
        EXCEPTIONS
          NODE_NOT_FOUND = 1              " Node does not exist
      ).
      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
    ENDIF.

    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = ML_ECATT.
    IF SY-SUBRC = 0.
      CALL METHOD FILL_TBLCOLOR
        CHANGING
          CS_ECATT_DEFINES = <FS_ECATT_DEFINES>.

      CALL METHOD MO_VARIANT_CONTENT->REFRESH_TABLE_DISPLAY(
        EXPORTING
          IS_STABLE = VALUE LVC_S_STBL( ROW = ABAP_TRUE COL = ABAP_TRUE )      " With Stable Rows/Columns
*         I_SOFT_REFRESH = I_SOFT_REFRESH " Without Sort, Filter, etc.
        EXCEPTIONS
          FINISHED  = 1              " Display was Ended (by Export)
      ).
    ENDIF.


    CALL METHOD MO_TREE_REP_RULE->FRONTEND_UPDATE( ).

  ENDMETHOD.

  METHOD PROMPT_EDITOR.
    DATA: LT_SYSTEM_ROLE TYPE STANDARD TABLE OF STRING,
          LS_INDX        TYPE INDX,
          L_PROMPTFILE   TYPE STRING.
    L_PROMPTFILE = 'c:\tmp\BP_AI\Prompt\MD_GEN_O001.txt' .

    IF SY-UNAME = 'MAOZH'.
      " 暂时从本地读取Prompt文本
      CL_GUI_FRONTEND_SERVICES=>FILE_EXIST(
        EXPORTING
          FILE                 = L_PROMPTFILE   " File to Check
        RECEIVING
          RESULT               = DATA(L_RESULT) " Result
        EXCEPTIONS
          CNTL_ERROR           = 1      " Control error
          ERROR_NO_GUI         = 2      " Error: No GUI
          WRONG_PARAMETER      = 3      " Incorrect parameter
          NOT_SUPPORTED_BY_GUI = 4      " GUI does not support this
      ).
      IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      IF L_RESULT = ABAP_TRUE .
        CL_GUI_FRONTEND_SERVICES=>GUI_UPLOAD(
          EXPORTING
            FILENAME                = L_PROMPTFILE       " Name of file
*           FILETYPE                = 'ASC'              " File Type (ASCII, Binary)
*           HAS_FIELD_SEPARATOR     = SPACE              " Columns Separated by Tabs in Case of ASCII Upload
*           HEADER_LENGTH           = 0                  " Length of Header for Binary Data
*           READ_BY_LINE            = 'X'                " File Written Line-By-Line to the Internal Table
*           DAT_MODE                = SPACE              " Numeric and date fields are in DAT format in WS_DOWNLOAD
*           CODEPAGE                = CODEPAGE           " Character Representation for Output
*           IGNORE_CERR             = ABAP_TRUE          " Ignore character set conversion errors?
*           REPLACEMENT             = '#'                " Replacement Character for Non-Convertible Characters
*           VIRUS_SCAN_PROFILE      = VIRUS_SCAN_PROFILE " Virus Scan Profile
*      IMPORTING
*           FILELENGTH              = FILELENGTH         " File Length
*           HEADER                  = HEADER             " File Header in Case of Binary Upload
          CHANGING
            DATA_TAB                = LT_SYSTEM_ROLE           " Transfer table for file contents
*           ISSCANPERFORMED         = SPACE              " File already scanned
          EXCEPTIONS
            FILE_OPEN_ERROR         = 1                  " File does not exist and cannot be opened
            FILE_READ_ERROR         = 2                  " Error when reading file
            NO_BATCH                = 3                  " Cannot execute front-end function in background
            GUI_REFUSE_FILETRANSFER = 4                  " Incorrect front end or error on front end
            INVALID_TYPE            = 5                  " Incorrect parameter FILETYPE
            NO_AUTHORITY            = 6                  " No upload authorization
            UNKNOWN_ERROR           = 7                  " Unknown error
            BAD_DATA_FORMAT         = 8                  " Cannot Interpret Data in File
            HEADER_NOT_ALLOWED      = 9                  " Invalid header
            SEPARATOR_NOT_ALLOWED   = 10                 " Invalid separator
            HEADER_TOO_LONG         = 11                 " Header information currently restricted to 1023 bytes
            UNKNOWN_DP_ERROR        = 12                 " Error when calling data provider
            ACCESS_DENIED           = 13                 " Access to File Denied
            DP_OUT_OF_MEMORY        = 14                 " Not enough memory in data provider
            DISK_FULL               = 15                 " Storage medium is full.
            DP_TIMEOUT              = 16                 " Data provider timeout
            NOT_SUPPORTED_BY_GUI    = 17                 " GUI does not support this
            ERROR_NO_GUI            = 18                 " GUI not available
        ).
        IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.


        LS_INDX-AEDAT = SY-DATUM.
        LS_INDX-USERA = SY-UNAME.
        LS_INDX-PGMID = SY-REPID.
        LS_INDX-RELID = 'AI'.
        LS_INDX-SRTFD = 'GPT4o'.

        EXPORT SYSTEM_ROLE = LT_SYSTEM_ROLE
        TO DATABASE INDX(AI) ID 'PromptMD'
        FROM LS_INDX
        COMPRESSION ON.

      ENDIF.
    ENDIF.

    IMPORT SYSTEM_ROLE = LT_SYSTEM_ROLE
    FROM DATABASE INDX(AI) ID 'PromptMD' TO LS_INDX
    .

    CL_HTTP_UTILITY=>ESCAPE_HTML(
      EXPORTING
        UNESCAPED         = REDUCE #( INIT R TYPE STRING FOR L IN LT_SYSTEM_ROLE NEXT R = |{ R } { CL_ABAP_CHAR_UTILITIES=>CR_LF } { L } | )       " Unencoded String
        KEEP_NUM_CHAR_REF = ABAP_UNDEFINED " Prevent Escaping of HTML Numeric Character References?
      RECEIVING
        ESCAPED           = DATA(L_SYSTEM_ROLE)        " HTML-Encoded String
    ).
    CL_DEMO_OUTPUT=>DISPLAY_HTML( HTML = |<pre>{ L_SYSTEM_ROLE }</pre>| ).


  ENDMETHOD.

  METHOD DISTINGUISH_CATEGORIES.
    FIELD-SYMBOLS: <FT_CONTENT>  TYPE STANDARD TABLE,
                   <FS_CONTENT>  TYPE ANY,
                   <F_VALUE>     TYPE ANY,
                   <F_VALUE_NEW> TYPE ANY,
                   <FT_VALUES>   TYPE STANDARD TABLE.

    DATA: LT_OPTION_FIELDS_TMP TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS,
          L_OUTPUT_LINE        TYPE LCL_TYPE_DEFINE=>TYP_OPTION_FIELDS,
          LT_INDEX_ROWS        TYPE LVC_T_ROW,
          LT_ROW_NO            TYPE LVC_T_ROID,
          LS_COMP              TYPE CL_ABAP_STRUCTDESCR=>COMPONENT,
          LT_COMP_TAB          TYPE CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
          LO_NEW_TAB           TYPE REF TO CL_ABAP_TABLEDESCR,
          LO_ESTRUTURA         TYPE REF TO CL_ABAP_STRUCTDESCR,
          LT_VALUES            TYPE REF TO DATA,
          L_RELATKEY           TYPE LVC_NKEY,
          LS_OUTTAB_LINE       TYPE LCL_TYPE_DEFINE=>TYP_OPTION_FIELDS,
          LS_NODE_LAYOUT       TYPE LVC_S_LAYN,
          LS_NODE_LAYOUT_C     TYPE LVC_S_LACN,
          L_NEW_NODE_KEY       TYPE LVC_NKEY.


    CHECK ML_ECATT IS NOT INITIAL.
    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = ML_ECATT.
    CHECK SY-SUBRC = 0.

    ASSIGN <FS_ECATT_DEFINES>-VARIANT_CONTENT->* TO <FT_CONTENT>.

    CALL METHOD MO_VARIANT_CONTENT->GET_SELECTED_ROWS
      IMPORTING
        ET_INDEX_ROWS = LT_INDEX_ROWS " Indexes of Selected Rows
        ET_ROW_NO     = LT_ROW_NO.     " Numeric IDs of Selected Rows

    LOOP AT <FS_ECATT_DEFINES>-PARAMS ASSIGNING FIELD-SYMBOL(<LS_PARAMS>).
      REFRESH: LT_COMP_TAB.
      LS_COMP-NAME = <LS_PARAMS>-PNAME.
      LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_BY_KIND( P_TYPE_KIND = <LS_PARAMS>-PINTTYP P_LENGTH = CONV #( <LS_PARAMS>-PINTLEN ) P_DECIMALS = CONV #( <LS_PARAMS>-PDECIMALS ) ).
      APPEND LS_COMP TO LT_COMP_TAB.

      LO_ESTRUTURA = CL_ABAP_STRUCTDESCR=>CREATE( LT_COMP_TAB ).
      LO_NEW_TAB = CL_ABAP_TABLEDESCR=>CREATE( P_LINE_TYPE  = LO_ESTRUTURA
                                               P_TABLE_KIND = CL_ABAP_TABLEDESCR=>TABLEKIND_STD
                                               P_UNIQUE     = ABAP_FALSE ).
      CREATE DATA LT_VALUES TYPE HANDLE LO_NEW_TAB.
      ASSIGN LT_VALUES->* TO <FT_VALUES>.
      DATA(L_COUNT_SELECTED) = LINES( LT_ROW_NO[] ).
      LOOP AT LT_ROW_NO INTO DATA(LS_ROW_NO).
        READ TABLE <FT_CONTENT> ASSIGNING <FS_CONTENT> INDEX LS_ROW_NO-ROW_ID.
        CHECK SY-SUBRC = 0.
        ASSIGN COMPONENT <LS_PARAMS>-PNAME OF STRUCTURE <FS_CONTENT> TO <F_VALUE>.
        APPEND INITIAL LINE TO <FT_VALUES> ASSIGNING FIELD-SYMBOL(<FS_VALUES>).
        <FS_VALUES>-(<LS_PARAMS>-PNAME) = <F_VALUE>.
      ENDLOOP.

      SORT <FT_VALUES>.
      DELETE ADJACENT DUPLICATES FROM <FT_VALUES>.
      DATA(L_COUNT_VALUES) = LINES( <FT_VALUES> ).

      APPEND INITIAL LINE TO LT_OPTION_FIELDS_TMP ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS_TMP>).
      IF 1 = L_COUNT_VALUES.
        <FS_OPTION_FIELDS_TMP>-OPTION = LCL_TYPE_DEFINE=>COPY_DIRECTLY.
      ELSE.
        <FS_OPTION_FIELDS_TMP>-OPTION = LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
      ENDIF.
      <FS_OPTION_FIELDS_TMP>-ECATT = <FS_ECATT_DEFINES>-ECATT.
      <FS_OPTION_FIELDS_TMP>-FIELDNAME = <LS_PARAMS>-PNAME.
      <FS_OPTION_FIELDS_TMP>-DESCRIPTION = <LS_PARAMS>-PDESC.
    ENDLOOP.

    CALL METHOD RESET_TREE_REP_RULE( ).

    LOOP AT LT_OPTION_FIELDS_TMP ASSIGNING <FS_OPTION_FIELDS_TMP>.
      CASE <FS_OPTION_FIELDS_TMP>-OPTION.
        WHEN LCL_TYPE_DEFINE=>COPY_DIRECTLY.
          L_RELATKEY = ML_COPY_DIRECTLY_KEY.
*         LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED.
*        WHEN LCL_TYPE_DEFINE=>BY_RULE.
*          L_RELATKEY = ML_COPY_BY_RULE_KEY.
*          LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_A.
*        WHEN LCL_TYPE_DEFINE=>USER_INPUT.
*          L_RELATKEY = ML_COPY_USER_INPUT_KEY.
*          LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_B.
        WHEN LCL_TYPE_DEFINE=>SUGGEST_BY_AI.
          L_RELATKEY = ML_SUGGEST_BY_AI_KEY.
*         LS_NODE_LAYOUT-STYLE = CL_GUI_COLUMN_TREE=>STYLE_EMPHASIZED_C.
      ENDCASE.

      MO_TREE_REP_RULE->ADD_NODE(
        EXPORTING
          I_RELAT_NODE_KEY     = L_RELATKEY " Node Already in Tree Hierarchy
          I_RELATIONSHIP       = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD   " How to Insert Node
*         IS_OUTTAB_LINE       = IS_OUTTAB_LINE   " Attributes of Inserted Node
*         IS_NODE_LAYOUT       = IS_NODE_LAYOUT   " Node Layout
*         IT_ITEM_LAYOUT       = IT_ITEM_LAYOUT   " Item Layout
          I_NODE_TEXT          = CONV #( <FS_OPTION_FIELDS_TMP>-FIELDNAME )      " Hierarchy Node Text
        IMPORTING
          E_NEW_NODE_KEY       = L_NEW_NODE_KEY   " Key of New Node Key
        EXCEPTIONS
          RELAT_NODE_NOT_FOUND = 1                " Relat Node Key not Found
          NODE_NOT_FOUND       = 2                " Node not Found
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      CALL METHOD MO_TREE_REP_RULE->GET_OUTTAB_LINE
        EXPORTING
          I_NODE_KEY     = L_NEW_NODE_KEY " Node Key
        IMPORTING
          E_OUTTAB_LINE  = L_OUTPUT_LINE    " Line of Outtab
*         e_node_text    =                  " node text
*         et_item_layout =                  " Layout structure for items of the ALV tree control
*         es_node_layout =                  " Node Layout of ALV Tree Control
        EXCEPTIONS
          NODE_NOT_FOUND = 1                " Node does not exist
          OTHERS         = 2.
      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
        WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      MOVE-CORRESPONDING <FS_OPTION_FIELDS_TMP> TO L_OUTPUT_LINE.
      L_OUTPUT_LINE-RELAT_NODE_KEY = L_RELATKEY.
      L_OUTPUT_LINE-NODE_KEY = L_NEW_NODE_KEY.

      MOVE-CORRESPONDING LS_NODE_LAYOUT TO LS_NODE_LAYOUT_C.
      LS_NODE_LAYOUT_C-U_STYLE = ABAP_TRUE.

      CALL METHOD MO_TREE_REP_RULE->CHANGE_NODE(
        EXPORTING
          I_NODE_KEY     = L_NEW_NODE_KEY " Key of Changed Line
          I_OUTTAB_LINE  = L_OUTPUT_LINE  " Outtab Line to be Changed
*         IS_NODE_LAYOUT = LS_NODE_LAYOUT_C " Node Layout
*         IT_ITEM_LAYOUT = IT_ITEM_LAYOUT " Item Layout
*         I_NODE_TEXT    = I_NODE_TEXT    " Node Text
*         I_U_NODE_TEXT  = I_U_NODE_TEXT  " 'X': Change Node Text
        EXCEPTIONS
          NODE_NOT_FOUND = 1              " Node does not exist
      ).
    ENDLOOP.

    CALL METHOD FILL_TBLCOLOR(
      CHANGING
        CS_ECATT_DEFINES = <FS_ECATT_DEFINES>
    ).

    CALL METHOD MO_VARIANT_CONTENT->REFRESH_TABLE_DISPLAY(
      EXPORTING
        IS_STABLE = VALUE LVC_S_STBL( ROW = ABAP_TRUE COL = ABAP_TRUE )      " With Stable Rows/Columns
*       I_SOFT_REFRESH = I_SOFT_REFRESH " Without Sort, Filter, etc.
      EXCEPTIONS
        FINISHED  = 1              " Display was Ended (by Export)
    ).

    CALL METHOD SAVE_OPTION_FIELDS.

    CALL METHOD MO_TREE_REP_RULE->FRONTEND_UPDATE( ).

  ENDMETHOD.

  METHOD SAVE_OPTION_FIELDS.
    DATA: LT_OPTION_FIELDS_MEM TYPE LCL_TYPE_DEFINE=>TBL_OPTION_FIELDS.
    CHECK ML_ECATT IS NOT INITIAL.
    LT_OPTION_FIELDS_MEM[] = MT_OPTION_FIELDS[].

    DELETE LT_OPTION_FIELDS_MEM WHERE ECATT <> ML_ECATT OR FIELDNAME IS INITIAL.

    EXPORT OPTION_FIELDS = LT_OPTION_FIELDS_MEM
    TO DATABASE ZSBINDX(BP) ID ML_ECATT.
  ENDMETHOD.

  METHOD CHECK_VFILE.
    DATA: LO_VFILE_CREATOR TYPE REF TO LCL_VFILE_CREATOR,
          LT_INDEX_ROWS    TYPE LVC_T_ROW,
          LT_ROW_NO        TYPE LVC_T_ROID.

    CHECK ML_ECATT IS NOT INITIAL.
    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = ML_ECATT.
    CHECK SY-SUBRC = 0.

    DATA(LT_OPTION_FIELDS_TMP) = MT_OPTION_FIELDS[].
    DELETE LT_OPTION_FIELDS_TMP WHERE ECATT <> ML_ECATT OR FIELDNAME IS INITIAL.
    LOOP AT LT_OPTION_FIELDS_TMP ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS_TMP>).
      <FS_OPTION_FIELDS_TMP>-OPTION = LCL_TYPE_DEFINE=>COPY_DIRECTLY.
    ENDLOOP.

    CALL METHOD MO_VARIANT_CONTENT->GET_SELECTED_ROWS
      IMPORTING
        ET_INDEX_ROWS = LT_INDEX_ROWS " Indexes of Selected Rows
        ET_ROW_NO     = LT_ROW_NO.     " Numeric IDs of Selected Rows

    CHECK LT_ROW_NO[] IS NOT INITIAL.
    <FS_ECATT_DEFINES>-ROW_NO = LT_ROW_NO.

    LO_VFILE_CREATOR = NEW LCL_VFILE_CREATOR( ).
    LO_VFILE_CREATOR->CREATE_VFILE(
      EXPORTING
        I_TARCOUNTRY     = I_TARCOUNTRY
        I_FORMAT         = ABAP_FALSE
        I_NUMCREATE      = LINES( LT_ROW_NO )
        IT_OPTION_FIELDS = LT_OPTION_FIELDS_TMP
        IT_ROW_NO        = LT_ROW_NO
        ING_SIR_SI_ID    = ING_SIR_SI_ID
      CHANGING
        CS_ECATT_DEFINES = <FS_ECATT_DEFINES>
    ).
  ENDMETHOD.
**********************************************************************
* 根据不同过的ecatt需要提供不同prompt
* 不同字段的处理方式不一样，需要特别是IBAN字段，需要按不同国家特殊处理
**********************************************************************
  METHOD CREATE_VFILE.

    DATA: LO_VFILE_CREATOR TYPE REF TO LCL_VFILE_CREATOR,
          LT_INDEX_ROWS    TYPE LVC_T_ROW,
          LT_ROW_NO        TYPE LVC_T_ROID.

    CHECK ML_ECATT IS NOT INITIAL.
    READ TABLE MT_ECATT_DEFINES ASSIGNING FIELD-SYMBOL(<FS_ECATT_DEFINES>) WITH KEY ECATT = ML_ECATT.
    CHECK SY-SUBRC = 0.

    DATA(LT_OPTION_FIELDS_TMP) = MT_OPTION_FIELDS[].
    DELETE LT_OPTION_FIELDS_TMP WHERE ECATT <> ML_ECATT OR FIELDNAME IS INITIAL.

    CALL METHOD MO_VARIANT_CONTENT->GET_SELECTED_ROWS
      IMPORTING
        ET_INDEX_ROWS = LT_INDEX_ROWS " Indexes of Selected Rows
        ET_ROW_NO     = LT_ROW_NO.     " Numeric IDs of Selected Rows

    IF LINES( LT_ROW_NO ) > 20.
      MESSAGE S001(00) WITH 'Please don''t more than 20 sample data entries.' DISPLAY LIKE 'E'.
      RETURN.
    ENDIF.

    <FS_ECATT_DEFINES>-ROW_NO = LT_ROW_NO.

    CHECK LT_ROW_NO[] IS NOT INITIAL.

    LO_VFILE_CREATOR = NEW LCL_VFILE_CREATOR( ).
    LO_VFILE_CREATOR->CREATE_VFILE(
      EXPORTING
        I_TARCOUNTRY     = I_TARCOUNTRY
        I_FORMAT         = I_FORMAT
        I_NUMCREATE      = I_NUMCREATE
        IT_OPTION_FIELDS = LT_OPTION_FIELDS_TMP
        IT_ROW_NO        = LT_ROW_NO
        ING_SIR_SI_ID    = ING_SIR_SI_ID
      CHANGING
        CS_ECATT_DEFINES = <FS_ECATT_DEFINES>
    ).
  ENDMETHOD.

ENDCLASS.

*CLASS LCL_MM_CREATOR IMPLEMENTATION.
*
*  METHOD CONSTRUCTOR.
*  ENDMETHOD.
*
*  METHOD INIT_RULE.
*
*    LCL_RULE_PROCESS=>INIT_RULE( ).
*
*
*  ENDMETHOD.
*
*  METHOD ASSIGN_FIELDS_BY_RULE.
*    LOOP AT IT_OPTION_FIELDS ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS>)." WHERE OPTION  = SUGGEST_BY_AI.
*      READ TABLE IS_ECATT_DEFINES-PARAMS INTO DATA(LS_PARAMS) WITH KEY PNAME = <FS_OPTION_FIELDS>-FIELDNAME.
*      CHECK SY-SUBRC = 0.
*
*      LCL_RULE_PROCESS=>ADD_FIELD(
*        I_OPERTION_TYPE = <FS_OPTION_FIELDS>-OPTION
*        IS_FIELD        = LS_PARAMS
*      ).
*
*    ENDLOOP.
*  ENDMETHOD.
*
*  METHOD PROCESS_RULE.
*    LCL_RULE_PROCESS=>PROCESS_RULE(
*      CHANGING
*        CS_ECATT_DEFINES = CS_ECATT_DEFINES
*    ).
*  ENDMETHOD.
*
*  METHOD COPY_CONTENT_TO_NEW_TABLE.
*    FIELD-SYMBOLS: <FT_CONTENT>     TYPE STANDARD TABLE,
*                   <FS_CONTENT>     TYPE ANY,
*                   <FT_CONTENT_NEW> TYPE STANDARD TABLE,
*                   <FS_CONTENT_NEW> TYPE ANY.
*
*    DATA: L_IDX          TYPE I.
*
*    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT->* TO <FT_CONTENT>.
*
*    IF CS_ECATT_DEFINES-VARIANT_CONTENT_NEW IS NOT INITIAL.
*      FREE CS_ECATT_DEFINES-VARIANT_CONTENT_NEW.
*    ENDIF.
*
*    CREATE DATA CS_ECATT_DEFINES-VARIANT_CONTENT_NEW TYPE HANDLE CS_ECATT_DEFINES-VARIANT_TABLEDESCR.
*    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_CONTENT_NEW>.
*
*
*    L_IDX = 0.
*    DO I_NUMCREATE TIMES.
*      IF L_IDX >= LINES( IT_ROW_NO ).
*        L_IDX = 0.
*      ENDIF.
*      ADD 1 TO L_IDX.
*      READ TABLE IT_ROW_NO INTO DATA(LS_ROW_NO) INDEX L_IDX.
*      READ TABLE <FT_CONTENT> ASSIGNING <FS_CONTENT> INDEX LS_ROW_NO-ROW_ID.
*      CHECK SY-SUBRC = 0.
*      APPEND INITIAL LINE TO <FT_CONTENT_NEW> ASSIGNING <FS_CONTENT_NEW>.
*
*      MOVE-CORRESPONDING <FS_CONTENT> TO <FS_CONTENT_NEW>.
*    ENDDO.
*  ENDMETHOD.
***********************************************************************
** 根据不同过的ecatt需要提供不同prompt
** 不同字段的处理方式不一样，需要特别是IBAN字段，需要按不同国家特殊处理
***********************************************************************
*  METHOD CREATE_MM_VFILE.
*    FIELD-SYMBOLS: <FT_CONTENT>     TYPE STANDARD TABLE,
*                   <FS_CONTENT>     TYPE ANY,
*                   <F_VALUE>        TYPE ANY,
*                   <FT_CONTENT_NEW> TYPE STANDARD TABLE,
*                   <FS_CONTENT_NEW> TYPE ANY,
*                   <F_VALUE_NEW>    TYPE ANY,
*                   <FT_AI_VALUES>   TYPE STANDARD TABLE,
*                   <FS_AI_VALUES>   TYPE ANY,
*                   <F_AI_VALUE>     TYPE ANY.
*
*    DATA: LC_RULE_PROCESSER   TYPE REF TO LCL_RULE,
*          VARIANT_CONTENT_NEW TYPE REF TO DATA,
*
*          LO_NEW_TAB          TYPE REF TO CL_ABAP_TABLEDESCR,
*          LO_ESTRUTURA        TYPE REF TO CL_ABAP_STRUCTDESCR,
*          LT_AI_VALUES        TYPE REF TO DATA,
*          LT_FIELD_EXPLAINS   TYPE ETPAR_GUI_TABTYPE.
*
*    CS_ECATT_DEFINES-TARCOUNTRY = I_TARCOUNTRY.
*    CS_ECATT_DEFINES-NUMCREATE = I_NUMCREATE.
*    CS_ECATT_DEFINES-FORMAT = I_FORMAT.
*    CS_ECATT_DEFINES-RNG_SIR_SI_ID = ING_SIR_SI_ID.
*    CLEAR CS_ECATT_DEFINES-AI_ANSWER.
*
*    INIT_RULE( ).
*
*    " 按预定规则分配字段
*    ASSIGN_FIELDS_BY_RULE(
*      EXPORTING
*        IS_ECATT_DEFINES = CS_ECATT_DEFINES
*        IT_OPTION_FIELDS = IT_OPTION_FIELDS
*    ).
*
*    COPY_CONTENT_TO_NEW_TABLE(
*      EXPORTING
*        IT_ROW_NO        = IT_ROW_NO
*        I_NUMCREATE      = I_NUMCREATE
*      CHANGING
*        CS_ECATT_DEFINES = CS_ECATT_DEFINES
*    ).
*
*    " 按规则处理新的content
*    PROCESS_RULE(
*      CHANGING
*        CS_ECATT_DEFINES = CS_ECATT_DEFINES
*    ).
*
*    NEW LCL_NEW_MM_TESTER( )->SHOW_NEW_MM_VFILE(
*      CHANGING
*        CS_ECATT_DEFINES = CS_ECATT_DEFINES
*    ).
*  ENDMETHOD.
*ENDCLASS.

*CLASS LCL_NEW_MM_TESTER IMPLEMENTATION.
*  METHOD ON_HANDLE_TOOLBAR.
*
*    DATA: LS_TOOLBAR  TYPE STB_BUTTON.
*
** append a separator to normal toolbar
*    CLEAR LS_TOOLBAR.
*    MOVE 3 TO LS_TOOLBAR-BUTN_TYPE.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*    CLEAR LS_TOOLBAR.
*    MOVE GC_AIBP_HIDE_COL TO LS_TOOLBAR-FUNCTION.
*    IF M_HIDE = ABAP_FALSE.
*      MOVE ICON_COLLAPSE TO LS_TOOLBAR-ICON.
*      MOVE 'Hide empty col' TO LS_TOOLBAR-QUICKINFO.
*    ELSE.
*      MOVE ICON_EXPAND TO LS_TOOLBAR-ICON.
*      MOVE 'All col' TO LS_TOOLBAR-QUICKINFO.
*    ENDIF.
*
*    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
*    MOVE ' ' TO LS_TOOLBAR-DISABLED.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*    CLEAR LS_TOOLBAR.
*    MOVE GC_AIBP_DOWNLOAD TO LS_TOOLBAR-FUNCTION.
*    MOVE ICON_CLOUD_DOWNLOAD TO LS_TOOLBAR-ICON.
*    MOVE 'Download V-File' TO LS_TOOLBAR-QUICKINFO.
*    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
*    MOVE ' ' TO LS_TOOLBAR-DISABLED.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*
*    IF MS_ECATT_DEFINES-ECATT CO 'MM01' OR
*       MS_ECATT_DEFINES-ECATT CO 'MARA'.
*      CLEAR LS_TOOLBAR.
*      MOVE GC_AIBP_TEST_RUN TO LS_TOOLBAR-FUNCTION.
*      MOVE ICON_TEST TO LS_TOOLBAR-ICON.
*      LS_TOOLBAR-QUICKINFO = |New "{ MS_ECATT_DEFINES-TARCOUNTRY }_*".|.
*      MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
*      MOVE ' ' TO LS_TOOLBAR-DISABLED.
*      APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*    ENDIF.
*
*    CLEAR LS_TOOLBAR.
*    MOVE GC_AIBP_EXEC_RUN TO LS_TOOLBAR-FUNCTION.
*    MOVE ICON_EXECUTE_OBJECT TO LS_TOOLBAR-ICON.
*    MOVE 'Run MM ECATT' TO LS_TOOLBAR-QUICKINFO.
*    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
*    MOVE ' ' TO LS_TOOLBAR-DISABLED.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*    CLEAR LS_TOOLBAR.
*    MOVE GC_AIBP_DEBUG_RUN TO LS_TOOLBAR-FUNCTION.
*    MOVE ICON_DEBUGGER_STEP_INTO TO LS_TOOLBAR-ICON.
*    MOVE 'Debug MM ECATT' TO LS_TOOLBAR-QUICKINFO.
*    LS_TOOLBAR-TEXT = COND STRING( WHEN M_DEBUG = ABAP_TRUE THEN 'Debug On' ELSE 'Debug OFF' ).
*    MOVE ' ' TO LS_TOOLBAR-DISABLED.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*    CLEAR LS_TOOLBAR.
*    MOVE GC_AIBP_CALL_AIANSWER TO LS_TOOLBAR-FUNCTION.
*    MOVE ICON_CALL_ANSWER TO LS_TOOLBAR-ICON.
*    MOVE 'Call AI answer' TO LS_TOOLBAR-QUICKINFO.
*    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
*    MOVE ' ' TO LS_TOOLBAR-DISABLED.
*    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
*
*  ENDMETHOD.
*
*  METHOD HIDE_COL.
*    DATA: L_IS_EMPTY      TYPE ABAP_BOOL.
*    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
*                   <F_VALUE>                TYPE ANY.
*
*    DATA: LT_FIELDCATALOG TYPE LVC_T_FCAT.
*
*    MO_GRID_SOURCE->GET_FRONTEND_FIELDCATALOG(
*      IMPORTING
*        ET_FIELDCATALOG = LT_FIELDCATALOG " Field Catalog
*    ).
*
*    M_HIDE = COND #( WHEN M_HIDE = ABAP_TRUE THEN ABAP_FALSE ELSE ABAP_TRUE ).
*
*    IF M_HIDE = ABAP_TRUE.
*      ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
*
*      LOOP AT MT_FIELDCATALOG ASSIGNING FIELD-SYMBOL(<FS_FIELDCATALOG>) WHERE FIELDNAME+0(2) = 'I_'.
*        L_IS_EMPTY = ABAP_TRUE.
*        LOOP AT <FT_VARIANT_CONTENT_NEW> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_NEW>).
*          ASSIGN COMPONENT <FS_FIELDCATALOG>-FIELDNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_VALUE>.
*          IF SY-SUBRC = 0 AND <F_VALUE> <> ''.
*            L_IS_EMPTY = ABAP_FALSE.
*            EXIT.
*          ENDIF.
*        ENDLOOP.
*
*        IF L_IS_EMPTY = ABAP_FALSE.
*          <FS_FIELDCATALOG>-NO_OUT = ABAP_FALSE.
*        ELSE.
*          <FS_FIELDCATALOG>-NO_OUT = ABAP_TRUE.
*        ENDIF.
*      ENDLOOP.
*    ELSE.
*      LOOP AT MT_FIELDCATALOG ASSIGNING <FS_FIELDCATALOG> WHERE FIELDNAME+0(2) = 'I_' AND NO_OUT = ABAP_TRUE.
*        <FS_FIELDCATALOG>-NO_OUT = ABAP_FALSE.
*      ENDLOOP.
*    ENDIF.
*
*    MO_GRID_SOURCE->SET_FRONTEND_LAYOUT( IS_LAYOUT = MS_LAYOUT ).
*
*    MO_GRID_SOURCE->SET_FRONTEND_FIELDCATALOG( IT_FIELDCATALOG = MT_FIELDCATALOG ).
*
*    MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE( ).
*
*  ENDMETHOD.
*
*  METHOD ON_HANDLE_USER_COMMAND.
*
*    CASE E_UCOMM.
*      WHEN GC_AIBP_HIDE_COL.
*        HIDE_COL( ).
*      WHEN GC_AIBP_DOWNLOAD.
*        DOWNLOAD_VFILE( ).
*      WHEN GC_AIBP_CALL_AIANSWER.
*        SHOW_AIANSWER( ).
*      WHEN GC_AIBP_DEBUG_RUN.
*        SET_DEBUG_FLAG( ).
*      WHEN GC_AIBP_TEST_RUN OR GC_AIBP_EXEC_RUN.
*        TEST_OR_EXEC_RUN( I_UCOMM = E_UCOMM ).
*    ENDCASE.
*  ENDMETHOD.
*
*  METHOD TEST_OR_EXEC_RUN.
*    DATA: LT_ROWS              TYPE LVC_T_ROW,
*          LO_ACTIVITY_ABAP     TYPE REF TO /SMB/IF_ACTIVITY_ABAP,
*          IS_CONTENT_STRUCTURE TYPE /SMB/S_ACTV_CONTENT,
*          IT_CONTENT_DATA      TYPE /SMB/T_ACTV_CONTENT_DATA,
*          LS_CONTENT_DATA      TYPE /SMB/S_ACTV_CONTENT_DATA,
*          EV_SUCCESS           TYPE ABAP_BOOL,
*          ET_MESSAGE           TYPE /SMB/T_ACTV_MESSAGE,
*          LS_MATERIAL           TYPE LCL_TYPE_DEFINE=>TYP_MATERIAL,
*          L_ID                 TYPE N LENGTH 5,
*          L_TYPE               TYPE CHAR1,
*          LT_MATERIAL           TYPE LCL_TYPE_DEFINE=>TBL_MATERIAL,
*          LSTR_MATERIAL         TYPE STRING.
*
*    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
*                   <FS_VARIANT_CONTENT_NEW> TYPE ANY,
*                   <F_VALUE>                TYPE ANY.
*
*
*    IS_CONTENT_STRUCTURE = VALUE #(
*     SOLUTION                = 'ZAI_MM_MASTERDATA_CREATOR'
*     PRJID                   = |{ MS_ECATT_DEFINES-TARCOUNTRY }_??|
*     BBID                    = |???_( { MS_ECATT_DEFINES-TARCOUNTRY })|
*     OBJID                   = MS_ECATT_DEFINES-ECATT
*     BB_SEQNUM               = 0
*     FILENAME                = |ZAI_MM_MASTERDATA_CREATOR_{ MS_ECATT_DEFINES-TARCOUNTRY }.TXT|
*     ACTIVITY_IS_DEMO_DATA   = ABAP_TRUE
*     ACTIVATE_WITH_DEMO_DATA = ABAP_TRUE
*     ACT_ID                  = MS_ECATT_DEFINES-ECATT
*     COUNTRY                 = MS_ECATT_DEFINES-TARCOUNTRY
**      CONTEXT =
**      DATASET_ID =
**      CONTENT_ITEM =
**      TRKORR_C =
**      TRKORR_W =
**      DEACTIVATE =
*    ).
*
*
*    ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
*
*    " I_MATNR
*    " I_GROUPING BUCF
*    CALL METHOD MO_GRID_SOURCE->GET_SELECTED_ROWS
*      IMPORTING
*        ET_INDEX_ROWS = LT_ROWS.
*    CALL METHOD CL_GUI_CFW=>FLUSH.
*
*    LSTR_MATERIAL = |{ MS_ECATT_DEFINES-TARCOUNTRY }_%|.
*    SELECT COUNT(*) INTO @DATA(L_COUNT) FROM MARA
*      WHERE MATNR LIKE @LSTR_MATERIAL.
*    L_ID = L_COUNT.
*    LOOP AT LT_ROWS INTO DATA(LS_ROWS).
*      READ TABLE <FT_VARIANT_CONTENT_NEW> ASSIGNING <FS_VARIANT_CONTENT_NEW> INDEX LS_ROWS-INDEX.
*      ADD 1 TO L_ID.
*      LS_CONTENT_DATA-DS_ID = LS_CONTENT_DATA-REC_ID = LS_CONTENT_DATA-DS_REC_ID = |V{ L_ID }|.
*      LOOP AT MS_ECATT_DEFINES-PARAMS INTO DATA(LS_PARAMS).
*
*        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_VALUE>.
*        IF SY-SUBRC = 0.
*
*          LS_CONTENT_DATA-DS_FLD = LS_PARAMS-PNAME.
*          WRITE <F_VALUE> TO LS_CONTENT_DATA-VALUE.
*          CONDENSE LS_CONTENT_DATA-VALUE NO-GAPS.
**          LS_CONTENT_DATA-VALUE = <F_VALUE>.
*          CASE I_UCOMM.
*            WHEN GC_AIBP_TEST_RUN OR GC_AIBP_DEBUG_RUN.
*              CASE LS_PARAMS-PNAME.
*                WHEN 'I_GROUPING'.
*                  LS_CONTENT_DATA-VALUE = 'BPAB'.
*                WHEN 'I_MATNR'.
*                  IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.
*                    LS_CONTENT_DATA-VALUE = |{ MS_ECATT_DEFINES-TARCOUNTRY }_{ L_ID }|.
*                    APPEND LS_CONTENT_DATA-VALUE TO LT_MATERIAL.
*                  ENDIF.
*              ENDCASE.
*            WHEN GC_AIBP_EXEC_RUN.
*          ENDCASE.
*
*          CASE LS_PARAMS-PNAME.
*            WHEN 'I_MATNR'.
*              IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.
*
*                LS_MATERIAL-MATNR = LS_CONTENT_DATA-VALUE.
*                CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*                  EXPORTING
*                    INPUT  = LS_MATERIAL-MATNR  " C field
*                  IMPORTING
*                    OUTPUT = LS_MATERIAL-MATNR. " Internal display of INPUT, any category
*
*                APPEND LS_MATERIAL TO LT_MATERIAL.
*                LS_CONTENT_DATA-VALUE = LS_MATERIAL-MATNR.
*              ENDIF.
*          ENDCASE.
*
*          APPEND LS_CONTENT_DATA TO IT_CONTENT_DATA.
*        ENDIF.
*      ENDLOOP.
*    ENDLOOP.
*
*    IF LT_MATERIAL[] IS NOT INITIAL.
*      SORT LT_MATERIAL.
*      DELETE ADJACENT DUPLICATES FROM LT_MATERIAL.
*
*      SELECT MATNR FROM MARA INTO TABLE @DATA(LT_MARA)
*        FOR ALL ENTRIES IN @LT_MATERIAL
*        WHERE MATNR = @LT_MATERIAL-MATNR.
*      LOOP AT LT_MATERIAL ASSIGNING FIELD-SYMBOL(<FS_MATERIAL>).
*        READ TABLE LT_MARA TRANSPORTING NO FIELDS WITH KEY MATNR = <FS_MATERIAL>-MATNR.
*        IF SY-SUBRC = 0.
*          <FS_MATERIAL>-EXIST = ABAP_TRUE.
*        ENDIF.
*      ENDLOOP.
*    ENDIF.
*
*    IF M_DEBUG = ABAP_TRUE.
*      BREAK-POINT.
*    ENDIF.
*    CALL FUNCTION '/SMB/ACTIVATE_ABAP'
*      EXPORTING
*        IV_CLASS_NAME        = MS_ECATT_DEFINES-CLASS        " Object Type Name
*        IS_CONTENT_STRUCTURE = IS_CONTENT_STRUCTURE " Activation Content Structure
*        IT_CONTENT_DATA      = IT_CONTENT_DATA      " Content Data for Activation
*      IMPORTING
*        ET_MESSAGE           = ET_MESSAGE           " Messages from Activation
*        EV_SUCCESS           = EV_SUCCESS.           " Flag: Activation was successful
*
*    TRY.
*        /SMB/CL_ACTIVATION_ABAP_LOG=>/SMB/IF_RT_ABAP_LOG~GET_INSTANCE(
*          RECEIVING
*            RO_INSTANCE = DATA(LO_ABAP_LOG) " Activation log for ABAP Execution
*        ).
*        DATA LS_LOG_HEADER TYPE /SMB/S_RT_ABAP_LOG_ATTR.
*
*        LS_LOG_HEADER-ACT_TYPE        = /CFG/IF_ACTIVATION_ACTIVITY=>GC_S_ACT_ACTIVITY_TYPE-ABAP.
*        LS_LOG_HEADER-ECATT           = MS_ECATT_DEFINES-ECATT.
*        LS_LOG_HEADER-REPLACING_CLASS = MS_ECATT_DEFINES-CLASS.
*        LS_LOG_HEADER-CFGE_ID         = MS_ECATT_DEFINES-ECATT.
*        LS_LOG_HEADER-IMG_ACT_ID      = MS_ECATT_DEFINES-ECATT.
*
*        LO_ABAP_LOG->CREATE_LOG(
*          EXPORTING
*            IS_LOG_HEADER = LS_LOG_HEADER " Activation log for ABAP call attributes
*          RECEIVING
*            RV_LOG_ID     = DATA(LV_LOG_ID)     " Activation log Handle for ABAP call
*        ).
*
*        IF EV_SUCCESS = ABAP_TRUE.
*          APPEND LINES OF VALUE /SMB/T_ACTV_MESSAGE(
*          FOR PARTNER IN LT_MATERIAL
*          ( MSGTY = 'S'
*            MSGID = 'M3'
*            MSGNO = COND #( WHEN PARTNER-EXIST = ABAP_FALSE THEN 800 ELSE 801 )
*            MSGV1 = PARTNER-MATNR
*            REC_ID = PARTNER-MATNR
*            DS_FLD = PARTNER-MATNR
*          ) ) TO ET_MESSAGE.
*        ENDIF.
*
*        LO_ABAP_LOG->ADD_MESSAGES( IT_MESSAGE = ET_MESSAGE ).
*        LO_ABAP_LOG->SAVE_LOG( IV_ACT_STATUS = COND #( WHEN EV_SUCCESS = ABAP_TRUE THEN 'S' ELSE 'E' ) ).
*
*        /SMB/CL_IMPL_ASS_NAVIGATION=>DISPLAY_ABAP_LOG( IV_ABAP_LOG_ID = LV_LOG_ID ).
*
*      CATCH /SMB/CX_RUNTIME_ABAP.
*
*    ENDTRY.
*
*  ENDMETHOD.
*
*  METHOD SET_DEBUG_FLAG.
*    M_DEBUG = COND #( WHEN M_DEBUG = ABAP_TRUE THEN ABAP_FALSE ELSE ABAP_TRUE ).
*
*    MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE( ).
*  ENDMETHOD.
*
*  METHOD SHOW_AIANSWER.
*    IF MS_ECATT_DEFINES-AI_ANSWER IS NOT INITIAL.
*      CL_HTTP_UTILITY=>ESCAPE_HTML(
*        EXPORTING
*          UNESCAPED         = MS_ECATT_DEFINES-SYSTEM_ROLE
*          KEEP_NUM_CHAR_REF = ABAP_UNDEFINED " Prevent Escaping of HTML Numeric Character References?
*        RECEIVING
*          ESCAPED           = DATA(L_SYSTEM_ROLE)        " HTML-Encoded String
*      ).
*      CL_HTTP_UTILITY=>ESCAPE_HTML(
*        EXPORTING
*          UNESCAPED         = MS_ECATT_DEFINES-AI_ANSWER
*          KEEP_NUM_CHAR_REF = ABAP_UNDEFINED " Prevent Escaping of HTML Numeric Character References?
*        RECEIVING
*          ESCAPED           = DATA(L_AI_ANSWER)        " HTML-Encoded String
*      ).
*
*      DATA(L_STYLE) = 'text-align: center; width: 100%; background-color: lightgray;'.
*      CL_DEMO_OUTPUT=>DISPLAY_HTML( HTML = |<div style="{ L_STYLE }">Prompt</div>| &&
*                                           '<pre >' && L_SYSTEM_ROLE && '</pre>' &&
*                                           |<div style="{ L_STYLE }">AI Answer</div>| &&
*                                           '<pre>' && L_AI_ANSWER && '</pre>' ).
*    ENDIF.
*
*  ENDMETHOD.
*
*  METHOD SUGGEST_FILENAME.
*    DATA: L_FILENAME TYPE STRING,
*          L_PATH     TYPE STRING,
*          L_FULLPATH TYPE STRING,
*          L_BBID     TYPE STRING.
*
*    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
*                   <FS_VARIANT_CONTENT_NEW> TYPE ANY.
*
*    IF MS_ECATT_DEFINES-SUGGEST_FILENAME IS INITIAL.
*      ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
*      READ TABLE <FT_VARIANT_CONTENT_NEW> ASSIGNING <FS_VARIANT_CONTENT_NEW> INDEX 1.
*      L_BBID = <FS_VARIANT_CONTENT_NEW>-('BBID').
*      MS_ECATT_DEFINES-SUGGEST_FILENAME = MS_ECATT_DEFINES-ECATT.
*      TRANSLATE MS_ECATT_DEFINES-SUGGEST_FILENAME USING '/_'.
*      CONDENSE MS_ECATT_DEFINES-SUGGEST_FILENAME NO-GAPS.
*      MS_ECATT_DEFINES-SUGGEST_FILENAME = |{ MS_ECATT_DEFINES-SUGGEST_FILENAME }_{ L_BBID+0(3) }_{ MS_ECATT_DEFINES-TARCOUNTRY }.TXT|.
*      IF MS_ECATT_DEFINES-SUGGEST_FILENAME+0(1) = '_'.
*        MS_ECATT_DEFINES-SUGGEST_FILENAME = MS_ECATT_DEFINES-SUGGEST_FILENAME+1.
*      ENDIF.
*    ENDIF.
*
*    CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG(
*      EXPORTING
*        WINDOW_TITLE              = 'Save your BP v-file' " Window Title
*        DEFAULT_EXTENSION         = '.TXT' " Default Extension
*        DEFAULT_FILE_NAME         = MS_ECATT_DEFINES-SUGGEST_FILENAME " Default File Name
**       WITH_ENCODING             = WITH_ENCODING
*        FILE_FILTER               = 'Text Files (*.TXT)|*.TXT'       " File Type Filter Table
**       INITIAL_DIRECTORY         = INITIAL_DIRECTORY " Initial Directory
**       PROMPT_ON_OVERWRITE       = 'X'
*      CHANGING
*        FILENAME                  = L_FILENAME          " File Name to Save
*        PATH                      = L_PATH              " Path to File
*        FULLPATH                  = L_FULLPATH          " Path + File Name
**       USER_ACTION               = USER_ACTION       " User Action (C Class Const ACTION_OK, ACTION_OVERWRITE etc)
**       FILE_ENCODING             = FILE_ENCODING
*      EXCEPTIONS
*        CNTL_ERROR                = 1                 " Control error
*        ERROR_NO_GUI              = 2                 " No GUI available
*        NOT_SUPPORTED_BY_GUI      = 3                 " GUI does not support this
*        INVALID_DEFAULT_FILE_NAME = 4                 " Invalid default file name
*    ).
*
*    IF SY-SUBRC = 0.
*      MS_ECATT_DEFINES-SUGGEST_FILENAME = L_FILENAME.
*    ELSE.
*      CLEAR: L_FILENAME, L_PATH, L_FULLPATH.
*    ENDIF.
*    R_FULLPATH = L_FULLPATH.
*  ENDMETHOD.
*
*  METHOD DOWNLOAD_VFILE.
*    " /smb/sba1_cl_pme=>download_installation_data
*    DATA: L_FULLPATH TYPE STRING.
*    SUGGEST_FILENAME(
*      RECEIVING
*        R_FULLPATH = L_FULLPATH
*    ).
*    CHECK L_FULLPATH IS NOT INITIAL.
*
*    CONSTANTS: GC_VARIANT     TYPE STRING VALUE 'VARIANT',
*               GC_DESCRIPTION TYPE STRING VALUE 'DESCRIPTION'.
*
*    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW>    TYPE STANDARD TABLE,
*                   <FT_VARIANT_CONTENT_OUTPUT> TYPE STANDARD TABLE,
*                   <F_NEW_VALUE>               TYPE ANY,
*                   <F_OUTPUT_VALUE>            TYPE ANY.
*
*    DATA: LT_PARAMS                   TYPE ETPAR_GUI_TABTYPE,
*          LT_COMP_TAB                 TYPE CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
*          LS_COMP                     TYPE LINE OF CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
*          LO_NEW_TAB                  TYPE REF TO CL_ABAP_TABLEDESCR,
*          LO_ESTRUTURA                TYPE REF TO CL_ABAP_STRUCTDESCR,
*          LO_VARIANT_CONTENT_DOWNLOAD TYPE REF TO DATA,
*          L_VID                       TYPE N LENGTH 5,
*          L_OUTPUT_VALUE              TYPE C LENGTH 255.
*
*    LT_PARAMS = MS_ECATT_DEFINES-PARAMS.
*
*    INSERT VALUE #( PNAME = GC_VARIANT ) INTO LT_PARAMS INDEX 1.
*    INSERT VALUE #( PNAME = GC_DESCRIPTION ) INTO LT_PARAMS INDEX 2.
*
*    LOOP AT LT_PARAMS ASSIGNING FIELD-SYMBOL(<FS_PARAMS>).
*      LS_COMP-NAME = <FS_PARAMS>-PNAME.
*      LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_STRING( ).
*      APPEND LS_COMP TO LT_COMP_TAB.
*    ENDLOOP.
*
*    LO_ESTRUTURA = CL_ABAP_STRUCTDESCR=>CREATE( LT_COMP_TAB ).
*    LO_NEW_TAB = CL_ABAP_TABLEDESCR=>CREATE( P_LINE_TYPE  = LO_ESTRUTURA
*                                             P_TABLE_KIND = CL_ABAP_TABLEDESCR=>TABLEKIND_STD
*                                             P_UNIQUE     = ABAP_FALSE ).
*
*    CREATE DATA LO_VARIANT_CONTENT_DOWNLOAD TYPE HANDLE LO_NEW_TAB.
*
*    ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
*    ASSIGN LO_VARIANT_CONTENT_DOWNLOAD->* TO <FT_VARIANT_CONTENT_OUTPUT>.
*
*    APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_OUTPUT>).
*    <FS_VARIANT_CONTENT_OUTPUT>-(GC_VARIANT) = |*|.
*    LOOP AT LT_PARAMS ASSIGNING <FS_PARAMS>.
*      <FS_VARIANT_CONTENT_OUTPUT>-(<FS_PARAMS>-PNAME) = <FS_PARAMS>-PDESC.
*    ENDLOOP.
*    APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_TDC>).
*    <FS_VARIANT_CONTENT_TDC>-(GC_VARIANT) = |*REFERENCING|.
*
*    LOOP AT MS_ECATT_DEFINES-TDC_DEFINE INTO DATA(LS_TDC_DEFINE).
*      <FS_VARIANT_CONTENT_TDC>-(LS_TDC_DEFINE-PARAM_NAME) = |{ LS_TDC_DEFINE-ALIAS };{ LS_TDC_DEFINE-TDC_PARAM_NAME }|.
*    ENDLOOP.
*
*    L_VID = 0.
*    LOOP AT <FT_VARIANT_CONTENT_NEW> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_NEW>).
*      APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING <FS_VARIANT_CONTENT_OUTPUT>.
*      ADD 1 TO L_VID.
*      <FS_VARIANT_CONTENT_OUTPUT>-(GC_VARIANT) = |VAR{ L_VID }|.
*      " MOVE-CORRESPONDING <FS_VARIANT_CONTENT_NEW> TO <FS_VARIANT_CONTENT_OUTPUT>.
*
*      LOOP AT LT_PARAMS INTO DATA(LS_PARAMS).
*        "WRITE <FS_VARIANT_CONTENT_NEW>-(LS_PARAMS-PNAME) TO <FS_VARIANT_CONTENT_OUTPUT>-(LS_PARAMS-PNAME).
*        UNASSIGN: <F_NEW_VALUE>, <F_OUTPUT_VALUE>.
*        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_NEW_VALUE>.
*        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_OUTPUT> TO <F_OUTPUT_VALUE>.
*
*        IF <F_NEW_VALUE> IS ASSIGNED AND <F_OUTPUT_VALUE> IS ASSIGNED.
*          L_OUTPUT_VALUE = <F_NEW_VALUE>.
*          CONDENSE L_OUTPUT_VALUE NO-GAPS.
*          IF L_OUTPUT_VALUE IS NOT INITIAL.
*            WRITE <F_NEW_VALUE> TO L_OUTPUT_VALUE.
*          ENDIF.
*
*          <F_OUTPUT_VALUE> = L_OUTPUT_VALUE.
*          CLEAR L_OUTPUT_VALUE.
*          CONDENSE <F_OUTPUT_VALUE> NO-GAPS.
*        ENDIF.
*
*        IF <F_OUTPUT_VALUE> IS NOT INITIAL AND <F_OUTPUT_VALUE> CO '0123456789.,+-'.
*          <F_OUTPUT_VALUE> = |#{ <F_OUTPUT_VALUE> }|.
*        ENDIF.
*
*        IF LS_PARAMS-PNAME = 'I_MATNR' OR
*           LS_PARAMS-PNAME = 'I_TKEY_1'.
*          <FS_VARIANT_CONTENT_OUTPUT>-(GC_DESCRIPTION) = <FS_VARIANT_CONTENT_NEW>-(LS_PARAMS-PNAME).
*        ENDIF.
*      ENDLOOP.
*
*    ENDLOOP.
*
*    LT_PARAMS[ PNAME = GC_VARIANT ]-PNAME = |[{ GC_VARIANT }]|.
*    LT_PARAMS[ PNAME = GC_DESCRIPTION ]-PNAME = |[{ GC_DESCRIPTION }]|.
*
*    CL_GUI_FRONTEND_SERVICES=>GUI_DOWNLOAD(
*      EXPORTING
**       BIN_FILESIZE            = BIN_FILESIZE         " File length for binary files
*        FILENAME                = L_FULLPATH           " Name of file
*        FILETYPE                = 'ASC'                " File type (ASCII, binary ...)
**       APPEND                  = SPACE                " Character Field of Length 1
*        WRITE_FIELD_SEPARATOR   = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB                " Separate Columns by Tabs in Case of ASCII Download
**       HEADER                  = '00'                 " Byte Chain Written to Beginning of File in Binary Mode
**       TRUNC_TRAILING_BLANKS   = SPACE                " Do not Write Blank at the End of Char Fields
**       WRITE_LF                = 'X'                  " Insert CR/LF at End of Line in Case of Char Download
**       COL_SELECT              = SPACE                " Copy Only Selected Columns of the Table
**       COL_SELECT_MASK         = SPACE                " Vector Containing an 'X' for the Column To Be Copied
**       DAT_MODE                = SPACE                " Numeric and date fields are in DAT format in WS_DOWNLOAD
**       CONFIRM_OVERWRITE       = SPACE                " Overwrite File Only After Confirmation
**       NO_AUTH_CHECK           = SPACE                " Switch off Check for Access Rights
*        CODEPAGE                = '4103'               " Character Representation for Output
**       IGNORE_CERR             = ABAP_TRUE            " Ignore character set conversion errors?
**       REPLACEMENT             = '#'                  " Replacement Character for Non-Convertible Characters
*        WRITE_BOM               = ABAP_TRUE            " If set, writes a Unicode byte order mark
**       TRUNC_TRAILING_BLANKS_EOL = 'X'                 " Remove Trailing Blanks in Last Column
**       WK1_N_FORMAT            = SPACE
**       WK1_N_SIZE              = SPACE
**       WK1_T_FORMAT            = SPACE
**       WK1_T_SIZE              = SPACE
**       SHOW_TRANSFER_STATUS    = 'X'                  " Enables suppression of transfer status message
*        FIELDNAMES              = LT_PARAMS            " Table Field Names
**       WRITE_LF_AFTER_LAST_LINE  = 'X'                  " Writes a CR/LF after final data record
**       VIRUS_SCAN_PROFILE      = '/SCET/GUI_DOWNLOAD' " Virus Scan Profile
**      IMPORTING
**       FILELENGTH              = FILELENGTH           " Number of bytes transferred
*      CHANGING
*        DATA_TAB                = <FT_VARIANT_CONTENT_OUTPUT>   " Transfer table
*      EXCEPTIONS
*        FILE_WRITE_ERROR        = 1                    " Cannot write to file
*        NO_BATCH                = 2                    " Cannot execute front-end function in background
*        GUI_REFUSE_FILETRANSFER = 3                    " Incorrect Front End
*        INVALID_TYPE            = 4                    " Invalid value for parameter FILETYPE
*        NO_AUTHORITY            = 5                    " No Download Authorization
*        UNKNOWN_ERROR           = 6                    " Unknown error
*        HEADER_NOT_ALLOWED      = 7                    " Invalid header
*        SEPARATOR_NOT_ALLOWED   = 8                    " Invalid separator
*        FILESIZE_NOT_ALLOWED    = 9                    " Invalid file size
*        HEADER_TOO_LONG         = 10                   " Header information currently restricted to 1023 bytes
*        DP_ERROR_CREATE         = 11                   " Cannot create DataProvider
*        DP_ERROR_SEND           = 12                   " Error Sending Data with DataProvider
*        DP_ERROR_WRITE          = 13                   " Error Writing Data with DataProvider
*        UNKNOWN_DP_ERROR        = 14                   " Error when calling data provider
*        ACCESS_DENIED           = 15                   " Access to File Denied
*        DP_OUT_OF_MEMORY        = 16                   " Not enough memory in data provider
*        DISK_FULL               = 17                   " Storage medium is full.
*        DP_TIMEOUT              = 18                   " Data provider timeout
*        FILE_NOT_FOUND          = 19                   " Could not find file
*        DATAPROVIDER_EXCEPTION  = 20                   " General Exception Error in DataProvider
*        CONTROL_FLUSH_ERROR     = 21                   " Error in Control Framework
*        NOT_SUPPORTED_BY_GUI    = 22                   " GUI does not support this
*        ERROR_NO_GUI            = 23                   " GUI not available
*    ).
*    IF SY-SUBRC <> 0.
**     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*    ENDIF.
*
*  ENDMETHOD.
*  " IMPORTING  IS_ECATT_DEFINES TYPE LCL_MM_CREATOR_OF_AI=>TYP_ECATT_DEFINES  .
*  METHOD SHOW_NEW_MM_VFILE.
*    MS_ECATT_DEFINES = CS_ECATT_DEFINES.
*
*    CREATE OBJECT MO_DIALOG
*      EXPORTING
**       PARENT                      = PARENT                  " Parent container
*        WIDTH                       = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_MM_VFILE-MO_DIALOG-WIDTH' ]-SETTING_VALUE DEFAULT 2000 ) " Width of This Container
*        HEIGHT                      = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_MM_VFILE-MO_DIALOG-HEIGHT' ]-SETTING_VALUE DEFAULT 300 ) " Height of This Container
**       STYLE                       = STYLE                   " Windows Style Attributes Applied to this Container
**       REPID                       = REPID                   " Report to Which This Control is Linked
**       DYNNR                       = DYNNR                   " Screen to Which the Control is Linked
**       LIFETIME                    = LIFETIME_DEFAULT        " Lifetime
*        TOP                         = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_MM_VFILE-MO_DIALOG-TOP' ]-SETTING_VALUE DEFAULT 30 )                       " Top Position of Dialog Box
*        LEFT                        = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_MM_VFILE-MO_DIALOG-LEFT' ]-SETTING_VALUE DEFAULT 30 )                       " Left Position of Dialog Box
*        CAPTION                     = MS_ECATT_DEFINES-ECATT  " Dialog Box Caption
**       NO_AUTODEF_PROGID_DYNNR     = NO_AUTODEF_PROGID_DYNNR " Don't Autodefined Progid and Dynnr?
**       METRIC                      = 0                       " Metric
**       NAME                        = NAME                    " Name
*      EXCEPTIONS
*        CNTL_ERROR                  = 1                       " CNTL_ERROR
*        CNTL_SYSTEM_ERROR           = 2                       " CNTL_SYSTEM_ERROR
*        CREATE_ERROR                = 3                       " CREATE_ERROR
*        LIFETIME_ERROR              = 4                       " LIFETIME_ERROR
*        LIFETIME_DYNPRO_DYNPRO_LINK = 5                       " LIFETIME_DYNPRO_DYNPRO_LINK
*        EVENT_ALREADY_REGISTERED    = 6                       " Event Already Registered
*        ERROR_REGIST_EVENT          = 7.                       " Error While Registering Event
*
*    "    MS_LAYOUT-GRID_TITLE = 'BP Editor'(100).
*    MS_LAYOUT-EDIT = ABAP_TRUE.
*    MS_LAYOUT-SEL_MODE = 'A'.
*    MS_LAYOUT-COL_OPT = ABAP_TRUE.
*    MS_LAYOUT-CWIDTH_OPT = ABAP_TRUE.
*    MS_LAYOUT-CTAB_FNAME = LCL_SCREEN_1000=>MC_FIELD_TABCOL.
*
*    DATA(L_SPLITTER_MAIN) = NEW CL_GUI_SPLITTER_CONTAINER(
*      PARENT  = MO_DIALOG
*      ROWS    = 1
*      COLUMNS = 1 ).
*
*    MO_GRID_SOURCE = NEW CL_GUI_ALV_GRID(
*                I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
*                ROW    = 1
*                COLUMN = 1 ) ).
*
*    MT_FIELDCATALOG = CS_ECATT_DEFINES-FIELDCATALOG.
*
*    LOOP AT MT_FIELDCATALOG ASSIGNING FIELD-SYMBOL(<FS_FIELDCATALOG>).
*      IF <FS_FIELDCATALOG>-FIELDNAME+0(2) <> 'I_'.
*        <FS_FIELDCATALOG>-NO_OUT = ABAP_TRUE.
*      ENDIF.
*
*      CASE <FS_FIELDCATALOG>-FIELDNAME.
*        WHEN 'I_MATNR'.
*          <FS_FIELDCATALOG>-COL_POS = 1.
*        WHEN 'I_GROUPING'.
*          <FS_FIELDCATALOG>-COL_POS = 2.
*        WHEN OTHERS.
*      ENDCASE.
*    ENDLOOP.
*
*    FIELD-SYMBOLS <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE.
*    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
*    MO_GRID_SOURCE->SET_TABLE_FOR_FIRST_DISPLAY(
*      EXPORTING
*        IS_LAYOUT                     = MS_LAYOUT            " Layout
*      CHANGING
*        IT_OUTTAB                     = <FT_VARIANT_CONTENT_NEW>   " Output Table
*        IT_FIELDCATALOG               = MT_FIELDCATALOG " Field Catalog
*      EXCEPTIONS
*        INVALID_PARAMETER_COMBINATION = 1                    " Wrong Parameter
*        PROGRAM_ERROR                 = 2                    " Program Errors
*        TOO_MANY_LINES                = 3                    " Too many Rows in Ready for Input Grid
*    ).
*    " BCALV_GRID_05 -233
*    SET HANDLER ON_HANDLE_USER_COMMAND FOR MO_GRID_SOURCE.
*    SET HANDLER ON_HANDLE_TOOLBAR FOR MO_GRID_SOURCE.
*    SET HANDLER ON_NEW_MM_DLG_CLOSE FOR MO_DIALOG.
*
*    CALL METHOD MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE.
*
*  ENDMETHOD.
*
*  METHOD ON_NEW_MM_DLG_CLOSE.
*    IF MO_DIALOG IS NOT INITIAL.
*      MO_DIALOG->GET_TOP(
*        IMPORTING
*          TOP        = DATA(L_TOP) " Current Top Coordinate of Control
*        EXCEPTIONS
*          CNTL_ERROR = 1   " cntl_error
*      ).
*      CL_GUI_CFW=>FLUSH( ).
*      LCL_SETTING=>MODIFY_SETTING(
*        I_SETTING_ID    = 'SHOW_NEW_MM_VFILE-MO_DIALOG-TOP'
*        I_SETTING_VALUE = CONV #( L_TOP )
*      ).
*
*      MO_DIALOG->GET_LEFT(
*        IMPORTING
*          LEFT       = DATA(L_LEFT) " Current Left Coordinate of Control
*        EXCEPTIONS
*          CNTL_ERROR = 1    " cntl_error
*      ).
*      IF SY-SUBRC <> 0.
**       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*      ENDIF.
*      CL_GUI_CFW=>FLUSH( ).
*      LCL_SETTING=>MODIFY_SETTING(
*        I_SETTING_ID    = 'SHOW_NEW_MM_VFILE-MO_DIALOG-LEFT'
*        I_SETTING_VALUE = CONV #( L_LEFT )
*      ).
*
*      MO_DIALOG->GET_WIDTH(
*        IMPORTING
*          WIDTH      = DATA(L_WIDTH) " Current Width
*        EXCEPTIONS
*          CNTL_ERROR = 1     " cntl_error
*      ).
*      IF SY-SUBRC <> 0.
**       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*      ENDIF.
*      CL_GUI_CFW=>FLUSH( ).
*      LCL_SETTING=>MODIFY_SETTING(
*        I_SETTING_ID    = 'SHOW_NEW_MM_VFILE-MO_DIALOG-WIDTH'
*        I_SETTING_VALUE = CONV #( L_WIDTH )
*      ).
*      MO_DIALOG->GET_HEIGHT(
*        IMPORTING
*          HEIGHT     = DATA(L_HEIGHT) " Current Height
*        EXCEPTIONS
*          CNTL_ERROR = 1      " cntl_error
*      ).
*      IF SY-SUBRC <> 0.
**       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*      ENDIF.
*      CL_GUI_CFW=>FLUSH( ).
*      LCL_SETTING=>MODIFY_SETTING(
*        I_SETTING_ID    = 'SHOW_NEW_MM_VFILE-MO_DIALOG-HEIGHT'
*        I_SETTING_VALUE = CONV #( L_HEIGHT )
*      ).
*
*      MO_DIALOG->FREE(  ).
*      CLEAR MO_DIALOG.
*    ENDIF.
*  ENDMETHOD.
*ENDCLASS.

CLASS LCL_VFILE_CREATOR IMPLEMENTATION.

  METHOD CONSTRUCTOR.
  ENDMETHOD.

  METHOD INIT_RULE.

    LCL_RULE_PROCESS=>INIT_RULE( ).


  ENDMETHOD.

  METHOD ASSIGN_FIELDS_BY_RULE.
    LOOP AT IT_OPTION_FIELDS ASSIGNING FIELD-SYMBOL(<FS_OPTION_FIELDS>)." WHERE OPTION  = SUGGEST_BY_AI.
      READ TABLE IS_ECATT_DEFINES-PARAMS INTO DATA(LS_PARAMS) WITH KEY PNAME = <FS_OPTION_FIELDS>-FIELDNAME.
      CHECK SY-SUBRC = 0.

      LCL_RULE_PROCESS=>ADD_FIELD(
        I_OPERTION_TYPE = <FS_OPTION_FIELDS>-OPTION
        IS_FIELD        = LS_PARAMS
      ).

    ENDLOOP.
  ENDMETHOD.

  METHOD PROCESS_RULE.
    LCL_RULE_PROCESS=>PROCESS_RULE(
      CHANGING
        CS_ECATT_DEFINES = CS_ECATT_DEFINES
    ).
  ENDMETHOD.

  METHOD COPY_CONTENT_TO_NEW_TABLE.
    FIELD-SYMBOLS: <FT_CONTENT>     TYPE STANDARD TABLE,
                   <FS_CONTENT>     TYPE ANY,
                   <FT_CONTENT_NEW> TYPE STANDARD TABLE,
                   <FS_CONTENT_NEW> TYPE ANY.

    DATA: L_IDX          TYPE I.

    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT->* TO <FT_CONTENT>.

    IF CS_ECATT_DEFINES-VARIANT_CONTENT_NEW IS NOT INITIAL.
      FREE CS_ECATT_DEFINES-VARIANT_CONTENT_NEW.
    ENDIF.

    CREATE DATA CS_ECATT_DEFINES-VARIANT_CONTENT_NEW TYPE HANDLE CS_ECATT_DEFINES-VARIANT_TABLEDESCR.
    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_CONTENT_NEW>.


    L_IDX = 0.
    DO I_NUMCREATE TIMES.
      IF L_IDX >= LINES( IT_ROW_NO ).
        L_IDX = 0.
      ENDIF.
      ADD 1 TO L_IDX.
      READ TABLE IT_ROW_NO INTO DATA(LS_ROW_NO) INDEX L_IDX.
      READ TABLE <FT_CONTENT> ASSIGNING <FS_CONTENT> INDEX LS_ROW_NO-ROW_ID.
      CHECK SY-SUBRC = 0.
      APPEND INITIAL LINE TO <FT_CONTENT_NEW> ASSIGNING <FS_CONTENT_NEW>.

      MOVE-CORRESPONDING <FS_CONTENT> TO <FS_CONTENT_NEW>.
    ENDDO.
  ENDMETHOD.
**********************************************************************
* 根据不同过的ecatt需要提供不同prompt
* 不同字段的处理方式不一样，需要特别是IBAN字段，需要按不同国家特殊处理
**********************************************************************
  METHOD CREATE_VFILE.
    FIELD-SYMBOLS: <FT_CONTENT>     TYPE STANDARD TABLE,
                   <FS_CONTENT>     TYPE ANY,
                   <F_VALUE>        TYPE ANY,
                   <FT_CONTENT_NEW> TYPE STANDARD TABLE,
                   <FS_CONTENT_NEW> TYPE ANY,
                   <F_VALUE_NEW>    TYPE ANY,
                   <FT_AI_VALUES>   TYPE STANDARD TABLE,
                   <FS_AI_VALUES>   TYPE ANY,
                   <F_AI_VALUE>     TYPE ANY.

    DATA: LC_RULE_PROCESSER   TYPE REF TO LCL_RULE,
          VARIANT_CONTENT_NEW TYPE REF TO DATA,

          LO_NEW_TAB          TYPE REF TO CL_ABAP_TABLEDESCR,
          LO_ESTRUTURA        TYPE REF TO CL_ABAP_STRUCTDESCR,
          LT_AI_VALUES        TYPE REF TO DATA,
          LT_FIELD_EXPLAINS   TYPE ETPAR_GUI_TABTYPE.

    CS_ECATT_DEFINES-TARCOUNTRY = I_TARCOUNTRY.
    CS_ECATT_DEFINES-NUMCREATE = I_NUMCREATE.
    CS_ECATT_DEFINES-FORMAT = I_FORMAT.
    CS_ECATT_DEFINES-RNG_SIR_SI_ID = ING_SIR_SI_ID.
    CLEAR CS_ECATT_DEFINES-AI_ANSWER.

    INIT_RULE( ).

    " 按预定规则分配字段
    ASSIGN_FIELDS_BY_RULE(
      EXPORTING
        IS_ECATT_DEFINES = CS_ECATT_DEFINES
        IT_OPTION_FIELDS = IT_OPTION_FIELDS
    ).

    COPY_CONTENT_TO_NEW_TABLE(
      EXPORTING
        IT_ROW_NO        = IT_ROW_NO
        I_NUMCREATE      = I_NUMCREATE
      CHANGING
        CS_ECATT_DEFINES = CS_ECATT_DEFINES
    ).

    " 按规则处理新的content
    PROCESS_RULE(
      CHANGING
        CS_ECATT_DEFINES = CS_ECATT_DEFINES
    ).

    NEW LCL_NEW_VFILE_TESTER( )->SHOW_NEW_VFILE(
      CHANGING
        CS_ECATT_DEFINES = CS_ECATT_DEFINES
    ).
  ENDMETHOD.
ENDCLASS.

CLASS LCL_NEW_VFILE_TESTER IMPLEMENTATION.
  METHOD ON_HANDLE_TOOLBAR.

    DATA: LS_TOOLBAR  TYPE STB_BUTTON.

* append a separator to normal toolbar
    CLEAR LS_TOOLBAR.
    MOVE 3 TO LS_TOOLBAR-BUTN_TYPE.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

    CLEAR LS_TOOLBAR.
    MOVE GC_AIBP_HIDE_COL TO LS_TOOLBAR-FUNCTION.
    IF M_HIDE = ABAP_FALSE.
      MOVE ICON_COLLAPSE TO LS_TOOLBAR-ICON.
      MOVE 'Hide empty col' TO LS_TOOLBAR-QUICKINFO.
    ELSE.
      MOVE ICON_EXPAND TO LS_TOOLBAR-ICON.
      MOVE 'All col' TO LS_TOOLBAR-QUICKINFO.
    ENDIF.

    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
    MOVE ' ' TO LS_TOOLBAR-DISABLED.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

    CLEAR LS_TOOLBAR.
    MOVE GC_AIBP_DOWNLOAD TO LS_TOOLBAR-FUNCTION.
    MOVE ICON_CLOUD_DOWNLOAD TO LS_TOOLBAR-ICON.
    MOVE 'Download V-File' TO LS_TOOLBAR-QUICKINFO.
    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
    MOVE ' ' TO LS_TOOLBAR-DISABLED.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

    IF MS_ECATT_DEFINES-ECATT = '/SMB99/BP_GEN_O001' OR
       MS_ECATT_DEFINES-ECATT = '/SMB99/BP_GEN_O001_U' OR
       MS_ECATT_DEFINES-ECATT+0(11) = '/SMB99/MARA'.
      CLEAR LS_TOOLBAR.
      MOVE GC_AIBP_TEST_RUN TO LS_TOOLBAR-FUNCTION.
      MOVE ICON_TEST TO LS_TOOLBAR-ICON.
      LS_TOOLBAR-QUICKINFO = |New "{ MS_ECATT_DEFINES-TARCOUNTRY }_*".|.
      MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
      MOVE ' ' TO LS_TOOLBAR-DISABLED.
      APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.
    ENDIF.

    CLEAR LS_TOOLBAR.
    MOVE GC_AIBP_EXEC_RUN TO LS_TOOLBAR-FUNCTION.
    MOVE ICON_EXECUTE_OBJECT TO LS_TOOLBAR-ICON.
    MOVE 'Run ECATT' TO LS_TOOLBAR-QUICKINFO.
    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
    MOVE ' ' TO LS_TOOLBAR-DISABLED.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

    CLEAR LS_TOOLBAR.
    MOVE GC_AIBP_DEBUG_RUN TO LS_TOOLBAR-FUNCTION.
    MOVE ICON_DEBUGGER_STEP_INTO TO LS_TOOLBAR-ICON.
    MOVE 'Debug ECATT' TO LS_TOOLBAR-QUICKINFO.
    LS_TOOLBAR-TEXT = COND STRING( WHEN M_DEBUG = ABAP_TRUE THEN 'Debug On' ELSE 'Debug OFF' ).
    MOVE ' ' TO LS_TOOLBAR-DISABLED.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

    CLEAR LS_TOOLBAR.
    MOVE GC_AIBP_CALL_AIANSWER TO LS_TOOLBAR-FUNCTION.
    MOVE ICON_CALL_ANSWER TO LS_TOOLBAR-ICON.
    MOVE 'Call AI answer' TO LS_TOOLBAR-QUICKINFO.
    MOVE LS_TOOLBAR-QUICKINFO TO LS_TOOLBAR-TEXT.
    MOVE ' ' TO LS_TOOLBAR-DISABLED.
    APPEND LS_TOOLBAR TO E_OBJECT->MT_TOOLBAR.

  ENDMETHOD.

  METHOD HIDE_COL.
    DATA: L_IS_EMPTY      TYPE ABAP_BOOL.
    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
                   <F_VALUE>                TYPE ANY.

    DATA: LT_FIELDCATALOG TYPE LVC_T_FCAT.

    MO_GRID_SOURCE->GET_FRONTEND_FIELDCATALOG(
      IMPORTING
        ET_FIELDCATALOG = LT_FIELDCATALOG " Field Catalog
    ).

    M_HIDE = COND #( WHEN M_HIDE = ABAP_TRUE THEN ABAP_FALSE ELSE ABAP_TRUE ).

    IF M_HIDE = ABAP_TRUE.
      ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.

      LOOP AT MT_FIELDCATALOG ASSIGNING FIELD-SYMBOL(<FS_FIELDCATALOG>) WHERE FIELDNAME+0(2) = 'I_'.
        L_IS_EMPTY = ABAP_TRUE.
        LOOP AT <FT_VARIANT_CONTENT_NEW> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_NEW>).
          ASSIGN COMPONENT <FS_FIELDCATALOG>-FIELDNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_VALUE>.
          IF SY-SUBRC = 0 AND <F_VALUE> <> ''.
            L_IS_EMPTY = ABAP_FALSE.
            EXIT.
          ENDIF.
        ENDLOOP.

        IF L_IS_EMPTY = ABAP_FALSE.
          <FS_FIELDCATALOG>-NO_OUT = ABAP_FALSE.
        ELSE.
          <FS_FIELDCATALOG>-NO_OUT = ABAP_TRUE.
        ENDIF.
      ENDLOOP.
    ELSE.
      LOOP AT MT_FIELDCATALOG ASSIGNING <FS_FIELDCATALOG> WHERE FIELDNAME+0(2) = 'I_' AND NO_OUT = ABAP_TRUE.
        <FS_FIELDCATALOG>-NO_OUT = ABAP_FALSE.
      ENDLOOP.
    ENDIF.

    MO_GRID_SOURCE->SET_FRONTEND_LAYOUT( IS_LAYOUT = MS_LAYOUT ).

    MO_GRID_SOURCE->SET_FRONTEND_FIELDCATALOG( IT_FIELDCATALOG = MT_FIELDCATALOG ).

    MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE( ).

  ENDMETHOD.

  METHOD ON_HANDLE_USER_COMMAND.

    CASE E_UCOMM.
      WHEN GC_AIBP_HIDE_COL.
        HIDE_COL( ).
      WHEN GC_AIBP_DOWNLOAD.
        DOWNLOAD_VFILE( ).
      WHEN GC_AIBP_CALL_AIANSWER.
        SHOW_AIANSWER( ).
      WHEN GC_AIBP_DEBUG_RUN.
        SET_DEBUG_FLAG( ).
      WHEN GC_AIBP_TEST_RUN OR GC_AIBP_EXEC_RUN.
        TEST_OR_EXEC_RUN( I_UCOMM = E_UCOMM ).
    ENDCASE.
  ENDMETHOD.

  METHOD TEST_OR_EXEC_RUN.
    DATA: LT_ROWS              TYPE LVC_T_ROW,
          LO_ACTIVITY_ABAP     TYPE REF TO /SMB/IF_ACTIVITY_ABAP,
          IS_CONTENT_STRUCTURE TYPE /SMB/S_ACTV_CONTENT,
          IT_CONTENT_DATA      TYPE /SMB/T_ACTV_CONTENT_DATA,
          LS_CONTENT_DATA      TYPE /SMB/S_ACTV_CONTENT_DATA,
          EV_SUCCESS           TYPE ABAP_BOOL,
          ET_MESSAGE           TYPE /SMB/T_ACTV_MESSAGE,
          L_ID                 TYPE N LENGTH 5,
          L_TYPE               TYPE CHAR2,
          LT_PARTNER           TYPE LCL_TYPE_DEFINE=>TBL_PARTNER,
          LS_PARTNER           TYPE LCL_TYPE_DEFINE=>TYP_PARTNER,
          LT_MATERIAL          TYPE LCL_TYPE_DEFINE=>TBL_MATERIAL,
          LS_MATERIAL          TYPE LCL_TYPE_DEFINE=>TYP_MATERIAL,
          LSTR_PARAM           TYPE STRING,
          L_COUNT              TYPE I.

    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
                   <FS_VARIANT_CONTENT_NEW> TYPE ANY,
                   <F_VALUE>                TYPE ANY.

    READ TABLE MS_ECATT_DEFINES-PARAMS TRANSPORTING NO FIELDS WITH KEY PNAME = 'I_MATNR'.
    IF SY-SUBRC = 0.
      L_TYPE = 'MM'.
    ENDIF.

    READ TABLE MS_ECATT_DEFINES-PARAMS TRANSPORTING NO FIELDS WITH KEY PNAME = 'I_BP_KUNNR'.
    IF SY-SUBRC = 0.
      L_TYPE = 'BP'.
    ENDIF.

    READ TABLE MS_ECATT_DEFINES-PARAMS TRANSPORTING NO FIELDS WITH KEY PNAME = 'I_BP_LIFNR'.
    IF SY-SUBRC = 0.
      L_TYPE = 'BP'.
    ENDIF.

    IS_CONTENT_STRUCTURE = VALUE #(
     SOLUTION                = 'ZAI_ECATT_MASTERDATA_CREATOR'
     PRJID                   = |{ MS_ECATT_DEFINES-TARCOUNTRY }_SI_AI|
     BBID                    = |BB_AI_( { MS_ECATT_DEFINES-TARCOUNTRY })|
     OBJID                   = MS_ECATT_DEFINES-ECATT
     BB_SEQNUM               = 0
     FILENAME                = |ZAI_ECATT_MASTERDATA_CREATOR_{ MS_ECATT_DEFINES-TARCOUNTRY }.TXT|
     ACTIVITY_IS_DEMO_DATA   = ABAP_TRUE
     ACTIVATE_WITH_DEMO_DATA = ABAP_TRUE
     ACT_ID                  = MS_ECATT_DEFINES-ECATT
     COUNTRY                 = MS_ECATT_DEFINES-TARCOUNTRY
*      CONTEXT =
*      DATASET_ID =
*      CONTENT_ITEM =
*      TRKORR_C =
*      TRKORR_W =
*      DEACTIVATE =
    ).
    ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.

    " I_BP_KUNNR
    " I_BP_LIFNR
    " I_GROUPING BUCF
    CALL METHOD MO_GRID_SOURCE->GET_SELECTED_ROWS
      IMPORTING
        ET_INDEX_ROWS = LT_ROWS.
    CALL METHOD CL_GUI_CFW=>FLUSH.

    LSTR_PARAM = |{ MS_ECATT_DEFINES-TARCOUNTRY }_%|.

    CASE L_TYPE.
      WHEN 'MM'.
        SELECT COUNT(*) INTO @L_COUNT FROM MARA
          WHERE MATNR LIKE @LSTR_PARAM.
      WHEN 'BP'.
        SELECT COUNT(*) INTO @L_COUNT FROM BUT000
          WHERE PARTNER LIKE @LSTR_PARAM.
      WHEN OTHERS.
    ENDCASE.

    L_ID = L_COUNT.
    LOOP AT LT_ROWS INTO DATA(LS_ROWS).
      READ TABLE <FT_VARIANT_CONTENT_NEW> ASSIGNING <FS_VARIANT_CONTENT_NEW> INDEX LS_ROWS-INDEX.
      ADD 1 TO L_ID.
      LS_CONTENT_DATA-DS_ID = LS_CONTENT_DATA-REC_ID = LS_CONTENT_DATA-DS_REC_ID = |V{ L_ID }|.
      LOOP AT MS_ECATT_DEFINES-PARAMS INTO DATA(LS_PARAMS).

        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_VALUE>.
        IF SY-SUBRC = 0.
          LS_CONTENT_DATA-DS_FLD = LS_PARAMS-PNAME.
          LS_CONTENT_DATA-VALUE = <F_VALUE>.
          IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.
            CASE LS_PARAMS-PINTTYP.
              WHEN 'D'.
              WHEN OTHERS.
                WRITE <F_VALUE> TO LS_CONTENT_DATA-VALUE.
            ENDCASE.
            CONDENSE LS_CONTENT_DATA-VALUE NO-GAPS.
          ENDIF.

          CASE I_UCOMM.
            WHEN GC_AIBP_TEST_RUN OR GC_AIBP_DEBUG_RUN.
              CASE LS_PARAMS-PNAME.
                WHEN 'I_GROUPING'.
                  LS_CONTENT_DATA-VALUE = 'BPAB'.
                WHEN 'I_BP_KUNNR' OR 'I_BP_LIFNR'.
                  IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.
                    LS_CONTENT_DATA-VALUE = |{ MS_ECATT_DEFINES-TARCOUNTRY }_{ L_ID }|.
                    APPEND LS_CONTENT_DATA-VALUE TO LT_PARTNER.
                  ENDIF.
                WHEN 'I_MATNR'.
                  IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.
                    LS_CONTENT_DATA-VALUE = |{ MS_ECATT_DEFINES-TARCOUNTRY }_{ L_ID }|.
                    APPEND LS_CONTENT_DATA-VALUE TO LT_MATERIAL.
                  ENDIF.
              ENDCASE.
            WHEN GC_AIBP_EXEC_RUN.
          ENDCASE.

          CASE LS_PARAMS-PNAME.
            WHEN 'I_BP_KUNNR' OR 'I_BP_LIFNR'.
              IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.

                LS_PARTNER-PARTNER = LS_CONTENT_DATA-VALUE.
                CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
                  EXPORTING
                    INPUT  = LS_PARTNER-PARTNER  " C field
                  IMPORTING
                    OUTPUT = LS_PARTNER-PARTNER. " Internal display of INPUT, any category

                APPEND LS_PARTNER TO LT_PARTNER.
                LS_CONTENT_DATA-VALUE = LS_PARTNER-PARTNER.
              ENDIF.
            WHEN 'I_MATNR'.
              IF LS_CONTENT_DATA-VALUE IS NOT INITIAL.

                LS_MATERIAL-MATNR = LS_CONTENT_DATA-VALUE.
                CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
                  EXPORTING
                    INPUT  = LS_MATERIAL-MATNR  " C field
                  IMPORTING
                    OUTPUT = LS_MATERIAL-MATNR. " Internal display of INPUT, any category

                APPEND LS_MATERIAL TO LT_MATERIAL.
                LS_CONTENT_DATA-VALUE = LS_MATERIAL-MATNR.
              ENDIF.

          ENDCASE.


          APPEND LS_CONTENT_DATA TO IT_CONTENT_DATA.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

    IF LT_PARTNER[] IS NOT INITIAL.
      SORT LT_PARTNER.
      DELETE ADJACENT DUPLICATES FROM LT_PARTNER.

      SELECT PARTNER FROM BUT000 INTO TABLE @DATA(LT_BUT00)
        FOR ALL ENTRIES IN @LT_PARTNER
        WHERE PARTNER = @LT_PARTNER-PARTNER.
      LOOP AT LT_PARTNER ASSIGNING FIELD-SYMBOL(<FS_PARTNER>).
        READ TABLE LT_BUT00 TRANSPORTING NO FIELDS WITH KEY PARTNER = <FS_PARTNER>-PARTNER.
        IF SY-SUBRC = 0.
          <FS_PARTNER>-EXIST = ABAP_TRUE.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF LT_MATERIAL[] IS NOT INITIAL.
      SORT LT_MATERIAL.
      DELETE ADJACENT DUPLICATES FROM LT_MATERIAL.

      SELECT MATNR FROM MARA INTO TABLE @DATA(LT_MARA)
        FOR ALL ENTRIES IN @LT_MATERIAL
        WHERE MATNR = @LT_MATERIAL-MATNR.
      LOOP AT LT_MATERIAL ASSIGNING FIELD-SYMBOL(<FS_MATERIAL>).
        READ TABLE LT_MARA TRANSPORTING NO FIELDS WITH KEY MATNR = <FS_MATERIAL>-MATNR.
        IF SY-SUBRC = 0.
          <FS_MATERIAL>-EXIST = ABAP_TRUE.
        ENDIF.
      ENDLOOP.
    ENDIF.


    IF M_DEBUG = ABAP_TRUE.
      BREAK-POINT.
    ENDIF.
    CALL FUNCTION '/SMB/ACTIVATE_ABAP'
      EXPORTING
        IV_CLASS_NAME        = MS_ECATT_DEFINES-CLASS        " Object Type Name
        IS_CONTENT_STRUCTURE = IS_CONTENT_STRUCTURE " Activation Content Structure
        IT_CONTENT_DATA      = IT_CONTENT_DATA      " Content Data for Activation
      IMPORTING
        ET_MESSAGE           = ET_MESSAGE           " Messages from Activation
        EV_SUCCESS           = EV_SUCCESS.           " Flag: Activation was successful

    TRY.
        /SMB/CL_ACTIVATION_ABAP_LOG=>/SMB/IF_RT_ABAP_LOG~GET_INSTANCE(
          RECEIVING
            RO_INSTANCE = DATA(LO_ABAP_LOG) " Activation log for ABAP Execution
        ).
        DATA LS_LOG_HEADER TYPE /SMB/S_RT_ABAP_LOG_ATTR.

        LS_LOG_HEADER-ACT_TYPE        = /CFG/IF_ACTIVATION_ACTIVITY=>GC_S_ACT_ACTIVITY_TYPE-ABAP.
        LS_LOG_HEADER-ECATT           = MS_ECATT_DEFINES-ECATT.
        LS_LOG_HEADER-REPLACING_CLASS = MS_ECATT_DEFINES-CLASS.
        LS_LOG_HEADER-CFGE_ID         = MS_ECATT_DEFINES-ECATT.
        LS_LOG_HEADER-IMG_ACT_ID      = MS_ECATT_DEFINES-ECATT.

        LO_ABAP_LOG->CREATE_LOG(
          EXPORTING
            IS_LOG_HEADER = LS_LOG_HEADER " Activation log for ABAP call attributes
          RECEIVING
            RV_LOG_ID     = DATA(LV_LOG_ID)     " Activation log Handle for ABAP call
        ).

        IF EV_SUCCESS = ABAP_TRUE.
          CASE L_TYPE.
            WHEN 'MM'.
              APPEND LINES OF VALUE /SMB/T_ACTV_MESSAGE(
              FOR MATERIAL IN LT_MATERIAL
              ( MSGTY = 'S'
                MSGID = 'M3'
                MSGNO = COND #( WHEN MATERIAL-EXIST = ABAP_FALSE THEN 800 ELSE 801 )
                MSGV1 = MATERIAL-MATNR
                REC_ID = MATERIAL-MATNR
                DS_FLD = MATERIAL-MATNR
              ) ) TO ET_MESSAGE.
            WHEN 'BP'.
              APPEND LINES OF VALUE /SMB/T_ACTV_MESSAGE(
              FOR PARTNER IN LT_PARTNER
              ( MSGTY = 'S'
                MSGID = 'B0'
                MSGNO = COND #( WHEN PARTNER-EXIST = ABAP_FALSE THEN 111 ELSE 112 )
                MSGV1 = PARTNER-PARTNER
                REC_ID = PARTNER-PARTNER
                DS_FLD = PARTNER-PARTNER
              ) ) TO ET_MESSAGE.
            WHEN OTHERS.
          ENDCASE.
        ENDIF.

        LO_ABAP_LOG->ADD_MESSAGES( IT_MESSAGE = ET_MESSAGE ).
        LO_ABAP_LOG->SAVE_LOG( IV_ACT_STATUS = COND #( WHEN EV_SUCCESS = ABAP_TRUE THEN 'S' ELSE 'E' ) ).

        /SMB/CL_IMPL_ASS_NAVIGATION=>DISPLAY_ABAP_LOG( IV_ABAP_LOG_ID = LV_LOG_ID ).

      CATCH /SMB/CX_RUNTIME_ABAP.

    ENDTRY.

  ENDMETHOD.

  METHOD SET_DEBUG_FLAG.
    M_DEBUG = COND #( WHEN M_DEBUG = ABAP_TRUE THEN ABAP_FALSE ELSE ABAP_TRUE ).

    MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE( ).
  ENDMETHOD.

  METHOD SHOW_AIANSWER.
    IF MS_ECATT_DEFINES-AI_ANSWER IS NOT INITIAL.
      CL_HTTP_UTILITY=>ESCAPE_HTML(
        EXPORTING
          UNESCAPED         = MS_ECATT_DEFINES-SYSTEM_ROLE
          KEEP_NUM_CHAR_REF = ABAP_UNDEFINED " Prevent Escaping of HTML Numeric Character References?
        RECEIVING
          ESCAPED           = DATA(L_SYSTEM_ROLE)        " HTML-Encoded String
      ).
      CL_HTTP_UTILITY=>ESCAPE_HTML(
        EXPORTING
          UNESCAPED         = MS_ECATT_DEFINES-AI_ANSWER
          KEEP_NUM_CHAR_REF = ABAP_UNDEFINED " Prevent Escaping of HTML Numeric Character References?
        RECEIVING
          ESCAPED           = DATA(L_AI_ANSWER)        " HTML-Encoded String
      ).

      DATA(L_STYLE) = 'text-align: center; width: 100%; background-color: lightgray;'.
      CL_DEMO_OUTPUT=>DISPLAY_HTML( HTML = |<div style="{ L_STYLE }">Prompt</div>| &&
                                           '<pre >' && L_SYSTEM_ROLE && '</pre>' &&
                                           |<div style="{ L_STYLE }">AI Answer</div>| &&
                                           '<pre>' && L_AI_ANSWER && '</pre>' ).
    ENDIF.

  ENDMETHOD.

  METHOD SUGGEST_FILENAME.
    DATA: L_FILENAME TYPE STRING,
          L_PATH     TYPE STRING,
          L_FULLPATH TYPE STRING,
          L_BBID     TYPE STRING.

    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE,
                   <FS_VARIANT_CONTENT_NEW> TYPE ANY.

    IF MS_ECATT_DEFINES-SUGGEST_FILENAME IS INITIAL.
      ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
      READ TABLE <FT_VARIANT_CONTENT_NEW> ASSIGNING <FS_VARIANT_CONTENT_NEW> INDEX 1.
      L_BBID = <FS_VARIANT_CONTENT_NEW>-('BBID').
      MS_ECATT_DEFINES-SUGGEST_FILENAME = MS_ECATT_DEFINES-ECATT.
      TRANSLATE MS_ECATT_DEFINES-SUGGEST_FILENAME USING '/_'.
      CONDENSE MS_ECATT_DEFINES-SUGGEST_FILENAME NO-GAPS.
      MS_ECATT_DEFINES-SUGGEST_FILENAME = |{ MS_ECATT_DEFINES-SUGGEST_FILENAME }_{ L_BBID+0(3) }_{ MS_ECATT_DEFINES-TARCOUNTRY }.TXT|.
      IF MS_ECATT_DEFINES-SUGGEST_FILENAME+0(1) = '_'.
        MS_ECATT_DEFINES-SUGGEST_FILENAME = MS_ECATT_DEFINES-SUGGEST_FILENAME+1.
      ENDIF.
    ENDIF.

    CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG(
      EXPORTING
        WINDOW_TITLE              = 'Save your BP v-file' " Window Title
        DEFAULT_EXTENSION         = '.TXT' " Default Extension
        DEFAULT_FILE_NAME         = MS_ECATT_DEFINES-SUGGEST_FILENAME " Default File Name
*       WITH_ENCODING             = WITH_ENCODING
        FILE_FILTER               = 'Text Files (*.TXT)|*.TXT'       " File Type Filter Table
*       INITIAL_DIRECTORY         = INITIAL_DIRECTORY " Initial Directory
*       PROMPT_ON_OVERWRITE       = 'X'
      CHANGING
        FILENAME                  = L_FILENAME          " File Name to Save
        PATH                      = L_PATH              " Path to File
        FULLPATH                  = L_FULLPATH          " Path + File Name
*       USER_ACTION               = USER_ACTION       " User Action (C Class Const ACTION_OK, ACTION_OVERWRITE etc)
*       FILE_ENCODING             = FILE_ENCODING
      EXCEPTIONS
        CNTL_ERROR                = 1                 " Control error
        ERROR_NO_GUI              = 2                 " No GUI available
        NOT_SUPPORTED_BY_GUI      = 3                 " GUI does not support this
        INVALID_DEFAULT_FILE_NAME = 4                 " Invalid default file name
    ).

    IF SY-SUBRC = 0.
      MS_ECATT_DEFINES-SUGGEST_FILENAME = L_FILENAME.
    ELSE.
      CLEAR: L_FILENAME, L_PATH, L_FULLPATH.
    ENDIF.
    R_FULLPATH = L_FULLPATH.
  ENDMETHOD.

  METHOD DOWNLOAD_VFILE.
    " /smb/sba1_cl_pme=>download_installation_data
    DATA: L_FULLPATH TYPE STRING.
    SUGGEST_FILENAME(
      RECEIVING
        R_FULLPATH = L_FULLPATH
    ).
    CHECK L_FULLPATH IS NOT INITIAL.

    CONSTANTS: GC_VARIANT     TYPE STRING VALUE 'VARIANT',
               GC_DESCRIPTION TYPE STRING VALUE 'DESCRIPTION'.

    FIELD-SYMBOLS: <FT_VARIANT_CONTENT_NEW>    TYPE STANDARD TABLE,
                   <FT_VARIANT_CONTENT_OUTPUT> TYPE STANDARD TABLE,
                   <F_NEW_VALUE>               TYPE ANY,
                   <F_OUTPUT_VALUE>            TYPE ANY.

    DATA: LT_PARAMS                   TYPE /SMB/SB_I_004,
          LT_COMP_TAB                 TYPE CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
          LS_COMP                     TYPE LINE OF CL_ABAP_STRUCTDESCR=>COMPONENT_TABLE,
          LO_NEW_TAB                  TYPE REF TO CL_ABAP_TABLEDESCR,
          LO_ESTRUTURA                TYPE REF TO CL_ABAP_STRUCTDESCR,
          LO_VARIANT_CONTENT_DOWNLOAD TYPE REF TO DATA,
          L_VID                       TYPE N LENGTH 5,
          L_OUTPUT_VALUE              TYPE C LENGTH 255.


    LT_PARAMS = MS_ECATT_DEFINES-PARAMS.

    INSERT VALUE #( PNAME = GC_VARIANT ) INTO LT_PARAMS INDEX 1.
    INSERT VALUE #( PNAME = GC_DESCRIPTION ) INTO LT_PARAMS INDEX 2.

    LOOP AT LT_PARAMS ASSIGNING FIELD-SYMBOL(<FS_PARAMS>).
      LS_COMP-NAME = <FS_PARAMS>-PNAME.
      LS_COMP-TYPE = CL_ABAP_ELEMDESCR=>GET_STRING( ).
      APPEND LS_COMP TO LT_COMP_TAB.
    ENDLOOP.

    LO_ESTRUTURA = CL_ABAP_STRUCTDESCR=>CREATE( LT_COMP_TAB ).
    LO_NEW_TAB = CL_ABAP_TABLEDESCR=>CREATE( P_LINE_TYPE  = LO_ESTRUTURA
                                             P_TABLE_KIND = CL_ABAP_TABLEDESCR=>TABLEKIND_STD
                                             P_UNIQUE     = ABAP_FALSE ).

    CREATE DATA LO_VARIANT_CONTENT_DOWNLOAD TYPE HANDLE LO_NEW_TAB.

    ASSIGN MS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
    ASSIGN LO_VARIANT_CONTENT_DOWNLOAD->* TO <FT_VARIANT_CONTENT_OUTPUT>.

    APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_OUTPUT>).
    <FS_VARIANT_CONTENT_OUTPUT>-(GC_VARIANT) = |*|.
    LOOP AT LT_PARAMS ASSIGNING <FS_PARAMS>.
      <FS_VARIANT_CONTENT_OUTPUT>-(<FS_PARAMS>-PNAME) = <FS_PARAMS>-PDESC.
    ENDLOOP.
    APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_TDC>).
    <FS_VARIANT_CONTENT_TDC>-(GC_VARIANT) = |*REFERENCING|.

    LOOP AT MS_ECATT_DEFINES-TDC_DEFINE INTO DATA(LS_TDC_DEFINE).
      <FS_VARIANT_CONTENT_TDC>-(LS_TDC_DEFINE-PARAM_NAME) = |{ LS_TDC_DEFINE-ALIAS };{ LS_TDC_DEFINE-TDC_PARAM_NAME }|.
    ENDLOOP.

    L_VID = 0.
    LOOP AT <FT_VARIANT_CONTENT_NEW> ASSIGNING FIELD-SYMBOL(<FS_VARIANT_CONTENT_NEW>).
      APPEND INITIAL LINE TO <FT_VARIANT_CONTENT_OUTPUT> ASSIGNING <FS_VARIANT_CONTENT_OUTPUT>.
      ADD 1 TO L_VID.
      <FS_VARIANT_CONTENT_OUTPUT>-(GC_VARIANT) = |VAR{ L_VID }|.
      " MOVE-CORRESPONDING <FS_VARIANT_CONTENT_NEW> TO <FS_VARIANT_CONTENT_OUTPUT>.

      LOOP AT LT_PARAMS INTO DATA(LS_PARAMS).
        "WRITE <FS_VARIANT_CONTENT_NEW>-(LS_PARAMS-PNAME) TO <FS_VARIANT_CONTENT_OUTPUT>-(LS_PARAMS-PNAME).
        UNASSIGN: <F_NEW_VALUE>, <F_OUTPUT_VALUE>.
        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_NEW> TO <F_NEW_VALUE>.
        ASSIGN COMPONENT LS_PARAMS-PNAME OF STRUCTURE <FS_VARIANT_CONTENT_OUTPUT> TO <F_OUTPUT_VALUE>.

        IF <F_NEW_VALUE> IS ASSIGNED AND <F_OUTPUT_VALUE> IS ASSIGNED.
          L_OUTPUT_VALUE = <F_NEW_VALUE>.
          CONDENSE L_OUTPUT_VALUE NO-GAPS.
          IF L_OUTPUT_VALUE IS NOT INITIAL.
            WRITE <F_NEW_VALUE> TO L_OUTPUT_VALUE.
          ENDIF.

          <F_OUTPUT_VALUE> = L_OUTPUT_VALUE.
          CLEAR L_OUTPUT_VALUE.
          CONDENSE <F_OUTPUT_VALUE> NO-GAPS.
        ENDIF.

        IF <F_OUTPUT_VALUE> IS NOT INITIAL AND <F_OUTPUT_VALUE> CO '0123456789.,+-'.
          <F_OUTPUT_VALUE> = |#{ <F_OUTPUT_VALUE> }|.
        ENDIF.

        IF ( LS_PARAMS-PNAME = 'I_BP_LIFNR' OR LS_PARAMS-PNAME = 'I_BP_KUNNR' ) AND <FS_VARIANT_CONTENT_OUTPUT>-(GC_DESCRIPTION) IS INITIAL.
          <FS_VARIANT_CONTENT_OUTPUT>-(GC_DESCRIPTION) = <FS_VARIANT_CONTENT_OUTPUT>-(LS_PARAMS-PNAME).
        ENDIF.
      ENDLOOP.

    ENDLOOP.

    LT_PARAMS[ PNAME = GC_VARIANT ]-PNAME = |[{ GC_VARIANT }]|.
    LT_PARAMS[ PNAME = GC_DESCRIPTION ]-PNAME = |[{ GC_DESCRIPTION }]|.

    CL_GUI_FRONTEND_SERVICES=>GUI_DOWNLOAD(
      EXPORTING
*       BIN_FILESIZE            = BIN_FILESIZE         " File length for binary files
        FILENAME                = L_FULLPATH           " Name of file
        FILETYPE                = 'ASC'                " File type (ASCII, binary ...)
*       APPEND                  = SPACE                " Character Field of Length 1
        WRITE_FIELD_SEPARATOR   = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB                " Separate Columns by Tabs in Case of ASCII Download
*       HEADER                  = '00'                 " Byte Chain Written to Beginning of File in Binary Mode
*       TRUNC_TRAILING_BLANKS   = SPACE                " Do not Write Blank at the End of Char Fields
*       WRITE_LF                = 'X'                  " Insert CR/LF at End of Line in Case of Char Download
*       COL_SELECT              = SPACE                " Copy Only Selected Columns of the Table
*       COL_SELECT_MASK         = SPACE                " Vector Containing an 'X' for the Column To Be Copied
*       DAT_MODE                = SPACE                " Numeric and date fields are in DAT format in WS_DOWNLOAD
*       CONFIRM_OVERWRITE       = SPACE                " Overwrite File Only After Confirmation
*       NO_AUTH_CHECK           = SPACE                " Switch off Check for Access Rights
        CODEPAGE                = '4103'               " Character Representation for Output
*       IGNORE_CERR             = ABAP_TRUE            " Ignore character set conversion errors?
*       REPLACEMENT             = '#'                  " Replacement Character for Non-Convertible Characters
        WRITE_BOM               = ABAP_TRUE            " If set, writes a Unicode byte order mark
*       TRUNC_TRAILING_BLANKS_EOL = 'X'                 " Remove Trailing Blanks in Last Column
*       WK1_N_FORMAT            = SPACE
*       WK1_N_SIZE              = SPACE
*       WK1_T_FORMAT            = SPACE
*       WK1_T_SIZE              = SPACE
*       SHOW_TRANSFER_STATUS    = 'X'                  " Enables suppression of transfer status message
        FIELDNAMES              = LT_PARAMS            " Table Field Names
*       WRITE_LF_AFTER_LAST_LINE  = 'X'                  " Writes a CR/LF after final data record
*       VIRUS_SCAN_PROFILE      = '/SCET/GUI_DOWNLOAD' " Virus Scan Profile
*      IMPORTING
*       FILELENGTH              = FILELENGTH           " Number of bytes transferred
      CHANGING
        DATA_TAB                = <FT_VARIANT_CONTENT_OUTPUT>   " Transfer table
      EXCEPTIONS
        FILE_WRITE_ERROR        = 1                    " Cannot write to file
        NO_BATCH                = 2                    " Cannot execute front-end function in background
        GUI_REFUSE_FILETRANSFER = 3                    " Incorrect Front End
        INVALID_TYPE            = 4                    " Invalid value for parameter FILETYPE
        NO_AUTHORITY            = 5                    " No Download Authorization
        UNKNOWN_ERROR           = 6                    " Unknown error
        HEADER_NOT_ALLOWED      = 7                    " Invalid header
        SEPARATOR_NOT_ALLOWED   = 8                    " Invalid separator
        FILESIZE_NOT_ALLOWED    = 9                    " Invalid file size
        HEADER_TOO_LONG         = 10                   " Header information currently restricted to 1023 bytes
        DP_ERROR_CREATE         = 11                   " Cannot create DataProvider
        DP_ERROR_SEND           = 12                   " Error Sending Data with DataProvider
        DP_ERROR_WRITE          = 13                   " Error Writing Data with DataProvider
        UNKNOWN_DP_ERROR        = 14                   " Error when calling data provider
        ACCESS_DENIED           = 15                   " Access to File Denied
        DP_OUT_OF_MEMORY        = 16                   " Not enough memory in data provider
        DISK_FULL               = 17                   " Storage medium is full.
        DP_TIMEOUT              = 18                   " Data provider timeout
        FILE_NOT_FOUND          = 19                   " Could not find file
        DATAPROVIDER_EXCEPTION  = 20                   " General Exception Error in DataProvider
        CONTROL_FLUSH_ERROR     = 21                   " Error in Control Framework
        NOT_SUPPORTED_BY_GUI    = 22                   " GUI does not support this
        ERROR_NO_GUI            = 23                   " GUI not available
    ).
    IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDMETHOD.
  " IMPORTING  IS_ECATT_DEFINES TYPE LCL_BP_CREATOR_OF_AI=>TYP_ECATT_DEFINES  .
  METHOD SHOW_NEW_VFILE.
    MS_ECATT_DEFINES = CS_ECATT_DEFINES.

    CREATE OBJECT MO_DIALOG
      EXPORTING
*       PARENT                      = PARENT                  " Parent container
        WIDTH                       = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_BP_VFILE-MO_DIALOG-WIDTH' ]-SETTING_VALUE DEFAULT 2000 ) " Width of This Container
        HEIGHT                      = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_BP_VFILE-MO_DIALOG-HEIGHT' ]-SETTING_VALUE DEFAULT 300 ) " Height of This Container
*       STYLE                       = STYLE                   " Windows Style Attributes Applied to this Container
*       REPID                       = REPID                   " Report to Which This Control is Linked
*       DYNNR                       = DYNNR                   " Screen to Which the Control is Linked
*       LIFETIME                    = LIFETIME_DEFAULT        " Lifetime
        TOP                         = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_BP_VFILE-MO_DIALOG-TOP' ]-SETTING_VALUE DEFAULT 30 )                       " Top Position of Dialog Box
        LEFT                        = VALUE I( LCL_SETTING=>MT_SETTING[ SETTING_ID = 'SHOW_NEW_BP_VFILE-MO_DIALOG-LEFT' ]-SETTING_VALUE DEFAULT 30 )                       " Left Position of Dialog Box
        CAPTION                     = MS_ECATT_DEFINES-ECATT  " Dialog Box Caption
*       NO_AUTODEF_PROGID_DYNNR     = NO_AUTODEF_PROGID_DYNNR " Don't Autodefined Progid and Dynnr?
*       METRIC                      = 0                       " Metric
*       NAME                        = NAME                    " Name
      EXCEPTIONS
        CNTL_ERROR                  = 1                       " CNTL_ERROR
        CNTL_SYSTEM_ERROR           = 2                       " CNTL_SYSTEM_ERROR
        CREATE_ERROR                = 3                       " CREATE_ERROR
        LIFETIME_ERROR              = 4                       " LIFETIME_ERROR
        LIFETIME_DYNPRO_DYNPRO_LINK = 5                       " LIFETIME_DYNPRO_DYNPRO_LINK
        EVENT_ALREADY_REGISTERED    = 6                       " Event Already Registered
        ERROR_REGIST_EVENT          = 7.                       " Error While Registering Event

    "    MS_LAYOUT-GRID_TITLE = 'BP Editor'(100).
    MS_LAYOUT-EDIT = ABAP_TRUE.
    MS_LAYOUT-SEL_MODE = 'A'.
    MS_LAYOUT-COL_OPT = ABAP_TRUE.
    MS_LAYOUT-CWIDTH_OPT = ABAP_TRUE.
    MS_LAYOUT-CTAB_FNAME = LCL_SCREEN_1000=>MC_FIELD_TABCOL.

    DATA(L_SPLITTER_MAIN) = NEW CL_GUI_SPLITTER_CONTAINER(
      PARENT  = MO_DIALOG
      ROWS    = 1
      COLUMNS = 1 ).

    MO_GRID_SOURCE = NEW CL_GUI_ALV_GRID(
                I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
                ROW    = 1
                COLUMN = 1 ) ).

    MT_FIELDCATALOG = CS_ECATT_DEFINES-FIELDCATALOG.

    LOOP AT MT_FIELDCATALOG ASSIGNING FIELD-SYMBOL(<FS_FIELDCATALOG>).
      IF <FS_FIELDCATALOG>-FIELDNAME+0(2) <> 'I_'.
        <FS_FIELDCATALOG>-NO_OUT = ABAP_TRUE.
      ENDIF.

      CASE <FS_FIELDCATALOG>-FIELDNAME.
        WHEN 'I_BP_KUNNR' OR 'I_BP_LIFNR'.
          <FS_FIELDCATALOG>-COL_POS = 1.
        WHEN 'I_GROUPING'.
          <FS_FIELDCATALOG>-COL_POS = 2.
        WHEN OTHERS.
      ENDCASE.
    ENDLOOP.

    FIELD-SYMBOLS <FT_VARIANT_CONTENT_NEW> TYPE STANDARD TABLE.
    ASSIGN CS_ECATT_DEFINES-VARIANT_CONTENT_NEW->* TO <FT_VARIANT_CONTENT_NEW>.
    MO_GRID_SOURCE->SET_TABLE_FOR_FIRST_DISPLAY(
      EXPORTING
        IS_LAYOUT                     = MS_LAYOUT            " Layout
      CHANGING
        IT_OUTTAB                     = <FT_VARIANT_CONTENT_NEW>   " Output Table
        IT_FIELDCATALOG               = MT_FIELDCATALOG " Field Catalog
      EXCEPTIONS
        INVALID_PARAMETER_COMBINATION = 1                    " Wrong Parameter
        PROGRAM_ERROR                 = 2                    " Program Errors
        TOO_MANY_LINES                = 3                    " Too many Rows in Ready for Input Grid
    ).
    " BCALV_GRID_05 -233
    SET HANDLER ON_HANDLE_USER_COMMAND FOR MO_GRID_SOURCE.
    SET HANDLER ON_HANDLE_TOOLBAR FOR MO_GRID_SOURCE.
    SET HANDLER ON_NEW_BP_DLG_CLOSE FOR MO_DIALOG.

    CALL METHOD MO_GRID_SOURCE->SET_TOOLBAR_INTERACTIVE.

  ENDMETHOD.

  METHOD ON_NEW_BP_DLG_CLOSE.
    IF MO_DIALOG IS NOT INITIAL.
      MO_DIALOG->GET_TOP(
        IMPORTING
          TOP        = DATA(L_TOP) " Current Top Coordinate of Control
        EXCEPTIONS
          CNTL_ERROR = 1   " cntl_error
      ).
      CL_GUI_CFW=>FLUSH( ).
      LCL_SETTING=>MODIFY_SETTING(
        I_SETTING_ID    = 'SHOW_NEW_BP_VFILE-MO_DIALOG-TOP'
        I_SETTING_VALUE = CONV #( L_TOP )
      ).

      MO_DIALOG->GET_LEFT(
        IMPORTING
          LEFT       = DATA(L_LEFT) " Current Left Coordinate of Control
        EXCEPTIONS
          CNTL_ERROR = 1    " cntl_error
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
      CL_GUI_CFW=>FLUSH( ).
      LCL_SETTING=>MODIFY_SETTING(
        I_SETTING_ID    = 'SHOW_NEW_BP_VFILE-MO_DIALOG-LEFT'
        I_SETTING_VALUE = CONV #( L_LEFT )
      ).

      MO_DIALOG->GET_WIDTH(
        IMPORTING
          WIDTH      = DATA(L_WIDTH) " Current Width
        EXCEPTIONS
          CNTL_ERROR = 1     " cntl_error
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
      CL_GUI_CFW=>FLUSH( ).
      LCL_SETTING=>MODIFY_SETTING(
        I_SETTING_ID    = 'SHOW_NEW_BP_VFILE-MO_DIALOG-WIDTH'
        I_SETTING_VALUE = CONV #( L_WIDTH )
      ).
      MO_DIALOG->GET_HEIGHT(
        IMPORTING
          HEIGHT     = DATA(L_HEIGHT) " Current Height
        EXCEPTIONS
          CNTL_ERROR = 1      " cntl_error
      ).
      IF SY-SUBRC <> 0.
*       MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
      CL_GUI_CFW=>FLUSH( ).
      LCL_SETTING=>MODIFY_SETTING(
        I_SETTING_ID    = 'SHOW_NEW_BP_VFILE-MO_DIALOG-HEIGHT'
        I_SETTING_VALUE = CONV #( L_HEIGHT )
      ).

      MO_DIALOG->FREE(  ).
      CLEAR MO_DIALOG.
    ENDIF.
  ENDMETHOD.
ENDCLASS.
