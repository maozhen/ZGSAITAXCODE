*&---------------------------------------------------------------------*
*& Report ZABAP_AI_0001
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZABAP_AI_0001.
TYPE-POOLS: ICON.
TABLES: SCPRATTR, SCPRVALS.
CONSTANTS: G_ASK_AI               TYPE SY-UCOMM VALUE 'ASK_AI',
           G_NEW_CONVERSATION     TYPE SY-UCOMM VALUE 'NEW_CV',
           G_SAVE_CONVERSATION    TYPE SY-UCOMM VALUE 'SAVE_CV',
           G_DEL_CONVERSATION     TYPE SY-UCOMM VALUE 'DEL_CV',
           G_CLS_CONVERSATION     TYPE SY-UCOMM VALUE 'CLS_CV',
           G_RNAME_CONVERSATION   TYPE SY-UCOMM VALUE 'RENAME_CV',
           G_SYSROLE_CONVERSATION TYPE SY-UCOMM VALUE 'SYSROLE_CV',
           G_REPROC_CONVERSATION  TYPE SY-UCOMM VALUE 'REPROC_CV'.

CLASS:
  CL_AI_PROXY DEFINITION DEFERRED,
  CL_SCREEN_0100_HANDLER DEFINITION DEFERRED,
  CL_TAX_CODE_PROCESSER DEFINITION DEFERRED,
  CL_CODE_PROCESSER DEFINITION DEFERRED,
  CL_AI_RESULT_PROCESSER DEFINITION DEFERRED,
  CL_CONVERSATION DEFINITION DEFERRED,
  CL_CONVERSATION_MANAGER DEFINITION DEFERRED,
  CL_TALK_SHOW DEFINITION DEFERRED.

INCLUDE ZABAP_AI_I0001.

DATA: OK_CODE        TYPE SY-UCOMM,
      GO_SCREEN_0100 TYPE REF TO CL_SCREEN_0100_HANDLER.

*Get new name of conversaion
SELECTION-SCREEN BEGIN OF SCREEN 9900.
  PARAMETERS: P_NAME TYPE STRING.
SELECTION-SCREEN END OF SCREEN 9900.

SELECTION-SCREEN BEGIN OF SCREEN 9800.
  PARAMETERS: P_MDLID TYPE AIC_D_MODEL_ID DEFAULT CL_AI_PROXY=>G_MODULE_GPT4O OBLIGATORY,
              P_SCNID TYPE CL_AI_PROXY=>AIC_D_APPL_SCEN_ID  DEFAULT 'GS_CONTENT_AI_TEST'  OBLIGATORY,
              P_PRCNM TYPE SEOCLSNAME DEFAULT 'CL_TAX_CODE_PROCESSER'.
SELECTION-SCREEN END OF SCREEN 9800.

*&---------------------------------------------------------------------*
*& Global Declarations                                                 *
*&---------------------------------------------------------------------*
* Class Definitions
CLASS LCL_ZABAP_AI_001_TEST DEFINITION FOR TESTING RISK LEVEL HARMLESS DURATION SHORT.
  PRIVATE SECTION.
    CLASS-DATA: ENVIROMENT TYPE REF TO IF_OSQL_TEST_ENVIRONMENT.
    CLASS-METHODS: CLASS_SETUP.
    CLASS-METHODS: CLASS_TERADOWN.

    DATA: _ANSWER_STR            TYPE STRING,
          _JSON_STR              TYPE STRING,
          _PROMPT                TYPE STRING,
          _LO_AI_PROXY           TYPE REF TO CL_AI_PROXY,
          _LO_TAX_CODE_PROCESSER TYPE REF TO CL_TAX_CODE_PROCESSER,
          _JSON_OBJ_PARSER       TYPE REF TO /UI2/CL_JSON.

    DATA: LO_TALK_SHOW      TYPE REF TO CL_TALK_SHOW,
          LO_HOSTER         TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_01 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_02 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_03 TYPE REF TO CL_CONVERSATION.


    METHODS:
      SETUP,
      TEARDOWN.

    METHODS:
      _01_JSON_DESERIALIZE        , "FOR TESTING
      _02_REGULAR_EXPRESS             FOR TESTING,
      _03_PROCESS_TAX_CODE        , "FOR TESTING
      _04_ACTIVATE_TAX_CODE       , "FOR TESTING
      _05_TALK_SHOW_001            FOR TESTING,
      _05_TALK_SHOW_002            FOR TESTING,
      _05_TALK_SHOW_003            FOR TESTING.

ENDCLASS.

CLASS CL_TALK_SHOW DEFINITION.
  PUBLIC SECTION.
    TYPES: BEGIN OF TYP_PARTICIPANT,
             ID          TYPE I,
             PARTICIPANT TYPE REF TO CL_CONVERSATION,
           END OF TYP_PARTICIPANT,
           TBL_PARTICIPANT TYPE STANDARD TABLE OF TYP_PARTICIPANT WITH EMPTY KEY.

    DATA: LT_PARTICIPANTS TYPE TBL_PARTICIPANT,
          LO_HOSTER       TYPE REF TO CL_CONVERSATION,
          LV_TOPIC        TYPE STRING,
          LV_MAX_ROUND    TYPE I VALUE 10,
          LV_ROUNDS       TYPE I VALUE 0,
          LV_SCORE        TYPE I VALUE 0,
          LV_ID           TYPE I VALUE 0.

    METHODS:
      CONSTRUCTOR IMPORTING I_MAX_ROUND TYPE I,
      SET_MAX_ROUND IMPORTING I_MAX_ROUND TYPE I,
      SET_TOPIC IMPORTING IV_TOPIC TYPE STRING,
      ADD_PARTICIPANT IMPORTING IO_PARTICAIPANT TYPE REF TO CL_CONVERSATION,
      SET_HOSTER IMPORTING IO_HOSTER TYPE REF TO CL_CONVERSATION,
      GET_HOSTER RETURNING VALUE(RO_HOSTER) TYPE REF TO CL_CONVERSATION,
      SAVE_TO_DB,
      START_SHOW,
      EVALUATE_OPINION IMPORTING IV_OPINION TYPE STRING RETURNING VALUE(RV_SCORE) TYPE I.
ENDCLASS.

CLASS CL_CONVERSATION_MANAGER DEFINITION.
  PUBLIC SECTION.
    TYPES: BEGIN OF TYP_CONVERSION,
             ID                TYPE SYSUUID_C,
             CONVERSATION      TYPE REF TO CL_CONVERSATION,
             NODE_KEY          TYPE  LVC_NKEY,
             NAME              TYPE  STRING,
             CURR_CONVERSATION TYPE C LENGTH 1,
           END OF TYP_CONVERSION,
           TBL_CONVERSION TYPE TABLE OF TYP_CONVERSION,

           BEGIN OF TYP_DISPLAY.
             INCLUDE TYPE CL_CONVERSATION=>TYP_CONVERSTION_INFO.
    TYPES: NODE_KEY TYPE  LVC_NKEY,
           END OF TYP_DISPLAY,
           TBL_DISPLAY TYPE TABLE OF TYP_DISPLAY.

    METHODS: CONSTRUCTOR IMPORTING IO_SCREEN_HANDLER TYPE REF TO CL_SCREEN_0100_HANDLER,
      INIT_CONVERSATION_MANGER IMPORTING IO_CONTAINER TYPE REF TO CL_GUI_CONTAINER,
      INIT_TREE IMPORTING IO_CONTAINER TYPE REF TO CL_GUI_CONTAINER,
      INIT_HTML IMPORTING IO_CONTAINER TYPE REF TO CL_GUI_CONTAINER,
      CREATE_CONVERSION IMPORTING I_MODULE_ID          TYPE AIC_D_MODEL_ID
                                  I_SCEN_ID            TYPE CL_AI_PROXY=>AIC_D_APPL_SCEN_ID
                                  I_PROCESSER          TYPE SEOCLSNAME
                        RETURNING VALUE(RS_CONVERSION) TYPE TYP_CONVERSION,
      APPEND_CONVERSION_TREE,
      SAVE_CONVERSTION,
      LOAD_CONVERSTION,
      SHOW_CONVERSION IMPORTING IO_CONVERSATION TYPE REF TO CL_CONVERSATION,
      SHOW_INFO IMPORTING IO_CONVERSATION TYPE REF TO CL_CONVERSATION,
      UPDATE_NODE_ICON IMPORTING I_NODE_KEY  TYPE LVC_NKEY
                                 I_ICON_NAME TYPE ICON-ID,
      ASK_AI IMPORTING I_QUESTION             TYPE STRING
             RETURNING VALUE(RO_CONVERSATION) TYPE REF TO CL_CONVERSATION.

    METHODS: HANDLE_NODE_DOUBLE_CLICK
      FOR EVENT NODE_DOUBLE_CLICK OF CL_GUI_ALV_TREE
      IMPORTING NODE_KEY ,
      HANDLE_NODE_CTMENU_REQUEST
        FOR EVENT NODE_CONTEXT_MENU_REQUEST OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY
                  MENU,
      HANDLE_NODE_CTMENU_SELECTED
        FOR EVENT NODE_CONTEXT_MENU_SELECTED OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY
                  FCODE,
      HANDLE_ITEM_CTMENU_REQUEST
        FOR EVENT ITEM_CONTEXT_MENU_REQUEST OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY
                  FIELDNAME
                  MENU,
      HANDLE_ITEM_CTMENU_SELECTED
        FOR EVENT ITEM_CONTEXT_MENU_SELECTED OF CL_GUI_ALV_TREE
        IMPORTING NODE_KEY
                  FIELDNAME
                  FCODE,
      ON_SAPEVENT
        FOR EVENT SAPEVENT OF CL_GUI_HTML_VIEWER
        IMPORTING ACTION FRAME GETDATA POSTDATA QUERY_TABLE,
      ON_SYSROLE_DLG_CLOSE
        FOR EVENT CLOSE
        OF CL_GUI_DIALOGBOX_CONTAINER.

  PRIVATE SECTION.
    DATA: _CONVERSATION_TREE             TYPE REF TO CL_GUI_ALV_TREE,
          _CONVERSATION_HTML             TYPE REF TO CL_GUI_HTML_VIEWER,
          _FAV_KEY                       TYPE LVC_NKEY,
          _CON_KEY                       TYPE LVC_NKEY,
          _ROT_KEY                       TYPE LVC_NKEY,
          _CURRENT_KEY                   TYPE LVC_NKEY,
          _T_CONVERSIONS                 TYPE TBL_CONVERSION,
          _T_DISPLAY                     TYPE TBL_DISPLAY,
          _T_FIELDCATALOG                TYPE LVC_T_FCAT,
          _SCREEN_HANDLER                TYPE REF TO CL_SCREEN_0100_HANDLER,
          _SYSTEM_ROLE_TEXTEDIT          TYPE REF TO CL_GUI_TEXTEDIT,
          _SYSTEM_ROLE_DIALOGBOX         TYPE REF TO CL_GUI_DIALOGBOX_CONTAINER,
          _SYSTEM_ROLE_DIALOGBOX_SETTING TYPE INDX-RELID.

ENDCLASS.


CLASS CL_CHANGE_LIST_PROCESSER DEFINITION INHERITING FROM CL_AI_RESULT_PROCESSER.

ENDCLASS.

CLASS CL_CODE_PROCESSER DEFINITION INHERITING FROM CL_AI_RESULT_PROCESSER.
  PUBLIC SECTION.
    METHODS:
      PROCESS REDEFINITION.

ENDCLASS.

CLASS CL_PROMPT_PROCESSER DEFINITION INHERITING FROM CL_AI_RESULT_PROCESSER.
  PUBLIC SECTION.
    METHODS:
      PROCESS REDEFINITION.

ENDCLASS.

CLASS CL_TAX_CODE_PROCESSER DEFINITION INHERITING FROM CL_AI_RESULT_PROCESSER.
  PUBLIC SECTION.
    TYPES: BEGIN OF TYP_REC_ID_MAPPING,
             TABLENAME TYPE STRING,
             REC_ID    TYPE I,
           END OF TYP_REC_ID_MAPPING,
           TBL_REC_ID_MAPPING TYPE TABLE OF TYP_REC_ID_MAPPING.

    TYPES: TBL_T007A TYPE STANDARD TABLE OF T007A WITH DEFAULT KEY,
           TBL_T007S TYPE STANDARD TABLE OF T007S WITH DEFAULT KEY,
           TBL_T007V TYPE STANDARD TABLE OF V_T007V WITH DEFAULT KEY,
           BEGIN OF TYP_ACTIVATE_TAX_CODE,
             TBL_T007A   TYPE TBL_T007A,
             TBL_T007S   TYPE TBL_T007S,
             TBL_V_T007V TYPE TBL_T007V,
           END OF TYP_ACTIVATE_TAX_CODE,
           TBL_ACTIVATE_TAX_CODE TYPE TABLE OF TYP_ACTIVATE_TAX_CODE,
           BEGIN OF TYP_TAX_CODE_PROPERTY,
             NAME          TYPE STRING,
             COUNTRYCODE   TYPE STRING,
             TAXCODE       TYPE STRING,
             TAXRATE       TYPE STRING,
             DESCRIPTION   TYPE STRING,
             TAXTYPE       TYPE STRING,
             CONDITIONTYPE TYPE STRING,
             VALIDON       TYPE STRING,
             VALIDEND      TYPE STRING,
           END OF TYP_TAX_CODE_PROPERTY,
           BEGIN OF TYP_METHOD.
             INCLUDE TYPE TYP_TAX_CODE_PROPERTY.
    TYPES: FIELD_EXTRACTION_SOURCE TYPE TYP_TAX_CODE_PROPERTY,
             BUTTON                  TYPE STRING,
           END OF TYP_METHOD,

           TBL_METHOD TYPE STANDARD TABLE OF TYP_METHOD WITH EMPTY KEY,
           BEGIN OF TYP_ACTION_ITEM,
             ID          TYPE STRING,
             TITLE       TYPE STRING,
             DESCRIPTION TYPE STRING,
             ACTIONTYPE  TYPE STRING,
             METHODS     TYPE TBL_METHOD,
           END OF TYP_ACTION_ITEM,
           TBL_ACTION_ITEM TYPE STANDARD TABLE OF TYP_ACTION_ITEM.

    METHODS:
      CONSTRUCTOR,
      PROCESS REDEFINITION.

  PRIVATE SECTION.
    METHODS:
      EXTRACE_ACTION_ITEMS IMPORTING I_JSON_DATA    TYPE REF TO DATA
                           EXPORTING ET_ACTION_ITEM TYPE TBL_ACTION_ITEM,
      CONVERT_TAX_CODES IMPORTING IT_ACTION_ITEM TYPE TBL_ACTION_ITEM
                        EXPORTING ET_TAX_CODES   TYPE TBL_ACTIVATE_TAX_CODE,
      ACTIVATE_TAX_CODES IMPORTING IT_TAX_CODES      TYPE TBL_ACTIVATE_TAX_CODE
                         RETURNING VALUE(E_BCSET_ID) TYPE SCPR_ID,
      SHOW_TAX_CODES CHANGING  CT_ACTION_ITEM             TYPE TBL_ACTION_ITEM
                     RETURNING VALUE(E_ACTIVATE_TAX_CODE) TYPE ABAP_BOOL,
      ON_TAX_CODE_DLG_CLOSE FOR EVENT CLOSE OF CL_GUI_DIALOGBOX_CONTAINER,
      ON_BUTTON_CLICK FOR EVENT BUTTON_CLICK OF CL_GUI_ALV_GRID IMPORTING ES_COL_ID ES_ROW_NO.
    DATA:
      _JSON_DATA        TYPE CL_AI_RESULT_PROCESSER=>TBL_DATA,
      _T_ACTION_ITEM    TYPE TBL_ACTION_ITEM,
      _T_TAX_CODES      TYPE TBL_ACTIVATE_TAX_CODE,
      _BCSET_ID         TYPE SCPR_ID,
      _T_REC_ID_MAPPING TYPE TBL_REC_ID_MAPPING,
      LO_DIALOG         TYPE REF TO CL_GUI_DIALOGBOX_CONTAINER.

*      TYPES: BEGIN OF TYP_TAX_CODE_DISPLAY,
*               BUTTON TYPE STRING,
*               ALAND  TYPE T007V-ALAND,
*               MWSKZ  TYPE T007A-MWSKZ,
*               KBETR  TYPE T007V-KBETR,
*               MWART  TYPE T007A-MWART,
*               TEXT1  TYPE T007S-TEXT1,
*               KSCHL  TYPE T007V-KSCHL,
*               DATAM  TYPE T007V-DATAM,
*               DATUM  TYPE T007V-DATUM,
*             END OF TYP_TAX_CODE_DISPLAY,
*             TBL_TAX_CODE_DISPLAY TYPE TABLE OF TYP_TAX_CODE_DISPLAY WITH EMPTY KEY.

    DATA: LT_TAX_CODE_DISPLAY TYPE TBL_METHOD.
    DATA: LT_TAX_CODE_ORIGINAL TYPE TABLE OF TYP_METHOD-FIELD_EXTRACTION_SOURCE.

ENDCLASS.



CLASS CL_SCREEN_0100_HANDLER DEFINITION CREATE PRIVATE.
  PUBLIC SECTION.
    CLASS-METHODS: GET_INSTANCE IMPORTING " io_ai_proxy                   type ref to cl_ai_proxy optional
                                          " io_tax_code_processer        type ref to cl_tax_code_processer optional
                                          IO_CONVERSATION_MANAGER      TYPE REF TO CL_CONVERSATION_MANAGER OPTIONAL
                                RETURNING VALUE(R_SCREEN_0100_HANDLER) TYPE REF TO CL_SCREEN_0100_HANDLER .
    METHODS:
*      assign_ai_proxy importing io_ai_proxy type ref to cl_ai_proxy,
*      assign_tax_code_processer importing io_tax_code_processer type ref to cl_tax_code_processer,
*      assign_conversation_manager  importing io_conversation_manager type ref to cl_conversation_manager,
      ASK_AI,
      SHOW_CONVERSION IMPORTING IO_CONVERSATION TYPE REF TO CL_CONVERSATION,
      NEW_CONVERSATION,
      SAVE_CONVERSATION.

  PRIVATE SECTION.
    CLASS-DATA: _SCREEN_0100_HANDLER TYPE REF TO CL_SCREEN_0100_HANDLER.

    DATA: _OUTPUT_EDIT          TYPE REF TO CL_GUI_TEXTEDIT,
          _INPUT_EDIT           TYPE REF TO CL_GUI_TEXTEDIT,
          _CONVERSATION_MANAGER TYPE REF TO CL_CONVERSATION_MANAGER.
*          _ai_proxy              type ref to cl_ai_proxy,
*          _tax_code_processer   type ref to cl_tax_code_processer.

    METHODS:
      CONSTRUCTOR,
      INIT_SCREEN_0100,
      INIT_INPUT_OUTPUT IMPORTING IO_CONTAINER TYPE REF TO CL_GUI_CONTAINER,
      INIT_CONVERSATION_MANGER IMPORTING IO_CONTAINER TYPE REF TO CL_GUI_CONTAINER,
      FILL_INIT_QUESTION IMPORTING I_QUESTION TYPE STRING DEFAULT SPACE,
      GET_INPUT RETURNING VALUE(R_TEXT) TYPE STRING,
      GET_OUTPUT RETURNING VALUE(R_TEXT) TYPE STRING,
      SET_OUTPUT IMPORTING I_TEXT TYPE STRING,
      SET_INPUT IMPORTING I_TEXT TYPE STRING,
      APPEND_OUTPUT IMPORTING I_TEXT TYPE STRING,
      CLEAR_INPUT.

ENDCLASS.                    "screen_handler DEFINITION

* Class Implementations

CLASS CL_CONVERSATION_MANAGER IMPLEMENTATION.
  METHOD CREATE_CONVERSION.
    APPEND INITIAL LINE TO _T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSIONS>).
    <FS_CONVERSIONS>-CONVERSATION = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = I_MODULE_ID I_SCEN_ID = I_SCEN_ID I_PROCESSER = I_PROCESSER ).
    <FS_CONVERSIONS>-ID = <FS_CONVERSIONS>-CONVERSATION->INFO( )-ID.
    RS_CONVERSION = <FS_CONVERSIONS>.
  ENDMETHOD.

  METHOD APPEND_CONVERSION_TREE.
    DATA: L_LAYOUT_NODE TYPE LVC_S_LAYN,
          L_RELAT_KEY   TYPE LVC_NKEY,
          L_OUTPUT_LINE TYPE TYP_DISPLAY.

    LOOP AT ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSIONS>) WHERE NODE_KEY IS INITIAL.
      L_LAYOUT_NODE-ISFOLDER = 'X'.   "=>add a folder, NOT a leaf
      L_LAYOUT_NODE-N_IMAGE = SPACE. "=>Display an icon

      CALL METHOD _CONVERSATION_TREE->ADD_NODE
        EXPORTING
          I_RELAT_NODE_KEY = _CON_KEY
          I_RELATIONSHIP   = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD
          I_NODE_TEXT      = CONV #( <FS_CONVERSIONS>-CONVERSATION->INFO( )-NAME )
          IS_NODE_LAYOUT   = L_LAYOUT_NODE
        IMPORTING
          E_NEW_NODE_KEY   = <FS_CONVERSIONS>-NODE_KEY.

      CALL METHOD _CONVERSATION_TREE->GET_OUTTAB_LINE
        EXPORTING
          I_NODE_KEY     = <FS_CONVERSIONS>-NODE_KEY " Node Key
        IMPORTING
          E_OUTTAB_LINE  = L_OUTPUT_LINE    " Line of Outtab
*         e_node_text    =                  " node text
*         et_item_layout =                  " Layout structure for items of the ALV tree control
*         es_node_layout =                  " Node Layout of ALV Tree Control
        EXCEPTIONS
          NODE_NOT_FOUND = 1                " Node does not exist
          OTHERS         = 2.
      IF SY-SUBRC <> 0.
        MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
        WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.

      MOVE-CORRESPONDING <FS_CONVERSIONS>-CONVERSATION->INFO( ) TO L_OUTPUT_LINE.
      MOVE-CORRESPONDING <FS_CONVERSIONS> TO L_OUTPUT_LINE.

      CALL METHOD _CONVERSATION_TREE->CHANGE_NODE
        EXPORTING
          I_NODE_KEY     = <FS_CONVERSIONS>-NODE_KEY " Key of Changed Line
          I_OUTTAB_LINE  = L_OUTPUT_LINE  " Outtab Line to be Changed
*         is_node_layout =                  " Node Layout
*         it_item_layout =                  " Item Layout
*         i_node_text    =                  " Node Text
*         i_u_node_text  =                  " 'X': Change Node Text
        EXCEPTIONS
          NODE_NOT_FOUND = 1                " Node does not exist
          OTHERS         = 2.
      IF SY-SUBRC <> 0.
*       message id sy-msgid type sy-msgty number sy-msgno
*         with sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ENDIF.

    ENDLOOP.

    CALL METHOD _CONVERSATION_TREE->FRONTEND_UPDATE.

  ENDMETHOD.

  METHOD LOAD_CONVERSTION.
    SELECT SRTFD FROM INDX INTO TABLE @DATA(LT_INDX)
     WHERE RELID = 'CV' AND SRTF2 = 0 . " AND USERA = @SY-UNAME.
    LOOP AT LT_INDX ASSIGNING FIELD-SYMBOL(<FS_INDX>).
      APPEND INITIAL LINE TO _T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSIONS>).
      <FS_CONVERSIONS>-CONVERSATION = CL_CONVERSATION=>LOAD_FROM_DB( CONV #( <FS_INDX>-SRTFD ) ).
      <FS_CONVERSIONS>-ID = <FS_CONVERSIONS>-CONVERSATION->INFO( )-ID.
      <FS_CONVERSIONS>-NAME = <FS_CONVERSIONS>-CONVERSATION->INFO( )-NAME.
    ENDLOOP.

    SORT _T_CONVERSIONS BY NAME.
  ENDMETHOD.

  METHOD SAVE_CONVERSTION.
    LOOP AT _T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSION>).
      <FS_CONVERSION>-CONVERSATION->SAVE_TO_DB( ).
    ENDLOOP.
  ENDMETHOD.

  METHOD SHOW_CONVERSION.
    ME->_SCREEN_HANDLER->SHOW_CONVERSION( IO_CONVERSATION ).
  ENDMETHOD.

  METHOD SHOW_INFO.
    DATA(LS_INFO) = IO_CONVERSATION->INFO( ).

    DATA LS_PROCESS_NAME TYPE STRING.

    DATA(L_OPTONS) = VALUE W3_HTMLTAB( FOR P IN CL_AI_RESULT_PROCESSER=>LIST_SUB_PROCESSER( )
                                   ( | <option value="{ P-PROCESSER }" { COND #( WHEN P-PROCESSER = LS_INFO-PROCESSER THEN 'selected' ELSE '' ) }>{ P-DESCRIPT }</option>| )
                                   ) .
    DATA(LT_HTML_TAB) = VALUE W3_HTMLTAB(
          ( |<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">| )
          ( |<html><body><basefont face="arial" size="1">| )
          ( |<form method="post" action="SAPEVENT:SUBMIT_PROCESSER">| )
          ( |<b>Name： { LS_INFO-NAME } </b><input type="submit" value="Submit">| )
          ( |<input name="id" value="{ LS_INFO-ID }" type="hidden">| )
          ( |<br><br>| )
          ( |<label for="cmb_processer">Processer ：</label>| )
          ( |<select id="cmb_processer" name="cmb_processer">| )
          ( |<option value=""></option>| ) ).

    APPEND LINES OF VALUE W3_HTMLTAB( FOR P IN CL_AI_RESULT_PROCESSER=>LIST_SUB_PROCESSER( )
                                   ( | <option value="{ P-PROCESSER }" { COND #( WHEN P-PROCESSER = LS_INFO-PROCESSER THEN 'selected' ELSE '' ) }>{ P-DESCRIPT }</option>| )
                                   ) TO LT_HTML_TAB.
    APPEND LINES OF VALUE W3_HTMLTAB(
          ( |</select>| )


          ( |</body></html>| ) ) TO LT_HTML_TAB.

    DATA L_HTML_URL TYPE C LENGTH 255.
    _CONVERSATION_HTML->LOAD_DATA(
      IMPORTING
        ASSIGNED_URL = L_HTML_URL
      CHANGING
        DATA_TABLE   = LT_HTML_TAB ).

    _CONVERSATION_HTML->SHOW_URL(
      EXPORTING
        URL = L_HTML_URL ).

  ENDMETHOD.

  METHOD UPDATE_NODE_ICON.
    DATA: L_OUTTAB_LINE         TYPE  TYP_DISPLAY,
          LS_NODE_LAYOUT_UPDATE TYPE LVC_S_LACN.
    ME->_CONVERSATION_TREE->GET_OUTTAB_LINE(
      EXPORTING
        I_NODE_KEY     = I_NODE_KEY            " Node Key
      IMPORTING
        E_OUTTAB_LINE  = L_OUTTAB_LINE         " Line of Outtab
        E_NODE_TEXT    = DATA(L_NODE_TEXT)     " node text
        ET_ITEM_LAYOUT = DATA(LT_ITEM_LAYOUT)  " Layout structure for items of the ALV tree control
        ES_NODE_LAYOUT = DATA(LS_NODE_LAYOUT)  " Node Layout of ALV Tree Control LVC_S_LAYN
      EXCEPTIONS
        NODE_NOT_FOUND = 1                     " Node does not exist
        OTHERS         = 2
    ).

    MOVE-CORRESPONDING LS_NODE_LAYOUT TO LS_NODE_LAYOUT_UPDATE.
    LS_NODE_LAYOUT_UPDATE-N_IMAGE = I_ICON_NAME.
    LS_NODE_LAYOUT_UPDATE-EXP_IMAGE = I_ICON_NAME.
    LS_NODE_LAYOUT_UPDATE-U_N_IMAGE = ABAP_TRUE.
    LS_NODE_LAYOUT_UPDATE-U_EXP_IMAG = ABAP_TRUE.
    ME->_CONVERSATION_TREE->CHANGE_NODE(
      EXPORTING
        I_NODE_KEY     = I_NODE_KEY      " Key of Changed Line
        I_OUTTAB_LINE  = L_OUTTAB_LINE   " Outtab Line to be Changed
        IS_NODE_LAYOUT = LS_NODE_LAYOUT_UPDATE  " Node Layout LVC_S_LACN
*       it_item_layout = conv #( ls_node_layout )   " Item Layout
*       i_node_text    =                  " Node Text
*       i_u_node_text  =                  " 'X': Change Node Text
      EXCEPTIONS
        NODE_NOT_FOUND = 1                " Node does not exist
        OTHERS         = 2
    ).

    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDMETHOD.

  METHOD HANDLE_NODE_CTMENU_REQUEST.
    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = G_CLS_CONVERSATION        "#EC NOTEXT
        TEXT  = 'Clearn conversation'.   "#EC NOTEXT

    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = G_DEL_CONVERSATION        "#EC NOTEXT
        TEXT  = 'Delete conversation'.   "#EC NOTEXT
    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = G_RNAME_CONVERSATION        "#EC NOTEXT
        TEXT  = 'Rename conversation'.   "#EC NOTEXT
    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = G_SYSROLE_CONVERSATION        "#EC NOTEXT
        TEXT  = 'System role'.   "#EC NOTEXT

    CALL METHOD MENU->ADD_SEPARATOR.

    CALL METHOD MENU->ADD_FUNCTION
      EXPORTING
        FCODE = G_REPROC_CONVERSATION        "#EC NOTEXT
        TEXT  = 'Reprocess by...'.   "#EC NOTEXT

  ENDMETHOD.

  METHOD HANDLE_NODE_CTMENU_SELECTED.
    _CURRENT_KEY = NODE_KEY.
    READ TABLE ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSION>) WITH KEY NODE_KEY = NODE_KEY.
    CHECK SY-SUBRC = 0.
    CASE FCODE.
      WHEN G_CLS_CONVERSATION.
        <FS_CONVERSION>-CONVERSATION->CLEAR( ).
      WHEN G_DEL_CONVERSATION.
        <FS_CONVERSION>-CONVERSATION->DELETE( ).
        DELETE ME->_T_CONVERSIONS WHERE NODE_KEY = NODE_KEY.

        ME->_CONVERSATION_TREE->DELETE_SUBTREE(
          EXPORTING
            I_NODE_KEY            = NODE_KEY      " Node to be Deleted
*           i_update_parents_expander = space            " Delete Parent Expander, if no more Children Exist
*           i_update_parents_folder   = space            " Change Parent Folder for End Node, if no More Children Exist
          EXCEPTIONS
            NODE_KEY_NOT_IN_MODEL = 1                " Node not Found in Model
            OTHERS                = 2
        ).
        IF SY-SUBRC <> 0.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
        CALL METHOD _CONVERSATION_TREE->FRONTEND_UPDATE.

      WHEN G_RNAME_CONVERSATION.
        P_NAME = <FS_CONVERSION>-CONVERSATION->INFO( )-NAME.
        CALL SELECTION-SCREEN 9900 STARTING AT 10 10.
        IF SY-SUBRC = 0.
          <FS_CONVERSION>-CONVERSATION->UPDATE_NAME( P_NAME ).

          DATA: L_OUTTAB_LINE         TYPE  TYP_DISPLAY,
                LS_NODE_LAYOUT_UPDATE TYPE LVC_S_LACN.
          ME->_CONVERSATION_TREE->GET_OUTTAB_LINE(
            EXPORTING
              I_NODE_KEY     = NODE_KEY              " Node Key
            IMPORTING
              E_OUTTAB_LINE  = L_OUTTAB_LINE         " Line of Outtab
              E_NODE_TEXT    = DATA(L_NODE_TEXT)     " node text
              ET_ITEM_LAYOUT = DATA(LT_ITEM_LAYOUT)  " Layout structure for items of the ALV tree control
              ES_NODE_LAYOUT = DATA(LS_NODE_LAYOUT)  " Node Layout of ALV Tree Control LVC_S_LAYN
            EXCEPTIONS
              NODE_NOT_FOUND = 1                     " Node does not exist
              OTHERS         = 2
          ).

          MOVE-CORRESPONDING LS_NODE_LAYOUT TO LS_NODE_LAYOUT_UPDATE.
          ME->_CONVERSATION_TREE->CHANGE_NODE(
            EXPORTING
              I_NODE_KEY     = NODE_KEY        " Key of Changed Line
              I_OUTTAB_LINE  = L_OUTTAB_LINE   " Outtab Line to be Changed
              IS_NODE_LAYOUT = LS_NODE_LAYOUT_UPDATE  " Node Layout LVC_S_LACN
*             it_item_layout = conv #( ls_node_layout )   " Item Layout
              I_NODE_TEXT    = CONV #( P_NAME ) " Node Text
              I_U_NODE_TEXT  = ABAP_TRUE        " 'X': Change Node Text
            EXCEPTIONS
              NODE_NOT_FOUND = 1                " Node does not exist
              OTHERS         = 2
          ).

          IF SY-SUBRC <> 0.
            MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
          ENDIF.

        ENDIF.
        CALL METHOD _CONVERSATION_TREE->FRONTEND_UPDATE.

      WHEN G_SYSROLE_CONVERSATION.
        DATA(L_SYSTEM_ROLE) = <FS_CONVERSION>-CONVERSATION->GET_SYSTEM_ROLE( ).

        DATA: WIDTH  TYPE I,
              HEIGHT TYPE I,
              TOP    TYPE I,
              LEFT   TYPE I.
        IMPORT WIDTH = WIDTH
               HEIGHT = HEIGHT
               TOP = TOP
               LEFT = LEFT
        FROM DATABASE INDX(CS)
        ID _SYSTEM_ROLE_DIALOGBOX_SETTING.
        IF SY-SUBRC <> 0 .
          WIDTH                       = 500 .
          HEIGHT                      = 300 .
          TOP                         = 200 .
          LEFT                        = 400 .
        ENDIF.

        CREATE OBJECT _SYSTEM_ROLE_DIALOGBOX
          EXPORTING
            WIDTH                       = WIDTH
            HEIGHT                      = HEIGHT
            TOP                         = TOP
            LEFT                        = LEFT
            CAPTION                     = 'System role' "#EC NOTEXT
          EXCEPTIONS
            CNTL_ERROR                  = 1
            CNTL_SYSTEM_ERROR           = 2
            CREATE_ERROR                = 3
            LIFETIME_ERROR              = 4
            LIFETIME_DYNPRO_DYNPRO_LINK = 5.

        SET HANDLER ON_SYSROLE_DLG_CLOSE FOR _SYSTEM_ROLE_DIALOGBOX.

        CREATE OBJECT _SYSTEM_ROLE_TEXTEDIT
          EXPORTING
            PARENT = _SYSTEM_ROLE_DIALOGBOX.

        _SYSTEM_ROLE_TEXTEDIT->SET_TEXTSTREAM(
          EXPORTING
            TEXT                   = L_SYSTEM_ROLE " Text as String with Carriage Returns and Linefeeds
          EXCEPTIONS
            ERROR_CNTL_CALL_METHOD = 1    " Error Calling COM Method
            NOT_SUPPORTED_BY_GUI   = 2    " Method is not supported by installed GUI
        ).
        IF SY-SUBRC <> 0.
          MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

        CL_GUI_CFW=>FLUSH( ).

      WHEN G_REPROC_CONVERSATION.
        <FS_CONVERSION>-CONVERSATION->RERUN_PROCESSER( ).

      WHEN OTHERS.
    ENDCASE.

  ENDMETHOD.
  METHOD HANDLE_ITEM_CTMENU_REQUEST.
  ENDMETHOD.
  METHOD HANDLE_ITEM_CTMENU_SELECTED.
  ENDMETHOD.

  METHOD ON_SYSROLE_DLG_CLOSE.
    READ TABLE ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSION>) WITH KEY NODE_KEY = _CURRENT_KEY.
    CHECK SY-SUBRC = 0.
    IF _SYSTEM_ROLE_DIALOGBOX IS NOT INITIAL.

      DATA: WIDTH  TYPE I,
            HEIGHT TYPE I,
            TOP    TYPE I,
            LEFT   TYPE I.

      CALL METHOD _SYSTEM_ROLE_DIALOGBOX->GET_TOP
        IMPORTING
          TOP        = TOP                  " Current TOP
        EXCEPTIONS
          CNTL_ERROR = 1                " cntl_error
          OTHERS     = 2.

      CALL METHOD _SYSTEM_ROLE_DIALOGBOX->GET_LEFT
        IMPORTING
          LEFT       = LEFT          " Current Left Coordinate of Control
        EXCEPTIONS
          CNTL_ERROR = 1                " cntl_error
          OTHERS     = 2.

      CALL METHOD _SYSTEM_ROLE_DIALOGBOX->GET_HEIGHT
        IMPORTING
          HEIGHT     = HEIGHT                 " Current Height
        EXCEPTIONS
          CNTL_ERROR = 1                " cntl_error
          OTHERS     = 2.

      CALL METHOD _SYSTEM_ROLE_DIALOGBOX->GET_WIDTH
        IMPORTING
          WIDTH      = WIDTH                 " Current WIDTH
        EXCEPTIONS
          CNTL_ERROR = 1                " cntl_error
          OTHERS     = 2.

      CALL METHOD _SYSTEM_ROLE_TEXTEDIT->GET_TEXTSTREAM
*     EXPORTING
*         ONLY_WHEN_MODIFIED     = CL_GUI_TEXTEDIT=>TRUE
        IMPORTING
          TEXT                   = DATA(L_SYSTEM_ROLE)
*         IS_MODIFIED            =
        EXCEPTIONS
          ERROR_CNTL_CALL_METHOD = 1
          NOT_SUPPORTED_BY_GUI   = 2
          OTHERS                 = 3.

      CL_GUI_CFW=>FLUSH( ).

      <FS_CONVERSION>-CONVERSATION->SET_SYSTEM_ROLE( L_SYSTEM_ROLE ).

      IF _SYSTEM_ROLE_TEXTEDIT IS NOT INITIAL.
        _SYSTEM_ROLE_TEXTEDIT->FREE( ).
      ENDIF.
      CLEAR _SYSTEM_ROLE_TEXTEDIT.
      IF _SYSTEM_ROLE_DIALOGBOX IS NOT INITIAL.
        _SYSTEM_ROLE_DIALOGBOX->FREE( ).
      ENDIF.
      CLEAR _SYSTEM_ROLE_DIALOGBOX.

      EXPORT WIDTH = WIDTH HEIGHT = HEIGHT TOP = TOP LEFT = LEFT
      TO DATABASE INDX(CS)
      ID _SYSTEM_ROLE_DIALOGBOX_SETTING.

    ENDIF.
  ENDMETHOD.

  METHOD ON_SAPEVENT.

    CASE ACTION.
      WHEN 'SUBMIT_PROCESSER'.
        DATA(L_ID) = QUERY_TABLE[ NAME = 'id' ]-VALUE.
        DATA(L_CMB_PROCESSER) = QUERY_TABLE[ NAME = 'cmb_processer' ]-VALUE.
        CHECK L_CMB_PROCESSER IS NOT INITIAL AND L_ID IS NOT INITIAL.

        READ TABLE ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSION>) WITH KEY ID = L_ID.
        IF SY-SUBRC = 0 AND <FS_CONVERSION> IS ASSIGNED.
          <FS_CONVERSION>-CONVERSATION->SET_AI_RESULT_PROCESSER( I_PROCESSER = CONV #( L_CMB_PROCESSER ) ).
        ENDIF.
      WHEN OTHERS.
    ENDCASE.


  ENDMETHOD.

  METHOD HANDLE_NODE_DOUBLE_CLICK.
    LOOP AT ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSIONS>) WHERE NODE_KEY IS NOT INITIAL.
      <FS_CONVERSIONS>-CURR_CONVERSATION = ABAP_FALSE.
      IF <FS_CONVERSIONS>-NODE_KEY = NODE_KEY.
        <FS_CONVERSIONS>-CURR_CONVERSATION = ABAP_TRUE.
        ME->UPDATE_NODE_ICON( I_NODE_KEY = <FS_CONVERSIONS>-NODE_KEY I_ICON_NAME = ICON_CHECKED ).
        ME->SHOW_CONVERSION( <FS_CONVERSIONS>-CONVERSATION ).
        ME->SHOW_INFO( <FS_CONVERSIONS>-CONVERSATION ).

      ELSE.
        ME->UPDATE_NODE_ICON( I_NODE_KEY = <FS_CONVERSIONS>-NODE_KEY I_ICON_NAME = SPACE ).
      ENDIF.
    ENDLOOP.

    CALL METHOD _CONVERSATION_TREE->FRONTEND_UPDATE.
  ENDMETHOD.

  METHOD ASK_AI.
    READ TABLE ME->_T_CONVERSIONS ASSIGNING FIELD-SYMBOL(<FS_CONVERSIONS>) WITH KEY CURR_CONVERSATION = ABAP_TRUE.
    CHECK SY-SUBRC = 0.

    TRY.
        <FS_CONVERSIONS>-CONVERSATION->ADD_QUESTION( I_QUESTION ).
        <FS_CONVERSIONS>-CONVERSATION->CALL_AI_ENGINEER(
          IMPORTING
            EO_API_RESULT = DATA(LO_API_RESULT)
          RECEIVING
            R_ANSWER      = DATA(L_ANSWER)
        ).
        RO_CONVERSATION = <FS_CONVERSIONS>-CONVERSATION.
        RO_CONVERSATION->SAVE_TO_DB( ).
      CATCH CX_STATIC_CHECK INTO DATA(LO_ERROR).
        WRITE: 'ERROR WHEN CALL AP CORE'.
    ENDTRY.
  ENDMETHOD.

  METHOD INIT_TREE.
    DATA : L_HIERARCHY_HEADER TYPE TREEV_HHDR,
           L_LAYOUT_NODE      TYPE LVC_S_LAYN,
           L_NODE_IMAGE       TYPE TV_IMAGE,
           L_RELAT_KEY        TYPE LVC_NKEY,
           LT_EVENTS          TYPE CNTL_SIMPLE_EVENTS,
           LS_EVENT           LIKE LINE OF LT_EVENTS.

    _CONVERSATION_TREE = NEW CL_GUI_ALV_TREE(
      PARENT              = IO_CONTAINER
      NODE_SELECTION_MODE = CL_GUI_COLUMN_TREE=>NODE_SEL_MODE_SINGLE
      ITEM_SELECTION      = ABAP_TRUE
      NO_HTML_HEADER      = ABAP_TRUE
      NO_TOOLBAR          = ABAP_FALSE ).

    L_HIERARCHY_HEADER-HEADING = 'Name'.
    L_HIERARCHY_HEADER-TOOLTIP = ''.
    L_HIERARCHY_HEADER-WIDTH = 35.
    L_HIERARCHY_HEADER-WIDTH_PIX = ''.

    _T_FIELDCATALOG = VALUE #(
    ( COL_POS = 11 FIELDNAME = 'id'        KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'ID'        DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'ID'        SCRTEXT_M = 'ID'        SCRTEXT_S = 'ID' )
    ( COL_POS = 2  FIELDNAME = 'module_id' KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'module_id' DOMNAME = 'aic_d_model_id'     DD_OUTLEN = 16 SCRTEXT_L = 'module_id' SCRTEXT_M = 'module_id' SCRTEXT_S = 'module_id' )
    ( COL_POS = 3  FIELDNAME = 'scen_id'   KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'scen_id'   DOMNAME = 'aic_d_appl_scen_id' DD_OUTLEN = 16 SCRTEXT_L = 'scen_id'   SCRTEXT_M = 'scen_id'   SCRTEXT_S = 'scen_id' )
    ( COL_POS = 4  FIELDNAME = 'cuser'     KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 10 REPTEXT = 'cuser'     DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'Create by' SCRTEXT_M = 'Create by' SCRTEXT_S = 'Create by' )
    ( COL_POS = 5  FIELDNAME = 'create'    KEY = ABAP_FALSE DATATYPE = 'DATS' INTTYPE = 'D' INTLEN = 8  REPTEXT = 'create'    DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'Create at' SCRTEXT_M = 'Create at' SCRTEXT_S = 'Create at' )
    ( COL_POS = 6  FIELDNAME = 'ctime'     KEY = ABAP_FALSE DATATYPE = 'TIMS' INTTYPE = 'T' INTLEN = 6  REPTEXT = 'ctime'     DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'CTime'     SCRTEXT_M = 'CTime'     SCRTEXT_S = 'CTime' )
    ( COL_POS = 7  FIELDNAME = 'uuser'     KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 10 REPTEXT = 'uuser'     DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'Change by' SCRTEXT_M = 'Change by' SCRTEXT_S = 'Change by' )
    ( COL_POS = 8  FIELDNAME = 'update'    KEY = ABAP_FALSE DATATYPE = 'DATS' INTTYPE = 'D' INTLEN = 8  REPTEXT = 'update'    DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'Change at' SCRTEXT_M = 'Change at' SCRTEXT_S = 'Change at' )
    ( COL_POS = 9  FIELDNAME = 'utime'     KEY = ABAP_FALSE DATATYPE = 'TIMS' INTTYPE = 'T' INTLEN = 6  REPTEXT = 'utime'     DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'CTime'     SCRTEXT_M = 'CTime'     SCRTEXT_S = 'CTime' )
    ( COL_POS = 10 FIELDNAME = 'refid'     KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'refid'     DOMNAME = ''                   DD_OUTLEN = 16 SCRTEXT_L = 'REFID'     SCRTEXT_M = 'REFID'     SCRTEXT_S = 'REFID' )
    ).

    CALL METHOD _CONVERSATION_TREE->SET_TABLE_FOR_FIRST_DISPLAY
      EXPORTING
        IS_HIERARCHY_HEADER = L_HIERARCHY_HEADER
      CHANGING
        IT_FIELDCATALOG     = _T_FIELDCATALOG
        IT_OUTTAB           = _T_DISPLAY. "table must be empty !

    L_LAYOUT_NODE-ISFOLDER = ABAP_TRUE.   "=>add a folder, NOT a leaf
    L_LAYOUT_NODE-N_IMAGE = L_NODE_IMAGE. "=>Display an icon

    CALL METHOD _CONVERSATION_TREE->ADD_NODE
      EXPORTING
        I_RELAT_NODE_KEY = L_RELAT_KEY
        I_RELATIONSHIP   = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD
        I_NODE_TEXT      = 'Favorites'
        IS_NODE_LAYOUT   = L_LAYOUT_NODE
      IMPORTING
        E_NEW_NODE_KEY   = _FAV_KEY.

    L_LAYOUT_NODE-EXPANDER = ABAP_TRUE.
    CALL METHOD _CONVERSATION_TREE->ADD_NODE
      EXPORTING
        I_RELAT_NODE_KEY = L_RELAT_KEY
        I_RELATIONSHIP   = CL_GUI_COLUMN_TREE=>RELAT_LAST_CHILD
        I_NODE_TEXT      = 'Conversations'
        IS_NODE_LAYOUT   = L_LAYOUT_NODE
      IMPORTING
        E_NEW_NODE_KEY   = _CON_KEY.

    CALL METHOD _CONVERSATION_TREE->EXPAND_NODES( IT_NODE_KEY = VALUE #( ( _FAV_KEY ) ( _CON_KEY ) ) ).

*   register events on frontend
    CALL METHOD _CONVERSATION_TREE->GET_REGISTERED_EVENTS
      IMPORTING
        EVENTS = LT_EVENTS.
    LS_EVENT-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_NODE_DOUBLE_CLICK.
    APPEND LS_EVENT TO LT_EVENTS.
    LS_EVENT-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_ITEM_DOUBLE_CLICK.
    APPEND LS_EVENT TO LT_EVENTS.
    LS_EVENT-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_NODE_CONTEXT_MENU_REQ.
    APPEND LS_EVENT TO LT_EVENTS.
    LS_EVENT-EVENTID = CL_GUI_COLUMN_TREE=>EVENTID_ITEM_CONTEXT_MENU_REQ.
    APPEND LS_EVENT TO LT_EVENTS.

    CALL METHOD _CONVERSATION_TREE->SET_REGISTERED_EVENTS
      EXPORTING
        EVENTS = LT_EVENTS.

    SET HANDLER ME->HANDLE_NODE_DOUBLE_CLICK FOR _CONVERSATION_TREE.
    SET HANDLER ME->HANDLE_NODE_CTMENU_REQUEST     FOR _CONVERSATION_TREE.
    SET HANDLER ME->HANDLE_NODE_CTMENU_SELECTED    FOR _CONVERSATION_TREE.
    SET HANDLER ME->HANDLE_ITEM_CTMENU_REQUEST    FOR _CONVERSATION_TREE.
    SET HANDLER ME->HANDLE_ITEM_CTMENU_SELECTED    FOR _CONVERSATION_TREE.

  ENDMETHOD.

  METHOD INIT_HTML.
    DATA:LT_MYEVENT TYPE CNTL_SIMPLE_EVENTS,
         LS_MYEVENT TYPE CNTL_SIMPLE_EVENT.

    ME->_CONVERSATION_HTML = NEW CL_GUI_HTML_VIEWER( IO_CONTAINER ).

    LS_MYEVENT-EVENTID = CL_GUI_HTML_VIEWER=>M_ID_SAPEVENT.
    LS_MYEVENT-APPL_EVENT = 'X'.
    APPEND LS_MYEVENT TO LT_MYEVENT.
    CALL METHOD ME->_CONVERSATION_HTML->SET_REGISTERED_EVENTS
      EXPORTING
        EVENTS = LT_MYEVENT.

    SET HANDLER ME->ON_SAPEVENT
                FOR ME->_CONVERSATION_HTML.

  ENDMETHOD.

  METHOD INIT_CONVERSATION_MANGER.

    DATA(L_SPLITTER_MAIN) = NEW CL_GUI_SPLITTER_CONTAINER(
      PARENT  = IO_CONTAINER
      ROWS    = 2
      COLUMNS = 1 ).

    L_SPLITTER_MAIN->SET_ROW_HEIGHT(
      EXPORTING
        ID     = 1
        HEIGHT = 20 ).

    INIT_HTML( IO_CONTAINER = L_SPLITTER_MAIN->GET_CONTAINER( ROW = 1 COLUMN = 1 ) ).
    INIT_TREE( IO_CONTAINER = L_SPLITTER_MAIN->GET_CONTAINER( ROW = 2 COLUMN = 1 ) ).

    CALL METHOD _CONVERSATION_TREE->FRONTEND_UPDATE( ).
    CALL METHOD CL_GUI_CFW=>DISPATCH( ).
    CALL METHOD CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD CONSTRUCTOR.
    ME->_SCREEN_HANDLER = IO_SCREEN_HANDLER.
    _SYSTEM_ROLE_DIALOGBOX_SETTING = 'SRD_' && SY-UNAME.

  ENDMETHOD.
ENDCLASS.

CLASS CL_TALK_SHOW IMPLEMENTATION.

  METHOD CONSTRUCTOR.
    LV_MAX_ROUND = I_MAX_ROUND.
  ENDMETHOD.

  METHOD SET_MAX_ROUND.
    LV_MAX_ROUND = I_MAX_ROUND.
  ENDMETHOD.

  METHOD SET_TOPIC.
    LV_TOPIC = IV_TOPIC.
  ENDMETHOD.

  METHOD ADD_PARTICIPANT.
    LV_ID = LV_ID + 1.
    APPEND INITIAL LINE TO LT_PARTICIPANTS ASSIGNING FIELD-SYMBOL(<FS_PARTICIPANT>).
    <FS_PARTICIPANT>-ID = LV_ID.
    <FS_PARTICIPANT>-PARTICIPANT = IO_PARTICAIPANT.
  ENDMETHOD.

  METHOD SET_HOSTER.
    LO_HOSTER = IO_HOSTER.
  ENDMETHOD.

  METHOD GET_HOSTER.
    RO_HOSTER = LO_HOSTER.
  ENDMETHOD.

  METHOD SAVE_TO_DB.
    LO_HOSTER->SAVE_TO_DB( ).
    LOOP AT LT_PARTICIPANTS INTO DATA(LS_PARTICIPANT).
      LS_PARTICIPANT-PARTICIPANT->SAVE_TO_DB( ).
    ENDLOOP.

    COMMIT WORK.
  ENDMETHOD.

  METHOD START_SHOW.
    DATA: L_ROUND_ANSWER TYPE STRING.

    " 首先由主持人发言
    LO_HOSTER->ADD_QUESTION(
*      I_ROLE     = AIC_MESSAGE_TYPE=>USER_MESSAGE
      I_QUESTION = |请对今天的主题说点开场白把: { LV_TOPIC } |
    ).

    LO_HOSTER->CALL_AI_ENGINEER(
*      IMPORTING
*        EO_API_RESULT = DATA(LO_API_RESULT)
      RECEIVING
        R_ANSWER = DATA(L_TOPIC_ANSWER)
    ).

    L_TOPIC_ANSWER = |这是的主题:{ LV_TOPIC } \n 这是主持人{ LO_HOSTER->INFO( )-NAME }的开场白:{ L_TOPIC_ANSWER }|.

    WHILE LV_ROUNDS < LV_MAX_ROUND AND LV_SCORE < 9.
      LV_ROUNDS = LV_ROUNDS + 1.
      CLEAR: L_ROUND_ANSWER.

      LOOP AT LT_PARTICIPANTS INTO DATA(LS_PARTICIPANT).

        LS_PARTICIPANT-PARTICIPANT->ADD_QUESTION(
*          I_ROLE     = AIC_MESSAGE_TYPE=>USER_MESSAGE
          I_QUESTION = L_TOPIC_ANSWER
        ).

        LS_PARTICIPANT-PARTICIPANT->CALL_AI_ENGINEER(
*          IMPORTING
*           EO_API_RESULT = DATA(LO_API_RESULT)
          RECEIVING
            R_ANSWER = DATA(L_ANSWER)
        ).

        L_ROUND_ANSWER = |{ LS_PARTICIPANT-PARTICIPANT->INFO( )-NAME }说:""" { L_ANSWER } """\n\n{ L_ROUND_ANSWER }|.

      ENDLOOP.

      " 主持人总结
      LO_HOSTER->ADD_QUESTION(
*        I_ROLE     = AIC_MESSAGE_TYPE=>USER_MESSAGE
        I_QUESTION = L_ROUND_ANSWER
      ).

      LO_HOSTER->CALL_AI_ENGINEER(
*        IMPORTING
*          EO_API_RESULT = DATA(LO_API_RESULT)
        RECEIVING
          R_ANSWER = L_TOPIC_ANSWER
      ).

    ENDWHILE.
  ENDMETHOD.

  METHOD EVALUATE_OPINION.
    " 简单的评估，假设每次随机给分1到3用于简化逻辑
    RV_SCORE = 1 + SY-INDEX MOD 3.
  ENDMETHOD.

ENDCLASS.

CLASS CL_PROMPT_PROCESSER IMPLEMENTATION.
  METHOD PROCESS.
    CL_AI_RESULT_PROCESSER=>FIND_PROMPT(
      EXPORTING
        I_TEXT          = I_TEXT
      IMPORTING
        ET_PROMPT       = DATA(LT_PROMPT)
      RECEIVING
        IS_FOUND_PROMPT = DATA(LS_FOUND_PROMPT)
    ).

    DATA(L_PROMPT) = REDUCE STRING( INIT TEXT = `` SEP = ``
                                       FOR P IN LT_PROMPT
                                       NEXT TEXT = |{ TEXT } { SEP } { P }| SEP = |\n++--==++--==++--==++--==++--==++--==++--==\n|
                                       ).
    IF LS_FOUND_PROMPT = ABAP_TRUE.
      SUPER->PROCESS(
        EXPORTING
          I_TEXT   = L_PROMPT
        RECEIVING
          R_RESULT = R_RESULT
      ).
    ENDIF.



  ENDMETHOD.

ENDCLASS.

CLASS CL_CHANGE_LIST_PROCESSER IMPLEMENTATION.

ENDCLASS.

CLASS CL_CODE_PROCESSER IMPLEMENTATION.
  METHOD PROCESS.
    CL_AI_RESULT_PROCESSER=>FIND_CODE(
      EXPORTING
        I_TEXT        = I_TEXT
      IMPORTING
        ET_ABAP_CODE  = DATA(LT_ABAP_CODE)
      RECEIVING
        IS_FOUND_ABAP = DATA(LS_FOUND_ABAP)
    ).

    DATA(L_ABAP_CODE) = REDUCE STRING( INIT TEXT = `` SEP = ``
                                       FOR P IN LT_ABAP_CODE
                                       NEXT TEXT = |{ TEXT } { SEP } { P }| SEP = |\n++--==++--==++--==++--==++--==++--==++--==\n|
                                       ).

    IF LS_FOUND_ABAP = ABAP_TRUE.
      SUPER->PROCESS( L_ABAP_CODE ).
    ENDIF.
  ENDMETHOD.

ENDCLASS.

CLASS CL_TAX_CODE_PROCESSER IMPLEMENTATION.
  METHOD CONVERT_TAX_CODES.
    DATA: LS_TAX_CODE TYPE TYP_ACTIVATE_TAX_CODE.
    FIELD-SYMBOLS:
      <FS_T007A> TYPE LINE OF TBL_T007A,
      <FS_T007S> TYPE LINE OF TBL_T007S,
      <FS_T007V> TYPE LINE OF TBL_T007V.

    CLEAR ET_TAX_CODES[].

    LOOP AT IT_ACTION_ITEM ASSIGNING FIELD-SYMBOL(<FS_ACTION_ITEM>).
      IF <FS_ACTION_ITEM>-METHODS[] IS NOT INITIAL.
        LOOP AT <FS_ACTION_ITEM>-METHODS ASSIGNING FIELD-SYMBOL(<FS_METHODS>).
          IF <FS_METHODS>-NAME = 'CREATE_TAX_CODE'.
            APPEND INITIAL LINE TO LS_TAX_CODE-TBL_T007A ASSIGNING <FS_T007A>.
            <FS_T007A>-KALSM = |0TX{ <FS_METHODS>-COUNTRYCODE }|.
            <FS_T007A>-MWART = <FS_METHODS>-TAXTYPE.
            <FS_T007A>-MWSKZ = <FS_METHODS>-TAXCODE.
            <FS_T007A>-PRUEF = 'X'.

            APPEND INITIAL LINE TO LS_TAX_CODE-TBL_T007S ASSIGNING <FS_T007S>.
            <FS_T007S>-KALSM = <FS_T007A>-KALSM.
            <FS_T007S>-SPRAS = SY-LANGU.
            <FS_T007S>-MWSKZ = <FS_T007A>-MWSKZ.
            <FS_T007S>-TEXT1 = <FS_METHODS>-DESCRIPTION.

            APPEND INITIAL LINE TO LS_TAX_CODE-TBL_V_T007V ASSIGNING <FS_T007V>.
            <FS_T007V>-TRKORR = |AI/{ <FS_METHODS>-COUNTRYCODE }/AI|.
            <FS_T007V>-ALAND = <FS_METHODS>-COUNTRYCODE.
            <FS_T007V>-MWSKZ = <FS_T007A>-MWSKZ.
            <FS_T007V>-KSCHL = <FS_METHODS>-CONDITIONTYPE.
            IF <FS_T007V>-KSCHL IS INITIAL.
              CASE <FS_T007A>-MWART.
                WHEN 'A'.
                  <FS_T007V>-KSCHL = 'MWAS'.
                WHEN 'V'.
                  <FS_T007V>-KSCHL = 'MWVS'.
                WHEN OTHERS.

             ENDCASE.
            ENDIF.

            TRY.
                <FS_T007V>-KBETR = <FS_METHODS>-TAXRATE * 10.
              CATCH CX_SY_CONVERSION_NO_NUMBER.
                CLEAR <FS_T007V>-KBETR.
            ENDTRY.
            <FS_T007V>-DATAM = <FS_METHODS>-VALIDON.
            <FS_T007V>-KOTABNR = '4AV'.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDLOOP.

    APPEND LS_TAX_CODE TO ET_TAX_CODES.
  ENDMETHOD.

  METHOD CONSTRUCTOR.
    SUPER->CONSTRUCTOR( ).
    _T_REC_ID_MAPPING = VALUE #(
    ( TABLENAME = 'T007A'   REC_ID = 1 )
    ( TABLENAME = 'T007S'   REC_ID = 1 )
    ( TABLENAME = 'V_T007V' REC_ID = 1 )
    ).

    L_SHARE_SYSTEM_ROLE = ABAP_TRUE.
    L_SR_NAME = 'TAX_CODE'.
    L_MY_NAME = 'CL_TAX_CODE_PROCESSER'.

    LOAD_SHARE_SYSTEM_ROLE( ).
  ENDMETHOD.

  METHOD PROCESS.
    CLEAR: _JSON_DATA,
          _T_ACTION_ITEM,
          _T_TAX_CODES,
          _BCSET_ID,
          R_RESULT,
          LT_TAX_CODE_DISPLAY,
          LT_TAX_CODE_ORIGINAL.

    CL_AI_RESULT_PROCESSER=>FIND_JSON(
      EXPORTING
        I_TEXT        = I_TEXT
      IMPORTING
        ET_JSON_DATA  = _JSON_DATA
      RECEIVING
        IS_FOUND_JSON = DATA(LS_FOUND_JSON)
    ).

    IF LS_FOUND_JSON = ABAP_TRUE.
      LOOP AT _JSON_DATA INTO DATA(L_JSON_DATA).
        ME->EXTRACE_ACTION_ITEMS(
          EXPORTING
            I_JSON_DATA    = L_JSON_DATA
          IMPORTING
            ET_ACTION_ITEM = DATA(LT_ACTION_ITEM)
        ).

        APPEND LINES OF LT_ACTION_ITEM TO _T_ACTION_ITEM.
*        APPEND LINES OF LS_TAX_CODES TO _T_TAX_CODES.
      ENDLOOP.

      DATA(L_ACTIVATE_TAX_CODE) = ME->SHOW_TAX_CODES(
        CHANGING
          CT_ACTION_ITEM = _T_ACTION_ITEM
      ).

      IF L_ACTIVATE_TAX_CODE = ABAP_TRUE.

        ME->CONVERT_TAX_CODES(
          EXPORTING
            IT_ACTION_ITEM = _T_ACTION_ITEM
          IMPORTING
            ET_TAX_CODES   = DATA(LS_TAX_CODES)
        ).

        ME->ACTIVATE_TAX_CODES(
          EXPORTING
            IT_TAX_CODES = _T_TAX_CODES
          RECEIVING
            E_BCSET_ID   = _BCSET_ID
        ).

        IF _BCSET_ID IS NOT INITIAL.
          APPEND INITIAL LINE TO R_RESULT ASSIGNING FIELD-SYMBOL(<FS_RESULT>).
          <FS_RESULT>-CODE = '00'.
          <FS_RESULT>-TYPE = 'S'.
          <FS_RESULT>-LOG_MSG_NO = '001'.
          <FS_RESULT>-CODE = _BCSET_ID.
          MESSAGE S001(00) WITH _BCSET_ID INTO <FS_RESULT>-MESSAGE.

          DATA(LT_BDCDATA) = VALUE TAB_BDCDATA(
                ( PROGRAM = 'SAPSCPR7' DYNPRO = '0100' DYNBEGIN = 'X'   FNAM = SPACE                 FVAL = SPACE )
                ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'BDC_CURSOR'          FVAL = 'SCPRDYNPRO-TEMPLATE' )
                ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'BDC_OKCODE'          FVAL = '=SHWP' )
                ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'SCPRDYNPRO-TEMPLATE' FVAL = _BCSET_ID )
          ).

          CALL FUNCTION 'ABAP4_CALL_TRANSACTION' STARTING NEW TASK 'NONE'
            EXPORTING
              TCODE                   = 'SCPR20'
              SKIP_SCREEN             = ''
              MODE_VAL                = 'E'
              UPDATE_VAL              = 'L'
*       IMPORTING
*             SUBRC                   =
            TABLES
              USING_TAB               = LT_BDCDATA
*             SPAGPA_TAB              =
*             MESS_TAB                =
            EXCEPTIONS
              CALL_TRANSACTION_DENIED = 1
              TCODE_INVALID           = 2
              OTHERS                  = 3.
        ENDIF.
      ENDIF.
    ENDIF.

  ENDMETHOD.

  METHOD EXTRACE_ACTION_ITEMS.
    CHECK I_JSON_DATA IS NOT INITIAL.
    FIELD-SYMBOLS: <FV_VALUE>            TYPE ANY,
                   <FV_FIELD>            TYPE ANY,
                   <FS_JSON_ACTIONITEMS> TYPE ANY,
                   <FV_JSON_ACTIONITEMS> TYPE ANY,
                   <FV_METHODS>          TYPE ANY,
                   <FS_METHODS>          TYPE ANY.

    CLEAR: ET_ACTION_ITEM[].
    ASSIGN COMPONENT 'ActionItems' OF STRUCTURE I_JSON_DATA->* TO <FV_JSON_ACTIONITEMS>.
    CHECK SY-SUBRC = 0 AND <FV_JSON_ACTIONITEMS> IS NOT INITIAL.
    CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA( <FV_JSON_ACTIONITEMS>->* )->IS_INSTANTIATABLE(
    RECEIVING
    P_RESULT = DATA(L_RESULT)                 " Return code
          ).

    DEFINE GET_VALUE.

      ASSIGN COMPONENT &1 OF STRUCTURE &2->* TO <FV_VALUE>.
      IF SY-SUBRC = 0.
        ASSIGN COMPONENT &1 OF STRUCTURE &3 TO <FV_FIELD>.
        IF SY-SUBRC = 0.
          <FV_FIELD> = <FV_VALUE>->*.
        ENDIF.
      ENDIF.

      UNASSIGN: <FV_FIELD>, <FV_VALUE>.

    END-OF-DEFINITION.

    IF L_RESULT = ABAP_TRUE.
      LOOP AT <FV_JSON_ACTIONITEMS>->* ASSIGNING <FS_JSON_ACTIONITEMS>.
        APPEND INITIAL LINE TO ET_ACTION_ITEM ASSIGNING FIELD-SYMBOL(<FS_ACTION_ITEM>).
        GET_VALUE 'ID' <FS_JSON_ACTIONITEMS> <FS_ACTION_ITEM>.
        GET_VALUE 'Title' <FS_JSON_ACTIONITEMS> <FS_ACTION_ITEM>.
        GET_VALUE 'Description' <FS_JSON_ACTIONITEMS> <FS_ACTION_ITEM>.
        GET_VALUE 'ActionType' <FS_JSON_ACTIONITEMS> <FS_ACTION_ITEM>.
        IF <FS_ACTION_ITEM>-ACTIONTYPE = 1 OR
           <FS_ACTION_ITEM>-ACTIONTYPE = 2.
          ASSIGN COMPONENT 'Methods' OF STRUCTURE <FS_JSON_ACTIONITEMS>->* TO <FV_METHODS>.
          IF SY-SUBRC = 0.
            LOOP AT <FV_METHODS>->* ASSIGNING <FS_METHODS>.
              APPEND INITIAL LINE TO <FS_ACTION_ITEM>-METHODS ASSIGNING FIELD-SYMBOL(<FS_METHOD>).

              GET_VALUE 'Name' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'CountryCode' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'TaxCode' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'TaxRate' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'Description' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'TaxType' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'ConditionType' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'ValidOn' <FS_METHODS> <FS_METHOD>.
              GET_VALUE 'ValidEnd' <FS_METHODS> <FS_METHOD>.

              ASSIGN COMPONENT 'Field_Extraction_Source' OF STRUCTURE <FS_METHODS>->* TO FIELD-SYMBOL(<FV_EXTRACTION_SOURCE>).
              IF SY-SUBRC = 0.
                GET_VALUE 'Name' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'CountryCode' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'TaxCode' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'TaxRate' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'Description' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'TaxType' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'ConditionType' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'ValidOn' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
                GET_VALUE 'ValidEnd' <FV_EXTRACTION_SOURCE> <FS_METHOD>-FIELD_EXTRACTION_SOURCE.
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.

  METHOD ON_BUTTON_CLICK.
    READ TABLE LT_TAX_CODE_DISPLAY ASSIGNING FIELD-SYMBOL(<FS_TAX_CODE_DISPLAY>) INDEX ES_ROW_NO-ROW_ID.
    IF SY-SUBRC = 0.

      DATA LT_ACTION_ITEM TYPE TBL_ACTION_ITEM.

      APPEND INITIAL LINE TO LT_ACTION_ITEM ASSIGNING FIELD-SYMBOL(<FS_ACTION_ITEM>).
      APPEND <FS_TAX_CODE_DISPLAY> TO <FS_ACTION_ITEM>-METHODS.

      CONVERT_TAX_CODES(
        EXPORTING
          IT_ACTION_ITEM = LT_ACTION_ITEM
        IMPORTING
          ET_TAX_CODES   = DATA(LT_TAX_CODES)
      ).

      ACTIVATE_TAX_CODES(
        EXPORTING
          IT_TAX_CODES = LT_TAX_CODES
        RECEIVING
          E_BCSET_ID   = DATA(L_BCSET_ID)
      ).

      IF L_BCSET_ID IS NOT INITIAL.
        MESSAGE S001(00) WITH L_BCSET_ID.
*        DATA(LT_BDCDATA) = VALUE TAB_BDCDATA(
*              ( PROGRAM = 'SAPSCPR7' DYNPRO = '0100' DYNBEGIN = 'X'   FNAM = SPACE                 FVAL = SPACE )
*              ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'BDC_CURSOR'          FVAL = 'SCPRDYNPRO-TEMPLATE' )
*              ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'BDC_OKCODE'          FVAL = '=SHWP' )
*              ( PROGRAM = SPACE      DYNPRO = '0100' DYNBEGIN = SPACE FNAM = 'SCPRDYNPRO-TEMPLATE' FVAL = L_BCSET_ID )
*        ).
*
*        CALL FUNCTION 'ABAP4_CALL_TRANSACTION' STARTING NEW TASK 'NONE'
*          EXPORTING
*            TCODE                   = 'SCPR20'
*            SKIP_SCREEN             = ''
*            MODE_VAL                = 'E'
*            UPDATE_VAL              = 'L'
**     IMPORTING
**           SUBRC                   =
*          TABLES
*            USING_TAB               = LT_BDCDATA
**           SPAGPA_TAB              =
**           MESS_TAB                =
*          EXCEPTIONS
*            CALL_TRANSACTION_DENIED = 1
*            TCODE_INVALID           = 2
*            OTHERS                  = 3.
      ENDIF.
    ENDIF.
  ENDMETHOD.

  METHOD ON_TAX_CODE_DLG_CLOSE.
    IF LO_DIALOG IS NOT INITIAL.
      LO_DIALOG->FREE(  ).
      CLEAR LO_DIALOG.
    ENDIF.
  ENDMETHOD.

  METHOD SHOW_TAX_CODES.
    DATA: LO_GRID_SOURCE   TYPE REF TO CL_GUI_ALV_GRID,
          LO_GRID_ORIGINAL TYPE REF TO CL_GUI_ALV_GRID,
          LO_GRID_T007A    TYPE REF TO CL_GUI_ALV_GRID,
          LO_GRID_T007S    TYPE REF TO CL_GUI_ALV_GRID,
          LO_GRID_T007V    TYPE REF TO CL_GUI_ALV_GRID,
          LS_LAYOUT        TYPE LVC_S_LAYO.

    IF LO_DIALOG IS INITIAL.
      CREATE OBJECT LO_DIALOG
        EXPORTING
*         PARENT                      = PARENT                  " Parent container
          WIDTH                       = 1500                     " Width of This Container
          HEIGHT                      = 300                      " Height of This Container
*         STYLE                       = STYLE                   " Windows Style Attributes Applied to this Container
*         REPID                       = REPID                   " Report to Which This Control is Linked
*         DYNNR                       = DYNNR                   " Screen to Which the Control is Linked
*         LIFETIME                    = LIFETIME_DEFAULT        " Lifetime
          TOP                         = 30                       " Top Position of Dialog Box
          LEFT                        = 30                       " Left Position of Dialog Box
          CAPTION                     = 'Tax code'               " Dialog Box Caption
*         NO_AUTODEF_PROGID_DYNNR     = NO_AUTODEF_PROGID_DYNNR " Don't Autodefined Progid and Dynnr?
*         METRIC                      = 0                       " Metric
*         NAME                        = NAME                    " Name
        EXCEPTIONS
          CNTL_ERROR                  = 1                       " CNTL_ERROR
          CNTL_SYSTEM_ERROR           = 2                       " CNTL_SYSTEM_ERROR
          CREATE_ERROR                = 3                       " CREATE_ERROR
          LIFETIME_ERROR              = 4                       " LIFETIME_ERROR
          LIFETIME_DYNPRO_DYNPRO_LINK = 5                       " LIFETIME_DYNPRO_DYNPRO_LINK
          EVENT_ALREADY_REGISTERED    = 6                       " Event Already Registered
          ERROR_REGIST_EVENT          = 7.                       " Error While Registering Event
      SET HANDLER ON_TAX_CODE_DLG_CLOSE FOR LO_DIALOG.

*  §1.Set status of all cells to editable using the layout structure.
      LS_LAYOUT-EDIT = 'X'.

      DATA(L_SPLITTER_MAIN) = NEW CL_GUI_SPLITTER_CONTAINER(
        PARENT  = LO_DIALOG
        ROWS    = 2
        COLUMNS = 1 ).


      LOOP AT CT_ACTION_ITEM INTO DATA(LS_ACTION_ITEM).
        LOOP AT LS_ACTION_ITEM-METHODS INTO DATA(LS_METHODS) WHERE NAME = 'CREATE_TAX_CODE'.
          APPEND INITIAL LINE TO LT_TAX_CODE_DISPLAY ASSIGNING FIELD-SYMBOL(<FS_TAX_CODE_DISPLAY>).
          <FS_TAX_CODE_DISPLAY> = LS_METHODS.
          <FS_TAX_CODE_DISPLAY>-BUTTON = 'Create'.

*          <FS_TAX_CODE_DISPLAY>-ALAND = LS_METHODS-COUNTRYCODE.
*          <FS_TAX_CODE_DISPLAY>-MWSKZ = LS_METHODS-TAXCODE.
*          <FS_TAX_CODE_DISPLAY>-KBETR = LS_METHODS-TAXRATE.
*          <FS_TAX_CODE_DISPLAY>-MWART = LS_METHODS-TAXTYPE.
*          <FS_TAX_CODE_DISPLAY>-TEXT1 = LS_METHODS-DESCRIPTION.
*          <FS_TAX_CODE_DISPLAY>-KSCHL = LS_METHODS-CONDITIONTYPE.
*          <FS_TAX_CODE_DISPLAY>-DATAM = LS_METHODS-VALIDON.
*          <FS_TAX_CODE_DISPLAY>-DATUM = LS_METHODS-VALIDEND.

          APPEND LS_METHODS-FIELD_EXTRACTION_SOURCE TO LT_TAX_CODE_ORIGINAL.
        ENDLOOP.
      ENDLOOP.

*      DATA(LT_FIELDCATALOG) = VALUE LVC_T_FCAT(
*        ( COL_POS = 01 FIELDNAME = 'BUTTON' STYLE = CL_GUI_ALV_GRID=>MC_STYLE_BUTTON KEY = ABAP_FALSE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 5 REPTEXT = 'Create' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'Create' SCRTEXT_M = 'Create' SCRTEXT_S =
*'Create' )
*        ( COL_POS = 05 FIELDNAME = 'ALAND' KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'ALAND' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'ALAND' SCRTEXT_M = 'ALAND' SCRTEXT_S = 'ALAND' )
*        ( COL_POS = 10 FIELDNAME = 'MWSKZ' KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'MWSKZ' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'MWSKZ' SCRTEXT_M = 'MWSKZ' SCRTEXT_S = 'MWSKZ' )
*        ( COL_POS = 15 FIELDNAME = 'KBETR' KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'KBETR' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'KBETR' SCRTEXT_M = 'KBETR' SCRTEXT_S = 'KBETR' )
*        ( COL_POS = 20 FIELDNAME = 'MWART' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'MWART' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'MWART' SCRTEXT_M = 'MWART' SCRTEXT_S = 'MWART' )
*        ( COL_POS = 25 FIELDNAME = 'TEXT1' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'TEXT1' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'TEXT1' SCRTEXT_M = 'TEXT1' SCRTEXT_S = 'TEXT1' )
*        ( COL_POS = 30 FIELDNAME = 'KSCHL' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'KSCHL' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'KSCHL' SCRTEXT_M = 'KSCHL' SCRTEXT_S = 'KSCHL' )
*        ( COL_POS = 35 FIELDNAME = 'DATAM' KEY = ABAP_FALSE DATATYPE = 'DATE' INTTYPE = 'D' INTLEN = 16 REPTEXT = 'DATAM' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'DATAM' SCRTEXT_M = 'DATAM' SCRTEXT_S = 'DATAM' )
*        ( COL_POS = 40 FIELDNAME = 'DATUM' KEY = ABAP_FALSE DATATYPE = 'DATE' INTTYPE = 'D' INTLEN = 16 REPTEXT = 'DATUM' DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'DATUM' SCRTEXT_M = 'DATUM' SCRTEXT_S = 'DATUM' )
*      ).


      DATA(LT_FIELDCATALOG_DISPLAY) = VALUE LVC_T_FCAT(
        ( COL_POS = 01 FIELDNAME = 'BUTTON' STYLE = CL_GUI_ALV_GRID=>MC_STYLE_BUTTON  KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 16 REPTEXT = 'Create'
          DOMNAME = '' DD_OUTLEN = 16 SCRTEXT_L = 'Create' SCRTEXT_M = 'Create' SCRTEXT_S = 'Create' )
        ( COL_POS = 10 FIELDNAME = 'COUNTRYCODE'   KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 2  REPTEXT = 'COUNTRYCODE'   DOMNAME = '' DD_OUTLEN = 2  SCRTEXT_L = 'COUNTRYCODE'   SCRTEXT_M = 'COUNTRYCODE'   SCRTEXT_S = 'CCODE'   )
        ( COL_POS = 15 FIELDNAME = 'TAXCODE'       KEY = ABAP_TRUE  DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 2  REPTEXT = 'TAXCODE'       DOMNAME = '' DD_OUTLEN = 2  SCRTEXT_L = 'TAXCODE'       SCRTEXT_M = 'TAXCODE'       SCRTEXT_S = 'TAXCODE'       )
        ( COL_POS = 20 FIELDNAME = 'TAXRATE'       KEY = ABAP_TRUE  DATATYPE = 'NUM'  INTTYPE = 'I' INTLEN = 4  REPTEXT = 'TAXRATE'       DOMNAME = '' DD_OUTLEN = 4  SCRTEXT_L = 'TAXRATE'       SCRTEXT_M = 'TAXRATE'       SCRTEXT_S = 'TAXRATE'       )
        ( COL_POS = 25 FIELDNAME = 'DESCRIPTION'   KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'DESCRIPTION'   DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'DESCRIPTION'   SCRTEXT_M = 'DESCRIPTION'   SCRTEXT_S = 'DESC'   )
        ( COL_POS = 30 FIELDNAME = 'TAXTYPE'       KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 1  REPTEXT = 'TAXTYPE'       DOMNAME = '' DD_OUTLEN = 1  SCRTEXT_L = 'TAXTYPE'       SCRTEXT_M = 'TAXTYPE'       SCRTEXT_S = 'TAXTYPE'       )
        ( COL_POS = 35 FIELDNAME = 'CONDITIONTYPE' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 4 REPTEXT = 'CONDITIONTYPE' DOMNAME = '' DD_OUTLEN = 4   SCRTEXT_L = 'CONDITIONTYPE' SCRTEXT_M = 'CONDITIONTYPE' SCRTEXT_S = 'CONDTYPE' )
        ( COL_POS = 40 FIELDNAME = 'VALIDON'       KEY = ABAP_FALSE DATATYPE = 'DATE' INTTYPE = 'D' INTLEN = 8 REPTEXT = 'VALIDON'       DOMNAME = '' DD_OUTLEN = 8   SCRTEXT_L = 'VALIDON'       SCRTEXT_M = 'VALIDON'       SCRTEXT_S = 'VALIDON'       )
        ( COL_POS = 45 FIELDNAME = 'VALIDEND'      KEY = ABAP_FALSE DATATYPE = 'DATE' INTTYPE = 'D' INTLEN = 8 REPTEXT = 'VALIDEND'      DOMNAME = '' DD_OUTLEN = 8   SCRTEXT_L = 'VALIDEND'      SCRTEXT_M = 'VALIDEND'      SCRTEXT_S = 'VALIDEND'      )
      ).
      LO_GRID_SOURCE = NEW CL_GUI_ALV_GRID( I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
                  ROW    = 1
                  COLUMN = 1 ) ).

      LO_GRID_SOURCE->SET_TABLE_FOR_FIRST_DISPLAY(
        EXPORTING
          IS_LAYOUT                     = LS_LAYOUT            " Layout
        CHANGING
          IT_OUTTAB                     = LT_TAX_CODE_DISPLAY   " Output Table
          IT_FIELDCATALOG               = LT_FIELDCATALOG_DISPLAY " Field Catalog
        EXCEPTIONS
          INVALID_PARAMETER_COMBINATION = 1                    " Wrong Parameter
          PROGRAM_ERROR                 = 2                    " Program Errors
          TOO_MANY_LINES                = 3                    " Too many Rows in Ready for Input Grid
      ).

      SET HANDLER ON_BUTTON_CLICK FOR LO_GRID_SOURCE.

      LO_GRID_ORIGINAL = NEW CL_GUI_ALV_GRID( I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
                  ROW    = 2
                  COLUMN = 1 ) ).

      DATA(LT_FIELDCATALOG_ORIGINAL) = VALUE LVC_T_FCAT(
        ( COL_POS = 05 FIELDNAME = 'COUNTRYCODE'   KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'ALAND' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'COUNTRYCODE'   SCRTEXT_M = 'COUNTRYCODE'   SCRTEXT_S = 'CCODE'   )
        ( COL_POS = 10 FIELDNAME = 'TAXCODE'       KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'MWSKZ' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'TAXCODE'       SCRTEXT_M = 'TAXCODE'       SCRTEXT_S = 'TAXCODE'       )
        ( COL_POS = 15 FIELDNAME = 'TAXRATE'       KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'KBETR' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'TAXRATE'       SCRTEXT_M = 'TAXRATE'       SCRTEXT_S = 'TAXRATE'       )
        ( COL_POS = 20 FIELDNAME = 'DESCRIPTION'   KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'TEXT1' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'DESCRIPTION'   SCRTEXT_M = 'DESCRIPTION'   SCRTEXT_S = 'DESC'   )
        ( COL_POS = 25 FIELDNAME = 'TAXTYPE'       KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'MWART' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'TAXTYPE'       SCRTEXT_M = 'TAXTYPE'       SCRTEXT_S = 'TAXTYPE'       )
        ( COL_POS = 30 FIELDNAME = 'CONDITIONTYPE' KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'KSCHL' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'CONDITIONTYPE' SCRTEXT_M = 'CONDITIONTYPE' SCRTEXT_S = 'CONDTYPE' )
        ( COL_POS = 35 FIELDNAME = 'VALIDON'       KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'DATAM' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'VALIDON'       SCRTEXT_M = 'VALIDON'       SCRTEXT_S = 'VALIDON'       )
        ( COL_POS = 40 FIELDNAME = 'VALIDEND'      KEY = ABAP_FALSE DATATYPE = 'CHAR' INTTYPE = 'C' INTLEN = 50 REPTEXT = 'DATUM' DOMNAME = '' DD_OUTLEN = 50 SCRTEXT_L = 'VALIDEND'      SCRTEXT_M = 'VALIDEND'      SCRTEXT_S = 'VALIDEND'      )
      ).
      LS_LAYOUT-EDIT = ABAP_FALSE.
      LO_GRID_ORIGINAL->SET_TABLE_FOR_FIRST_DISPLAY(
        EXPORTING
          IS_LAYOUT                     = LS_LAYOUT            " Layout
        CHANGING
          IT_OUTTAB                     = LT_TAX_CODE_ORIGINAL   " Output Table
          IT_FIELDCATALOG               = LT_FIELDCATALOG_ORIGINAL   " Field Catalog
        EXCEPTIONS
          INVALID_PARAMETER_COMBINATION = 1                    " Wrong Parameter
          PROGRAM_ERROR                 = 2                    " Program Errors
          TOO_MANY_LINES                = 3                    " Too many Rows in Ready for Input Grid
      ).

*      LO_GRID_T007A = NEW CL_GUI_ALV_GRID( I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
*                ROW    = 2
*                COLUMN = 1 ) ).
*
*      DATA: LT_T007A TYPE TABLE OF T007A.
*      LOOP AT _T_TAX_CODES INTO DATA(LS_TAXCODE).
*        APPEND LINES OF LS_TAXCODE-TBL_T007A TO LT_T007A.
*      ENDLOOP.
*
*      CALL METHOD LO_GRID_T007A->SET_TABLE_FOR_FIRST_DISPLAY
*        EXPORTING
*          I_STRUCTURE_NAME = 'T007A'
*          IS_LAYOUT        = LS_LAYOUT
*        CHANGING
*          IT_OUTTAB        = LT_T007A.
**  §2.Use SET_READY_FOR_INPUT to allow editing initially.
**     (state "editable and ready for input").
*      CALL METHOD LO_GRID_T007A->SET_READY_FOR_INPUT
*        EXPORTING
*          I_READY_FOR_INPUT = 1.
*
*      LO_GRID_T007S = NEW CL_GUI_ALV_GRID( I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
*                ROW    = 3
*                COLUMN = 1 ) ).
*
*      DATA: LT_T007S TYPE TABLE OF T007S.
*      LOOP AT _T_TAX_CODES INTO LS_TAXCODE.
*        APPEND LINES OF LS_TAXCODE-TBL_T007S TO LT_T007S.
*      ENDLOOP.
*
*      CALL METHOD LO_GRID_T007S->SET_TABLE_FOR_FIRST_DISPLAY
*        EXPORTING
*          I_STRUCTURE_NAME = 'T007S'
*          IS_LAYOUT        = LS_LAYOUT
*        CHANGING
*          IT_OUTTAB        = LT_T007S.
**  §2.Use SET_READY_FOR_INPUT to allow editing initially.
**     (state "editable and ready for input").
*      CALL METHOD LO_GRID_T007S->SET_READY_FOR_INPUT
*        EXPORTING
*          I_READY_FOR_INPUT = 1.
*
*      LO_GRID_T007V = NEW CL_GUI_ALV_GRID( I_PARENT = L_SPLITTER_MAIN->GET_CONTAINER(
*                ROW    = 4
*                COLUMN = 1 ) ).
*
*      DATA: LT_T007V TYPE TABLE OF V_T007V.
*      LOOP AT _T_TAX_CODES INTO LS_TAXCODE.
*        APPEND LINES OF LS_TAXCODE-TBL_V_T007V TO LT_T007V.
*      ENDLOOP.
*
*      CALL METHOD LO_GRID_T007V->SET_TABLE_FOR_FIRST_DISPLAY
*        EXPORTING
*          I_STRUCTURE_NAME = 'T007V'
*          IS_LAYOUT        = LS_LAYOUT
*        CHANGING
*          IT_OUTTAB        = LT_T007V.
**  §2.Use SET_READY_FOR_INPUT to allow editing initially.
**     (state "editable and ready for input").
*      CALL METHOD LO_GRID_T007V->SET_READY_FOR_INPUT
*        EXPORTING
*          I_READY_FOR_INPUT = 1.

    ENDIF.
  ENDMETHOD.

  METHOD ACTIVATE_TAX_CODES.
    TRY.
        DATA: LT_BC_FIELDS TYPE IF_BCFG_CONFIG_CONTAINER=>TY_T_FIELD_VALUES,
              LS_BC_FIELDS TYPE IF_BCFG_CONFIG_CONTAINER=>TY_S_FIELD_VALUE,
              LO_TYPEDESCR TYPE REF TO CL_ABAP_TYPEDESCR.

        FIELD-SYMBOLS: <FS_TAX_CODES> LIKE LINE OF IT_TAX_CODES,
                       <FS_TABLE>     TYPE ANY,
                       <FS_COMPONENT> LIKE LINE OF CL_ABAP_STRUCTDESCR=>COMPONENTS,
                       <FS_VALUE>     TYPE ANY,
                       <FS_REC_ID>    TYPE TYP_REC_ID_MAPPING.

        DEFINE _APPEND_BC_FIELDS.
          READ TABLE _T_REC_ID_MAPPING ASSIGNING <FS_REC_ID> WITH KEY TABLENAME = '&1'.
          LOOP AT <FS_TAX_CODES>-TBL_&1 ASSIGNING <FS_TABLE>.

            CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA(
            EXPORTING
              P_DATA      = <FS_TABLE>        " Field
              RECEIVING
              P_DESCR_REF = LO_TYPEDESCR   " Reference to description object
              ).

            LOOP AT CAST CL_ABAP_STRUCTDESCR( LO_TYPEDESCR )->COMPONENTS ASSIGNING <FS_COMPONENT>.
              CLEAR LS_BC_FIELDS.
              LS_BC_FIELDS-TABLENAME = '&1'.
              LS_BC_FIELDS-REC_ID = <FS_REC_ID>-REC_ID.
              LS_BC_FIELDS-FIELDNAME = <FS_COMPONENT>-NAME.
              LS_BC_FIELDS-LANGU = SPACE.

              ASSIGN COMPONENT <FS_COMPONENT>-NAME OF STRUCTURE <FS_TABLE> TO <FS_VALUE>.
              IF SY-SUBRC = 0.
                LS_BC_FIELDS-VALUE = <FS_VALUE>.
              ENDIF.
              INSERT LS_BC_FIELDS INTO TABLE LT_BC_FIELDS .
            ENDLOOP.
            ADD 1 TO <FS_REC_ID>-REC_ID.
          ENDLOOP.
        END-OF-DEFINITION.

        LOOP AT IT_TAX_CODES ASSIGNING <FS_TAX_CODES>.
          _APPEND_BC_FIELDS T007A.
          _APPEND_BC_FIELDS T007S.
          _APPEND_BC_FIELDS V_T007V.
        ENDLOOP.


        IF LT_BC_FIELDS IS NOT INITIAL.
          DATA(LO_BCFG_CONTAINER) = CL_BCFG_CONFIG_MANAGER=>CREATE_CONTAINER(
            IO_CONTAINER_TYPE  = CL_BCFG_ENUM_CONTAINER_TYPE=>CLASSIC
            IT_LANGUS          = VALUE #( ( SY-LANGU ) )
*           IV_RFC_DEST        =
*           IV_ADJUSTMENT      = ABAP_FALSE
*           IV_SPECIAL_MODE    =
            IT_OBJECT_MAPPINGS = VALUE #( ( OBJECTNAME = 'FTXP'    OBJECTTYPE = 'L' TABLENAME = ''        ACTIVITY = 'SIMG_CFMENUORFBFTXP' )
                                          ( OBJECTNAME = 'V_T007V' OBJECTTYPE = 'V' TABLENAME = 'V_T007V' ACTIVITY = 'SIMG_FOT_F2609' ) )
*           IO_COMMIT_MODE     = CL_BCFG_ENUM_COMMIT_MODE=>USER_COMMIT
*           IV_SUPPRESS_AIM_EXEC         = SPACE
*           IV_IGNORE_SSCUI_RESTRICTIONS =
          ).

          LO_BCFG_CONTAINER->ADD_LINES_BY_FIELDS( LT_BC_FIELDS ).

          IF LO_BCFG_CONTAINER->IS_EMPTY( ) = ABAP_FALSE.
            READ TABLE LT_BC_FIELDS INTO DATA(LS_ALAND) WITH KEY TABLENAME = 'V_T007V' FIELDNAME = 'ALAND'.
            READ TABLE LT_BC_FIELDS INTO DATA(LS_MWSKZ) WITH KEY TABLENAME = 'V_T007V' FIELDNAME = 'MWSKZ'.
            READ TABLE LT_BC_FIELDS INTO DATA(LS_TRKORR) WITH KEY TABLENAME = 'V_T007V' FIELDNAME = 'TRKORR'.
            DELETE FROM T007V WHERE TRKORR = LS_TRKORR-VALUE AND ALAND = LS_ALAND-VALUE.

            LO_BCFG_CONTAINER->SAVE( ).
            COMMIT WORK.

            E_BCSET_ID = LO_BCFG_CONTAINER->GET_ID( ).
            LO_BCFG_CONTAINER->APPLY(
              EXPORTING
                IV_TP_SYST = 'R8KK004387'    " request receiving the client-independent container contents
                IV_TP_CUST = 'R8KK010460'    " request receiving the client-specific container contents
               RECEIVING
                 RESULT     = DATA(LT_BCSET_RESULT) " detailled result of the operation with logs
            ).

            CALL FUNCTION 'EXEC_RFTAXIMP'
              EXPORTING
*               CTU            = 'X'
*               MODE           = 'N'
*               UPDATE         = 'L'
*               GROUP          = GROUP
*               USER           = USER
*               KEEP           = KEEP
*               HOLDDATE       = HOLDDATE
*               NODATA         = '/'
                I_TRKORR       = CONV T007V-TRKORR( LS_TRKORR-VALUE )
                I_ALAND        = CONV T007V-ALAND( LS_ALAND-VALUE )
*             IMPORTING
*               SUBRC          = SUBRC
*             TABLES
*               MESSTAB        = MESSTAB
                      .

*            DATA(LO_TAX_IMPORT_API) = CL_FOT_TAX_CODE_IMPORT=>CREATE(
*              EXPORTING
*                IV_READ_FINAL_BTCH_INP_STATUS = ABAP_TRUE
*                IV_USE_T007V_DATAM            = ABAP_TRUE
*                IV_WRITE_TO_APPL_LOG          = ABAP_FALSE
*            ).
*
*            CALL METHOD LO_TAX_IMPORT_API->UPLOAD_TAX_RATES_FRM_TRANSPORT
*              EXPORTING
*                IV_CALLING_APPLICATION = IF_FOT_TAX_CODE_IMPORT=>MC_APPLN-ECATT
*                IV_COUNTRY             = CONV #( LS_ALAND-VALUE )
*                IV_TRANSPORT_REQUEST   = CONV #( LS_TRKORR-VALUE )
*              IMPORTING
*                ET_RETURN              = DATA(TAX_IMPORT_RETUR).

          ENDIF.
        ENDIF.
      CATCH CX_FOT_TAX_IMPORT.
      CATCH CX_BCFG_LANGU_NOT_ALLOWED.   " the container has languages not supported by the system
      CATCH CX_BCFG_LANGU_MISSING.       " the logon language is not covered by the container
      CATCH CX_BCFG_LANGU_NOT_COMPLETE.  " some lines have only partial translations
      CATCH CX_BCFG_CONTENT_UNSUPPORTED. " raised if restrictions of container type have been violated
      CATCH CX_BCFG_OPERATION_FAILED.    " Apply failed (see message for details)
      CATCH CX_BCFG_COMMIT_MODE_UNSUPPORT.
      CATCH CX_BCFG_INVALID_MAPPING.
    ENDTRY.
  ENDMETHOD.
ENDCLASS.

CLASS LCL_ZABAP_AI_001_TEST IMPLEMENTATION.
  METHOD CLASS_SETUP.
    ENVIROMENT = CL_OSQL_TEST_ENVIRONMENT=>CREATE( I_DEPENDENCY_LIST = VALUE #( ( 'T000' ) ( 'T001' ) ) ).
  ENDMETHOD.
  METHOD CLASS_TERADOWN.
  ENDMETHOD.
  METHOD SETUP.
    CREATE OBJECT _LO_TAX_CODE_PROCESSER.
    CREATE OBJECT _JSON_OBJ_PARSER.

    LO_TALK_SHOW = NEW CL_TALK_SHOW( I_MAX_ROUND = 3 ).
    LO_HOSTER = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_01 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_02 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_03 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).

    _JSON_STR =
    `{ ` &&
    `  "ActionItems": [ ` &&
    `    { ` &&
    `      "ID": 1, ` &&
    `      "Title": "Create new tax code for LVG", ` &&
    `      "Description": "Create new tax codes in the SAP system with the new 10% sales tax rate for low value goods transactions", ` &&
    `      "ActionType": 1, ` &&
    `      "Methods": [ ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Z0", ` &&
    `          "TaxRate": 8, ` &&
    `          "Description": "8% sales tax for low value goods", ` &&
    `          "TaxType": "A", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        }, ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Z1", ` &&
    `          "TaxRate": 10, ` &&
    `          "Description": "10% sales tax for low value goods", ` &&
    `          "TaxType": "V", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        }, ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Z2", ` &&
    `          "TaxRate": 20, ` &&
    `          "Description": "2% sales tax for low value goods", ` &&
    `          "TaxType": "A", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        } ` &&
    `      ], ` &&
    `      "Comments": "With effect from January 1, 2024, Malaysia plans to impose the sales tax on low value goods (LVG) that are no more than RM500 and sold online and delivered to consumers in Malaysia via land, sea, or air.` &&
    ` The sales tax rate for LVG is 10%." ` &&
    `    }, ` &&
    `    { ` &&
    `      "ID": 2, ` &&
    `      "Title": "Create new tax code for LVG", ` &&
    `      "Description": "Create new tax codes in the SAP system with the new 10% sales tax rate for low value goods transactions", ` &&
    `      "ActionType": 1, ` &&
    `      "Methods": [ ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Y0", ` &&
    `          "TaxRate": 8, ` &&
    `          "Description": "8% sales tax for low value goods", ` &&
    `          "TaxType": "A", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        }, ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Y1", ` &&
    `          "TaxRate": 10, ` &&
    `          "Description": "10% sales tax for low value goods", ` &&
    `          "TaxType": "V", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        }, ` &&
    `        { ` &&
    `          "Name": "CREATE_TAX_CODE", ` &&
    `          "CountryCode": "MY", ` &&
    `          "TaxCode": "Y2", ` &&
    `          "TaxRate": 20, ` &&
    `          "Description": "2% sales tax for low value goods", ` &&
    `          "TaxType": "A", ` &&
    `          "ValidOn": "20240101", ` &&
    `          "ValidEnd": "99991231" ` &&
    `        } ` &&
    `      ], ` &&
    `      "Comments": "With effect from January 1, 2024, Malaysia plans to impose the sales tax on low value goods (LVG) that are no more than RM500 and sold online and delivered to consumers in Malaysia via land, sea, or air.` &&
    ` The sales tax rate for LVG is 10%." ` &&
    `    }, ` &&
    `    { ` &&
    `      "ID": 3, ` &&
    `      "Title": "Determine system impact", ` &&
    `      "Description": "Determine system impact on tax codes, tax determinations, and tax reporting, considering custom developments (z-developments)", ` &&
    `      "ActionType": 2, ` &&
    `      "Comments": "Evaluate the system impacts on tax codes, tax determinations, and the tax reporting including z-developments, if any." ` &&
    `    } ` &&
    `  ] ` &&
    `} ` .

    _JSON_STR =
    ` {` &&
    `   "ActionItems": [` &&
    `     {` &&
    `       "ID": "1",` &&
    `       "Title": "Implement new tax codes for SST transition",` &&
    `       "Description": "Create new tax codes in the SAP system for Sales and Service Tax effective from September 1, 2018, to facilitate segregation and controlled transition from the GST regime.",` &&
    `       "ActionType": 1,` &&
    `       "Methods": [` &&
    `         {` &&
    `           "Name": "CREATE_TAX_CODE",` &&
    `           "CountryCode": "MY",` &&
    `           "TaxCode": "S1",` &&
    `           "TaxRate": 10,` &&
    `           "Description": "10% sales tax on manufactured taxable goods",` &&
    `           "TaxType": "A",` &&
    `           "ValidOn": "20180901",` &&
    `           "ValidEnd": "99991231"` &&
    `         },` &&
    `         {` &&
    `           "Name": "CREATE_TAX_CODE",` &&
    `           "CountryCode": "MY",` &&
    `           "TaxCode": "S2",` &&
    `           "TaxRate": 6,` &&
    `           "Description": "6% service tax for taxable services",` &&
    `           "TaxType": "A",` &&
    `           "ValidOn": "20180901",` &&
    `           "ValidEnd": "99991231"` &&
    `         }` &&
    `       ],` &&
    `       "Comments": "Based on SAP KBA Note 2683030 released on 12.03.2024, detailing implementation of Malaysian Sales and Service Tax from September 1, 2018."` &&
    `     }` &&
    `   ]` &&
    ` }` &&
    ` ` .
    _ANSWER_STR = |```json{ _JSON_STR }```|.
    _ANSWER_STR = |{ _ANSWER_STR } /n/n { _ANSWER_STR }|.

  ENDMETHOD.
  METHOD TEARDOWN.
  ENDMETHOD.
  METHOD _01_JSON_DESERIALIZE.
    DATA: L_JSON_DATA TYPE REF TO DATA.

    /UI2/CL_JSON=>DESERIALIZE(
      EXPORTING
        JSON = _JSON_STR        " JSON string
*       jsonx            =      " JSON XString
*       pretty_name      =      " Pretty Print property names
*       assoc_arrays     =      " Deserialize associative array as tables with unique keys
*       assoc_arrays_opt =      " Optimize rendering of name value maps
*       name_mappings    =      " ABAP<->JSON Name Mapping Table
*       conversion_exits =      " Use DDIC conversion exits on deserialize of values
*       hex_as_base64    =      " Serialize hex values as base64
*       gen_optimize     =
      CHANGING
        DATA = L_JSON_DATA       " Data to serialize
    ).

    CL_ABAP_UNIT_ASSERT=>ASSERT_BOUND( ACT = L_JSON_DATA MSG = '_01_json_deserialize' ).

  ENDMETHOD.

  METHOD _02_REGULAR_EXPRESS.
    DATA: LT_JSON_DATA TYPE CL_AI_RESULT_PROCESSER=>TBL_DATA.
    CL_AI_RESULT_PROCESSER=>FIND_JSON(
      EXPORTING
        I_TEXT        = _ANSWER_STR
      IMPORTING
        ET_JSON_DATA  = LT_JSON_DATA
      RECEIVING
        IS_FOUND_JSON = DATA(LS_FOUND_JSON)
    ).
    CL_ABAP_UNIT_ASSERT=>ASSERT_TRUE( ACT = LS_FOUND_JSON MSG = '_02_regular_express' ).
  ENDMETHOD.

  METHOD _03_PROCESS_TAX_CODE.

    _LO_TAX_CODE_PROCESSER->PROCESS(
      EXPORTING
        I_TEXT   = _ANSWER_STR
      RECEIVING
        R_RESULT = DATA(R_RESULT)
    ).

    CL_ABAP_UNIT_ASSERT=>ASSERT_EQUALS(
      EXPORTING
        ACT = R_RESULT  " Data object with current value
        EXP = ABAP_TRUE      " Data object with expected type
    ).
  ENDMETHOD.

  METHOD _04_ACTIVATE_TAX_CODE.
*    CL_AI_RESULT_PROCESSER=>FIND_JSON(
*      EXPORTING
*        I_TEXT        = _ANSWER_STR
*      IMPORTING
*        E_JSON_DATA   = DATA(L_JSON_DATA)
*      RECEIVING
*        IS_FOUND_JSON = DATA(LS_FOUND_JSON)
*    ).
*
*    CL_ABAP_UNIT_ASSERT=>ASSERT_EQUALS(
*      EXPORTING
*        ACT = LS_FOUND_JSON  " Data object with current value
*        EXP = ABAP_TRUE      " Data object with expected type
*    ).
*
*    _LO_TAX_CODE_PROCESSER->EXTRACE_ACTION_ITEMS(
*      EXPORTING
*        I_JSON_DATA    = L_JSON_DATA
*      IMPORTING
*        ET_ACTION_ITEM = DATA(LT_ACTION_ITEM)
*    ).
*
*    CL_ABAP_UNIT_ASSERT=>ASSERT_NOT_INITIAL(
*      EXPORTING
*        ACT = LT_ACTION_ITEM    " Actual Data Object
*    ).
*
*    _LO_TAX_CODE_PROCESSER->CONVERT_TAX_CODES(
*      EXPORTING
*        IT_ACTION_ITEM = LT_ACTION_ITEM
*      IMPORTING
*        ET_TAX_CODES   = DATA(LS_TAX_CODES)
*    ).
*
*    DATA(L_BCSET_ID) = _LO_TAX_CODE_PROCESSER->ACTIVATE_TAX_CODES( EXPORTING IT_TAX_CODES = LS_TAX_CODES ).
*    CL_ABAP_UNIT_ASSERT=>ASSERT_NOT_INITIAL(
*      EXPORTING
*        ACT = L_BCSET_ID    " Actual Data Object
*        MSG = L_BCSET_ID
*    ).
  ENDMETHOD.

  METHOD _05_TALK_SHOW_001.
    DATA: LO_TALK_SHOW      TYPE REF TO CL_TALK_SHOW,
          LO_HOSTER         TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_01 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_02 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_03 TYPE REF TO CL_CONVERSATION.

    LO_TALK_SHOW = NEW CL_TALK_SHOW( I_MAX_ROUND = 3 ).
    LO_HOSTER = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_01 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_02 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_03 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_TALK_SHOW->SET_HOSTER( LO_HOSTER ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_01 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_02 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_03 ).

    DATA(L_FUNTION_REQ) = |现在有国家代码和编号的替换需求, 代码和国家列表如下：| &&
                          |1010 代表 DE, 1710 代表 US, | &&
                          |1110 代表 GB, 1310 代表 CN, | &&
                          |1510 代表 JP, 1610 代表 RU, | &&
                          |1810 代表 IN, 2110 代表 HU, | &&
                          |3010 代表 AU, 7D10 代表 OM, | &&
                          |9410 代表 KZ, 7510 代表 QA  | .

    LO_TALK_SHOW->SET_TOPIC( | 具体的功能是用ABAP实现灵活的替换功能. { L_FUNTION_REQ }| ).

    LO_HOSTER->SET_SYSTEM_ROLE( |你是一个经验丰富的ABAP 资深程序大师，擅长捕捉各种程序漏洞，现在你正在一个代码评审大会，检查另外3个程序员写的代码 | &&
                                |你要做的是为程序员写的代码进行评价，主要是找出问题点，并且说明清楚, 请不要做任何代码的现场演示，这是作弊行为。| &&
                                |具体的功能是用ABAP实现灵活的替换功能. { L_FUNTION_REQ }| ).

    DATA(L_P_ROLE) = |你是一个经验丰富的ABAP 资深程序大师，擅长捕捉各种程序漏洞，现在你正在一个代码评审大会上接受现成编写代码的考验， 请完成如下ABAP实现灵活的替换功能。{ L_FUNTION_REQ }|.
    LO_PARTICIPANT_01->UPDATE_NAME( '程序员: 边城浪子' ).
    LO_PARTICIPANT_01->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_02->UPDATE_NAME( '程序员: 编程巨擘' ).
    LO_PARTICIPANT_02->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_03->UPDATE_NAME( '程序员: 撸码狂魔' ).
    LO_PARTICIPANT_03->SET_SYSTEM_ROLE( L_P_ROLE ).

    LO_TALK_SHOW->START_SHOW( ).

    LO_TALK_SHOW->SAVE_TO_DB( ).


  ENDMETHOD.

  METHOD _05_TALK_SHOW_002.

    LO_TALK_SHOW->SET_HOSTER( LO_HOSTER ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_01 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_02 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_03 ).

    LO_TALK_SHOW->SET_TOPIC( | 讲一个史无前例最好笑的笑话！ | ).
    LO_TALK_SHOW->SET_MAX_ROUND( 1 ).

    LO_HOSTER->UPDATE_NAME( '脱口秀主持人： 栾莱赛' ).
    LO_HOSTER->SET_SYSTEM_ROLE( |你是一个幽默大师，了解世界上任何一个笑话，现在作为裁判，需要对别的选手说的笑话打分 ，最低 1分，最高 10分，如果看到选手说的笑话就只要显示分数， 如果是需要你主持演出，请说一些相关的话语。| ).

    LO_TALK_SHOW->SET_TOPIC( IV_TOPIC = | AI 脱口秀现在开始，请各位选手准备好自己的笑话，来笑死大家把！ | ).
    DATA(L_P_ROLE) = |你是一个搞笑天才，脱口秀达人，现在比赛讲笑话，你必须字字珠玑，口若悬河但又不能胡言乱语。|.
    LO_PARTICIPANT_01->UPDATE_NAME( '脱口秀演员: 郝会唠' ).
    LO_PARTICIPANT_01->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_02->UPDATE_NAME( '脱口秀演员: 吴优谈' ).
    LO_PARTICIPANT_02->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_03->UPDATE_NAME( '脱口秀演员: 甄会说' ).
    LO_PARTICIPANT_03->SET_SYSTEM_ROLE( L_P_ROLE ).

    LO_TALK_SHOW->START_SHOW( ).

    LO_TALK_SHOW->SAVE_TO_DB( ).


  ENDMETHOD.

  METHOD _05_TALK_SHOW_003.
    DATA: LO_TALK_SHOW      TYPE REF TO CL_TALK_SHOW,
          LO_HOSTER         TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_01 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_02 TYPE REF TO CL_CONVERSATION,
          LO_PARTICIPANT_03 TYPE REF TO CL_CONVERSATION.

    LO_TALK_SHOW = NEW CL_TALK_SHOW( I_MAX_ROUND = 3 ).
    LO_HOSTER = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_01 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_02 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_PARTICIPANT_03 = CL_CONVERSATION=>CREATE_RUNTIME( I_MODULE_ID = CL_AI_PROXY=>G_MODULE_GPT4O I_SCEN_ID = CL_AI_PROXY=>G_SCEN_ID I_PROCESSER = SPACE ).
    LO_TALK_SHOW->SET_HOSTER( LO_HOSTER ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_01 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_02 ).
    LO_TALK_SHOW->ADD_PARTICIPANT( LO_PARTICIPANT_03 ).

    DATA(L_FUNTION_REQ) = |用ABAP 写一个 tic-tac-toe 的游戏，使用蒙特卡洛算法, 并且附带详细的备注说明. |.

    LO_TALK_SHOW->SET_TOPIC( | { L_FUNTION_REQ }| ).
    DATA(L_HOST_NAME) = `代码审查： 何乐峦`.
    LO_HOSTER->UPDATE_NAME( L_HOST_NAME ).

    LO_HOSTER->SET_SYSTEM_ROLE( |你是一个经验丰富的ABAP 资深程序大师，擅长捕捉各种程序漏洞，现在你正在一个代码评审会，审查另外3个程序员写的代码。 | &&
                                |任务： 1. 检查分析提供给你的代码， 提出你自己的意见 | &&
                                | 2. 不要输出任何代码 | &&
                                | 3. 分析程序员说的内容， 被包含在三个引号中， 例如：程序员： 某某某 说：""" .... """| ).

    DATA(L_P_ROLE) = |你是一个经验丰富的ABAP 资深程序大师，熟悉各种高深的算法。 请按照代码评审人{ L_HOST_NAME }的要求完成或者修改代码，完成任务. |.
    LO_PARTICIPANT_01->UPDATE_NAME( '程序员: 贺莱莱' ).
    LO_PARTICIPANT_01->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_02->UPDATE_NAME( '程序员: 隋农农' ).
    LO_PARTICIPANT_02->SET_SYSTEM_ROLE( L_P_ROLE ).
    LO_PARTICIPANT_03->UPDATE_NAME( '程序员: 罡雪雪' ).
    LO_PARTICIPANT_03->SET_SYSTEM_ROLE( L_P_ROLE ).

    BREAK MAOZH.
    LO_TALK_SHOW->START_SHOW( ).
    LO_TALK_SHOW->SAVE_TO_DB( ).
  ENDMETHOD.


ENDCLASS.

CLASS CL_SCREEN_0100_HANDLER IMPLEMENTATION.
  METHOD FILL_INIT_QUESTION.
    DATA: L_QUESTION       TYPE STRING.
    IF I_QUESTION IS INITIAL.
      L_QUESTION = 'Say hello to AI core power by SAP!'.
    ELSE.
      L_QUESTION = I_QUESTION.
    ENDIF.

    SET_INPUT( L_QUESTION ).
  ENDMETHOD.

  METHOD GET_INPUT.
    _INPUT_EDIT->GET_TEXTSTREAM(
      EXPORTING
        ONLY_WHEN_MODIFIED     = 0            " get text only when modified
      IMPORTING
        TEXT                   = R_TEXT            " Text as String with Carriage Returns and Linefeeds
        IS_MODIFIED            = DATA(IS_MODIFIED) " modify status of text
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error while retrieving a property from TextEdit control
        NOT_SUPPORTED_BY_GUI   = 2                " Method is not supported by installed GUI
        OTHERS                 = 3
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD GET_OUTPUT.
    _OUTPUT_EDIT->GET_TEXTSTREAM(
      EXPORTING
        ONLY_WHEN_MODIFIED     = 0            " get text only when modified
      IMPORTING
        TEXT                   = R_TEXT            " Text as String with Carriage Returns and Linefeeds
        IS_MODIFIED            = DATA(IS_MODIFIED) " modify status of text
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error while retrieving a property from TextEdit control
        NOT_SUPPORTED_BY_GUI   = 2                " Method is not supported by installed GUI
        OTHERS                 = 3
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD APPEND_OUTPUT.
    DATA(L_OUTPUT) = GET_OUTPUT( ).

    IF L_OUTPUT IS INITIAL.
      L_OUTPUT = I_TEXT.
    ELSE.
      L_OUTPUT = L_OUTPUT && |\n| && I_TEXT.
    ENDIF.

    SET_OUTPUT( L_OUTPUT ).
  ENDMETHOD.

  METHOD SET_OUTPUT.
    _OUTPUT_EDIT->SET_TEXTSTREAM(
      EXPORTING
        TEXT                   = I_TEXT           " Text as String with Carriage Returns and Linefeeds
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error Calling COM Method
        NOT_SUPPORTED_BY_GUI   = 2                " Method is not supported by installed GUI
        OTHERS                 = 3
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    _OUTPUT_EDIT->GET_LINE_COUNT(
      IMPORTING
        LINES                  = DATA(L_LINES)    " total number of lines displayed by control.
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error while retrieving the total number of lines displayed
        OTHERS                 = 2
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    _OUTPUT_EDIT->GO_TO_LINE(
      EXPORTING
        LINE                   = L_LINES          " Line Number
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error while positioning to line in control!
        OTHERS                 = 2
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.


  METHOD SET_INPUT.
    _INPUT_EDIT->SET_TEXTSTREAM(
      EXPORTING
        TEXT                   = I_TEXT           " Text as String with Carriage Returns and Linefeeds
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error Calling COM Method
        NOT_SUPPORTED_BY_GUI   = 2                " Method is not supported by installed GUI
        OTHERS                 = 3
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD CLEAR_INPUT.
    _INPUT_EDIT->SET_TEXTSTREAM(
      EXPORTING
        TEXT                   = ''                 " Text as String with Carriage Returns and Linefeeds
      EXCEPTIONS
        ERROR_CNTL_CALL_METHOD = 1                " Error Calling COM Method
        NOT_SUPPORTED_BY_GUI   = 2                " Method is not supported by installed GUI
        OTHERS                 = 3
    ).
    IF SY-SUBRC <> 0.
      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
      WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD GET_INSTANCE.
    IF _SCREEN_0100_HANDLER IS INITIAL.
      CREATE OBJECT _SCREEN_0100_HANDLER.

*      if io_ai_proxy is initial.
*        _screen_0100_handler->assign_ai_proxy( new cl_ai_proxy( ) ).
*      else.
*        _screen_0100_handler->assign_ai_proxy( io_ai_proxy ).
*      endif.

*      if io_tax_code_processer is initial.
*        _screen_0100_handler->assign_tax_code_processer( new cl_tax_code_processer( ) ).
*      else.
*        _screen_0100_handler->assign_tax_code_processer( io_tax_code_processer ).
*      endif.

*      if io_conversation_manager is initial.
*        _screen_0100_handler->assign_conversation_manager( new cl_conversation_manager( new cl_ai_proxy( ) ) ).
*      else.
*        _screen_0100_handler->assign_conversation_manager( io_conversation_manager = io_conversation_manager ).
*      endif.

*      _screen_0100_handler->assign_conversation_manager( new cl_conversation_manager( new cl_ai_proxy( ) ) ).
    ENDIF.

    _SCREEN_0100_HANDLER->INIT_SCREEN_0100( ).
    RETURN _SCREEN_0100_HANDLER.
  ENDMETHOD.

  METHOD SAVE_CONVERSATION.
    ME->_CONVERSATION_MANAGER->SAVE_CONVERSTION( ).
  ENDMETHOD.

  METHOD NEW_CONVERSATION.
    CALL SELECTION-SCREEN 9800 STARTING AT 10 10.
    IF SY-SUBRC = 0.

      ME->SET_INPUT( SPACE ).
      ME->SET_OUTPUT( SPACE ).
      ME->_CONVERSATION_MANAGER->CREATE_CONVERSION(
        EXPORTING
          I_MODULE_ID   = P_MDLID
          I_SCEN_ID     = P_SCNID
          I_PROCESSER   = P_PRCNM
        RECEIVING
          RS_CONVERSION = DATA(LS_CONVERSION)
      ).
      ME->_CONVERSATION_MANAGER->APPEND_CONVERSION_TREE( ).

    ENDIF.

  ENDMETHOD.

  METHOD SHOW_CONVERSION.
    CHECK IO_CONVERSATION IS NOT INITIAL.
    ME->SET_INPUT( '' ).

    DATA(LS_CONVERSION_INFO) = IO_CONVERSATION->INFO( ).

    DATA: L_OUTPUT TYPE STRING.

    IF IO_CONVERSATION->GET_SYSTEM_ROLE( ) IS NOT INITIAL.
      L_OUTPUT = L_OUTPUT &&
      |===SYSTEM===\n| &&
      IO_CONVERSATION->GET_SYSTEM_ROLE( ) &&
      |\n|.
    ENDIF.

    LOOP AT LS_CONVERSION_INFO-CONVERSATIONMSG ASSIGNING FIELD-SYMBOL(<FS_CONVERSATIONMSG>).

      CASE <FS_CONVERSATIONMSG>-ROLE.
        WHEN AIC_MESSAGE_TYPE=>ASSISTANT_MESSAGE.
          L_OUTPUT = L_OUTPUT &&
          |===ASSISTANT===\n| &&
          <FS_CONVERSATIONMSG>-TEXT &&
          |\n|.
        WHEN AIC_MESSAGE_TYPE=>USER_MESSAGE.
          L_OUTPUT = L_OUTPUT &&
          |===USER===\n| &&
          <FS_CONVERSATIONMSG>-TEXT &&
          |\n|.
        WHEN OTHERS.
      ENDCASE.
    ENDLOOP.

    ME->SET_OUTPUT( L_OUTPUT ).

  ENDMETHOD.

  METHOD ASK_AI.

    DATA(LO_CONVERSION) = ME->_CONVERSATION_MANAGER->ASK_AI( ME->GET_INPUT( ) ).

    SHOW_CONVERSION( LO_CONVERSION ).

  ENDMETHOD.

  METHOD INIT_SCREEN_0100.
    DATA(L_DOCKING) = NEW CL_GUI_DOCKING_CONTAINER(
      SIDE      = CL_GUI_DOCKING_CONTAINER=>DOCK_AT_LEFT
      EXTENSION = 5000
    ).

    DATA(L_SPLITTER_MAIN) = NEW CL_GUI_SPLITTER_CONTAINER(
      PARENT  = L_DOCKING
      ROWS    = 1
      COLUMNS = 2 ).

    INIT_INPUT_OUTPUT( IO_CONTAINER = L_SPLITTER_MAIN->GET_CONTAINER(
    ROW    = 1
    COLUMN = 1 ) ).

    INIT_CONVERSATION_MANGER( IO_CONTAINER = L_SPLITTER_MAIN->GET_CONTAINER(
    ROW    = 1
    COLUMN = 2 ) ).

    CL_GUI_CFW=>FLUSH( ).
  ENDMETHOD.

  METHOD CONSTRUCTOR.
    ME->_CONVERSATION_MANAGER =
      NEW CL_CONVERSATION_MANAGER(
      IO_SCREEN_HANDLER = ME ).
  ENDMETHOD.                    "constructor

  METHOD INIT_CONVERSATION_MANGER.
    CHECK _CONVERSATION_MANAGER IS NOT INITIAL.
    _CONVERSATION_MANAGER->INIT_CONVERSATION_MANGER( IO_CONTAINER = IO_CONTAINER ).
    _CONVERSATION_MANAGER->LOAD_CONVERSTION( ).
    _CONVERSATION_MANAGER->APPEND_CONVERSION_TREE( ).
  ENDMETHOD.

  METHOD INIT_INPUT_OUTPUT.
    DATA(LO_SPLITTER_INPUT_OUTPUT) = NEW CL_GUI_SPLITTER_CONTAINER(
      PARENT  = IO_CONTAINER
      ROWS    = 2
      COLUMNS = 1 ).

    LO_SPLITTER_INPUT_OUTPUT->SET_BORDER(
      EXPORTING
        BORDER = CL_GUI_CFW=>FALSE ).

    LO_SPLITTER_INPUT_OUTPUT->SET_ROW_MODE(
      EXPORTING
        MODE = CL_GUI_SPLITTER_CONTAINER=>MODE_ABSOLUTE ).

    LO_SPLITTER_INPUT_OUTPUT->SET_ROW_HEIGHT(
      EXPORTING
        ID     = 1
        HEIGHT = 512 ).

    DATA(LO_CONTAINER_TOP) =
      LO_SPLITTER_INPUT_OUTPUT->GET_CONTAINER(
      ROW    = 1
      COLUMN = 1 ).

    DATA(LO_CONTAINER_BOTTOM) =
      LO_SPLITTER_INPUT_OUTPUT->GET_CONTAINER(
      ROW    = 2
      COLUMN = 1 ).

    _OUTPUT_EDIT  = NEW CL_GUI_TEXTEDIT( PARENT = LO_CONTAINER_TOP ).
    _OUTPUT_EDIT->SET_READONLY_MODE( ).
    _INPUT_EDIT  = NEW CL_GUI_TEXTEDIT( PARENT = LO_CONTAINER_BOTTOM ).

    FILL_INIT_QUESTION( ).

  ENDMETHOD.
ENDCLASS.                    "screen_handler IMPLEMENTATION

INITIALIZATION.

  CL_AI_RESULT_PROCESSER=>REGIST_SUB_PROCESSER( IS_SUB_PROCESSER = VALUE #( PROCESSER = 'CL_TAX_CODE_PROCESSER' DESCRIPT = 'Tax code assistant' ) ).
  CL_AI_RESULT_PROCESSER=>REGIST_SUB_PROCESSER( IS_SUB_PROCESSER = VALUE #( PROCESSER = 'CL_CODE_PROCESSER' DESCRIPT = 'Code assistant' ) ).
  CL_AI_RESULT_PROCESSER=>REGIST_SUB_PROCESSER( IS_SUB_PROCESSER = VALUE #( PROCESSER = 'CL_PROMPT_PROCESSER' DESCRIPT = 'Prompt assistant' ) ).
  CL_AI_RESULT_PROCESSER=>REGIST_SUB_PROCESSER( IS_SUB_PROCESSER = VALUE #( PROCESSER = 'CL_CHANGE_LIST_PROCESSER' DESCRIPT = 'Change list assistant' ) ).

START-OF-SELECTION.
  CALL SCREEN 0100.

*&---------------------------------------------------------------------*
*& Module STATUS_0100 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE STATUS_0100 OUTPUT.
  SET PF-STATUS '0100'.
  SET TITLEBAR '0100'.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_SCREEN_0100  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE EXIT_SCREEN_0100 INPUT.
  SET SCREEN 0.
  LEAVE SCREEN.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE USER_COMMAND_0100 INPUT.
  DATA: L_OKCODE TYPE SY-UCOMM.

  L_OKCODE = OK_CODE.
  CLEAR: OK_CODE.

  CASE L_OKCODE.
    WHEN G_ASK_AI.
      PERFORM EXECUTE_ASK_AI_0001.
    WHEN G_NEW_CONVERSATION.
      PERFORM EXECUTE_NEW_CONVERSATION_0001.
    WHEN G_SAVE_CONVERSATION.
      PERFORM EXECUTE_SAVE_CONVERSATION_0001.
    WHEN OTHERS.
  ENDCASE.

ENDMODULE.

FORM EXECUTE_ASK_AI_0001.
  IF GO_SCREEN_0100 IS NOT INITIAL.
    GO_SCREEN_0100->ASK_AI( ).
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Module INIT_SCREEN_0100 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE INIT_SCREEN_0100 OUTPUT.
  IF GO_SCREEN_0100 IS INITIAL.
    GO_SCREEN_0100 = CL_SCREEN_0100_HANDLER=>GET_INSTANCE( ).

  ENDIF.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Form execute_new_conversation_0001
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM EXECUTE_NEW_CONVERSATION_0001 .
  IF GO_SCREEN_0100 IS NOT INITIAL.
    GO_SCREEN_0100->NEW_CONVERSATION( ).

  ENDIF.
ENDFORM.

FORM EXECUTE_SAVE_CONVERSATION_0001.
  IF GO_SCREEN_0100 IS NOT INITIAL.
    GO_SCREEN_0100->SAVE_CONVERSATION( ).

  ENDIF.
ENDFORM.
